---
phase: 24-container-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/Dockerfile
  - docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/svc-postgresql
  - docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/svc-ollama
  - docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/svc-mcp
autonomous: true

must_haves:
  truths:
    - "Docker image builds successfully with all three services bundled"
    - "nomic-embed-text model is baked into the image (no runtime download)"
    - "s6-overlay is installed as PID 1 init system"
    - "/data directory structure exists for volume mounts"
  artifacts:
    - path: "docker/Dockerfile"
      provides: "Multi-stage Dockerfile with s6-overlay, PostgreSQL, Ollama, Python app"
      contains: "s6-overlay"
    - path: "docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/svc-postgresql"
      provides: "PostgreSQL service registration"
    - path: "docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/svc-ollama"
      provides: "Ollama service registration"
    - path: "docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/svc-mcp"
      provides: "MCP server service registration"
  key_links:
    - from: "docker/Dockerfile"
      to: "s6-overlay"
      via: "ENTRYPOINT ['/init']"
      pattern: "ENTRYPOINT.*init"
    - from: "docker/Dockerfile"
      to: "nomic-embed-text"
      via: "multi-stage build copy"
      pattern: "COPY.*ollama"
---

<objective>
Create the multi-stage Dockerfile that bundles PostgreSQL, Ollama (with pre-baked nomic-embed-text model), and the CocoSearch MCP server under s6-overlay process supervision.

Purpose: This is the foundation for the all-in-one Docker container. The Dockerfile must install all dependencies, pre-bake the embedding model, and set up s6-overlay as PID 1.

Output: docker/Dockerfile with multi-stage build, docker/rootfs/ with s6 service registration files
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-container-foundation/24-CONTEXT.md
@.planning/phases/24-container-foundation/24-RESEARCH.md
@src/cocosearch/mcp/server.py
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-stage Dockerfile with all components</name>
  <files>docker/Dockerfile</files>
  <action>
Create docker/Dockerfile with multi-stage build:

**Stage 1: Model downloader**
```dockerfile
FROM gerke74/ollama-model-loader as model-downloader
RUN /ollama-pull nomic-embed-text
```

**Stage 2: Final image**
Base: python:3.11-slim

Install in this order:
1. s6-overlay v3.2.2.0 (from GitHub releases, use TARGETARCH for multi-arch)
2. PostgreSQL 16 (from apt, includes pg_isready)
3. Ollama (from official install script or copy binary)
4. curl (for health checks)
5. CocoSearch Python app (copy src/, install with UV)

Copy model from stage 1:
```dockerfile
COPY --from=model-downloader /root/.ollama /data/ollama_models
```

Directory structure:
- /data/pg_data - PostgreSQL data (volume mount point)
- /data/ollama_models - Ollama models (pre-populated, volume overlay)
- /data/cocosearch - CocoSearch state
- /mnt/repos - Read-only codebase mount point
- /app - Application code

Environment variables (from CONTEXT.md):
```dockerfile
ENV COCOSEARCH_MCP_PORT=3000 \
    COCOSEARCH_PG_PORT=5432 \
    COCOSEARCH_OLLAMA_PORT=11434 \
    COCOSEARCH_EMBED_MODEL=nomic-embed-text \
    COCOSEARCH_MCP_TRANSPORT=streamable-http \
    COCOSEARCH_LOG_LEVEL=warn \
    OLLAMA_HOST=0.0.0.0:11434 \
    OLLAMA_MODELS=/data/ollama_models \
    PGDATA=/data/pg_data \
    COCOSEARCH_DATABASE_URL=postgresql://cocosearch:cocosearch@localhost:5432/cocosearch \
    S6_KILL_GRACETIME=10000 \
    S6_SERVICES_GRACETIME=10000
```

EXPOSE ports: 3000, 5432, 11434

Use ENTRYPOINT ["/init"] for s6-overlay.

Copy rootfs/ to / (s6 service definitions will be added in Task 2).

IMPORTANT: Do NOT use shell form for entrypoint - signals won't propagate correctly.
  </action>
  <verify>
Run: `docker build -t cocosearch-test -f docker/Dockerfile .`
Build should complete without errors.
  </verify>
  <done>
Dockerfile builds successfully, includes s6-overlay, PostgreSQL, Ollama with pre-baked model, and Python app.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create s6 service registration files</name>
  <files>
docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/svc-postgresql
docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/svc-ollama
docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/svc-mcp
docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/init-warmup
  </files>
  <action>
Create the s6-rc user bundle registration. These are EMPTY files that tell s6-overlay which services to start.

Create directory structure:
```
docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/
```

Create empty files (touch):
- svc-postgresql (registers PostgreSQL service)
- svc-ollama (registers Ollama service)
- svc-mcp (registers MCP server service)
- init-warmup (registers warmup oneshot)

These empty files in contents.d/ tell s6-rc to include these services in the user bundle. The actual service definitions (run scripts, type files, dependencies) will be created in Plan 02.

Note: Per s6-overlay v3 docs, services must be registered in user/contents.d/ to be started automatically.
  </action>
  <verify>
Files exist and are empty:
```bash
ls -la docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/
```
Should show 4 empty files.
  </verify>
  <done>
Service registration files exist in contents.d/ directory. s6-overlay will recognize these services when started.
  </done>
</task>

</tasks>

<verification>
1. `docker build -t cocosearch-test -f docker/Dockerfile .` completes successfully
2. `docker run --rm cocosearch-test ls /data` shows pg_data, ollama_models directories
3. `docker run --rm cocosearch-test ls /data/ollama_models` shows pre-baked model files
4. `docker run --rm cocosearch-test which postgres` returns path to PostgreSQL
5. `docker run --rm cocosearch-test which ollama` returns path to Ollama
6. `docker run --rm cocosearch-test python -c "import cocosearch"` succeeds
</verification>

<success_criteria>
- Dockerfile builds without errors
- Image contains PostgreSQL 16, Ollama, s6-overlay v3.2.2.0, Python app
- nomic-embed-text model is pre-baked (no runtime download needed)
- /data directory structure exists with correct subdirectories
- s6-overlay is configured as PID 1 (/init entrypoint)
- Service registration files exist in contents.d/
</success_criteria>

<output>
After completion, create `.planning/phases/24-container-foundation/24-01-SUMMARY.md`
</output>
