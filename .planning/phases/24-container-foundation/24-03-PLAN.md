---
phase: 24-container-foundation
plan: 03
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - docker/rootfs/etc/s6-overlay/scripts/health-check
  - docker/rootfs/etc/s6-overlay/scripts/ready-signal
  - docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/type
  - docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/up
  - docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/svc-mcp
  - docker/Dockerfile
autonomous: true

must_haves:
  truths:
    - "Docker HEALTHCHECK returns healthy when all services are up"
    - "COCOSEARCH_READY marker is printed to stdout when container is ready"
    - "Health endpoint at /health returns 200 when ready"
    - "Container reports healthy/unhealthy/starting states correctly"
  artifacts:
    - path: "docker/rootfs/etc/s6-overlay/scripts/health-check"
      provides: "Combined health check for all services"
      contains: "pg_isready"
    - path: "docker/rootfs/etc/s6-overlay/scripts/ready-signal"
      provides: "Ready signal script printing COCOSEARCH_READY"
      contains: "COCOSEARCH_READY"
    - path: "docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/type"
      provides: "Ready signal oneshot service"
  key_links:
    - from: "docker/Dockerfile"
      to: "health-check script"
      via: "HEALTHCHECK CMD"
      pattern: "HEALTHCHECK.*health-check"
    - from: "init-ready"
      to: "svc-mcp"
      via: "dependencies.d/svc-mcp"
      pattern: "dependencies.d/svc-mcp"
---

<objective>
Create health check infrastructure and ready signal for Docker orchestration and scripting integration.

Purpose: Users need two ways to know when the container is ready: (1) Docker HEALTHCHECK for orchestration tools, (2) COCOSEARCH_READY stdout marker for scripting. Both must only signal ready when ALL services are accepting connections.

Output: Health check script, ready signal oneshot, updated Dockerfile with HEALTHCHECK
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/24-container-foundation/24-CONTEXT.md
@.planning/phases/24-container-foundation/24-RESEARCH.md
@.planning/phases/24-container-foundation/24-01-PLAN.md
@src/cocosearch/mcp/server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create combined health check script</name>
  <files>docker/rootfs/etc/s6-overlay/scripts/health-check</files>
  <action>
Create docker/rootfs/etc/s6-overlay/scripts/health-check:

```bash
#!/bin/sh
# Combined health check - returns 0 only when ALL services are ready
# Used by Docker HEALTHCHECK

# Check PostgreSQL
if ! pg_isready -h localhost -U cocosearch -d cocosearch > /dev/null 2>&1; then
    echo "PostgreSQL not ready"
    exit 1
fi

# Check Ollama
if ! curl -sf http://localhost:${COCOSEARCH_OLLAMA_PORT:-11434}/api/tags > /dev/null 2>&1; then
    echo "Ollama not ready"
    exit 1
fi

# Check MCP server health endpoint
if ! curl -sf http://localhost:${COCOSEARCH_MCP_PORT:-3000}/health > /dev/null 2>&1; then
    echo "MCP server not ready"
    exit 1
fi

# All services ready
exit 0
```

Make script executable (chmod +x).

Note: This script is called by Docker HEALTHCHECK. It checks all three services:
1. PostgreSQL via pg_isready (connection acceptance)
2. Ollama via /api/tags endpoint
3. MCP server via /health endpoint (created in Phase 23)
  </action>
  <verify>
```bash
cat docker/rootfs/etc/s6-overlay/scripts/health-check
ls -la docker/rootfs/etc/s6-overlay/scripts/health-check  # should be executable
```
  </verify>
  <done>
Health check script exists, checks all three services, returns 0 only when all are ready.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ready signal oneshot service</name>
  <files>
docker/rootfs/etc/s6-overlay/scripts/ready-signal
docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/type
docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/up
docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/svc-mcp
docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/init-ready
  </files>
  <action>
Create ready signal script at docker/rootfs/etc/s6-overlay/scripts/ready-signal:

```bash
#!/bin/sh
# Print ready marker to stdout for scripting integration
# This runs AFTER all services are ready (depends on svc-mcp which depends on everything)

# Print service status summary
echo "=========================================="
echo "CocoSearch container ready"
echo "=========================================="
echo "PostgreSQL:  localhost:${COCOSEARCH_PG_PORT:-5432}"
echo "Ollama:      localhost:${COCOSEARCH_OLLAMA_PORT:-11434}"
echo "MCP Server:  localhost:${COCOSEARCH_MCP_PORT:-3000}"
echo "Transport:   ${COCOSEARCH_MCP_TRANSPORT:-streamable-http}"
echo "=========================================="
echo ""
echo "COCOSEARCH_READY"
echo ""
```

Make script executable.

Create oneshot service at docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/:

**type**:
```
oneshot
```

**up** (path to script):
```
/etc/s6-overlay/scripts/ready-signal
```

**dependencies.d/svc-mcp** (empty file):
This ensures ready signal only fires after MCP server is up (which depends on PostgreSQL and Ollama).

Register in user bundle at docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/init-ready:
Create empty file to register the oneshot.
  </action>
  <verify>
```bash
cat docker/rootfs/etc/s6-overlay/scripts/ready-signal
cat docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/type
cat docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/up
ls docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/
ls docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/init-ready
```
  </verify>
  <done>
Ready signal oneshot service created. Will print COCOSEARCH_READY to stdout only after all services are ready.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Docker HEALTHCHECK to Dockerfile</name>
  <files>docker/Dockerfile</files>
  <action>
Update docker/Dockerfile (created in Plan 01) to add HEALTHCHECK directive.

Add before the ENTRYPOINT line:

```dockerfile
# Health check - all services must be ready
# --start-period: Ignore failures during first 90s (startup grace period)
# --interval: Check every 30s after start period
# --timeout: Allow 10s for each check
# --retries: Mark unhealthy after 3 consecutive failures
HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 \
  CMD /etc/s6-overlay/scripts/health-check || exit 1
```

Also add STOPSIGNAL to ensure PostgreSQL gets fast shutdown signal:

```dockerfile
# Use SIGTERM for s6-overlay, which will cascade to services
# PostgreSQL finish script handles fast shutdown
STOPSIGNAL SIGTERM
```

The start-period of 90s accounts for:
- PostgreSQL init (if first run): ~10-20s
- Ollama startup: ~5-10s
- Model warmup: ~30-60s (cold start)
- MCP server startup: ~2-5s
  </action>
  <verify>
```bash
grep -A3 "HEALTHCHECK" docker/Dockerfile
grep "STOPSIGNAL" docker/Dockerfile
```
  </verify>
  <done>
Dockerfile has HEALTHCHECK with appropriate start-period for multi-service container. STOPSIGNAL ensures clean shutdown.
  </done>
</task>

</tasks>

<verification>
1. Health check script checks all three services:
   ```bash
   grep "pg_isready" docker/rootfs/etc/s6-overlay/scripts/health-check
   grep "curl.*11434" docker/rootfs/etc/s6-overlay/scripts/health-check
   grep "curl.*3000.*health" docker/rootfs/etc/s6-overlay/scripts/health-check
   ```

2. Ready signal prints COCOSEARCH_READY:
   ```bash
   grep "COCOSEARCH_READY" docker/rootfs/etc/s6-overlay/scripts/ready-signal
   ```

3. Dockerfile has HEALTHCHECK:
   ```bash
   grep "HEALTHCHECK" docker/Dockerfile
   ```

4. Build image and test health check:
   ```bash
   docker build -t cocosearch-test -f docker/Dockerfile .
   docker run -d --name cocosearch-health-test cocosearch-test
   # Wait for startup
   sleep 100
   docker inspect --format='{{.State.Health.Status}}' cocosearch-health-test
   docker logs cocosearch-health-test | grep "COCOSEARCH_READY"
   docker stop cocosearch-health-test && docker rm cocosearch-health-test
   ```
</verification>

<success_criteria>
- Health check script exists and checks PostgreSQL, Ollama, and MCP server
- Ready signal oneshot prints COCOSEARCH_READY after all services ready
- Dockerfile has HEALTHCHECK with 90s start-period
- Dockerfile has STOPSIGNAL SIGTERM
- Container logs show COCOSEARCH_READY when fully started
- `docker inspect` shows healthy status after startup
</success_criteria>

<output>
After completion, create `.planning/phases/24-container-foundation/24-03-SUMMARY.md`
</output>
