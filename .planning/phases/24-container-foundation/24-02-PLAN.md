---
phase: 24-container-foundation
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/type
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/run
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/finish
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/notification-fd
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/data/check
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-ollama/type
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-ollama/run
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-ollama/notification-fd
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-ollama/data/check
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/type
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/run
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/svc-postgresql
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/svc-ollama
  - docker/rootfs/etc/s6-overlay/s6-rc.d/init-warmup/type
  - docker/rootfs/etc/s6-overlay/s6-rc.d/init-warmup/up
  - docker/rootfs/etc/s6-overlay/s6-rc.d/init-warmup/dependencies.d/svc-ollama
  - docker/rootfs/etc/s6-overlay/scripts/warmup-ollama
autonomous: true

must_haves:
  truths:
    - "PostgreSQL starts and waits for readiness before dependent services"
    - "Ollama starts and waits for readiness before MCP server"
    - "MCP server only starts after PostgreSQL AND Ollama are ready"
    - "Ollama model is warmed up during startup for fast first request"
    - "PostgreSQL shuts down cleanly with SIGINT (fast shutdown)"
  artifacts:
    - path: "docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/run"
      provides: "PostgreSQL startup with readiness notification"
      contains: "s6-notifyoncheck"
    - path: "docker/rootfs/etc/s6-overlay/s6-rc.d/svc-ollama/run"
      provides: "Ollama startup with readiness notification"
      contains: "s6-notifyoncheck"
    - path: "docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/run"
      provides: "MCP server startup"
      contains: "cocosearch"
    - path: "docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/svc-postgresql"
      provides: "MCP depends on PostgreSQL"
    - path: "docker/rootfs/etc/s6-overlay/scripts/warmup-ollama"
      provides: "Ollama model warmup script"
      contains: "curl.*embeddings"
  key_links:
    - from: "svc-mcp"
      to: "svc-postgresql"
      via: "dependencies.d/svc-postgresql empty file"
      pattern: "dependencies.d/svc-postgresql"
    - from: "svc-mcp"
      to: "svc-ollama"
      via: "dependencies.d/svc-ollama empty file"
      pattern: "dependencies.d/svc-ollama"
    - from: "init-warmup"
      to: "svc-ollama"
      via: "dependencies.d/svc-ollama empty file"
      pattern: "dependencies.d/svc-ollama"
---

<objective>
Create s6-overlay service definitions for PostgreSQL, Ollama, and MCP server with proper dependency ordering and readiness notification.

Purpose: Services must start in correct order (PostgreSQL -> Ollama -> MCP) with readiness checks ensuring each service is actually accepting connections before dependents start. This prevents race conditions and connection failures.

Output: Complete s6-rc service definitions in docker/rootfs/etc/s6-overlay/s6-rc.d/
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/24-container-foundation/24-CONTEXT.md
@.planning/phases/24-container-foundation/24-RESEARCH.md
@.planning/phases/24-container-foundation/24-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PostgreSQL longrun service with readiness notification</name>
  <files>
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/type
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/run
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/finish
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/notification-fd
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/data/check
  </files>
  <action>
Create PostgreSQL service definition in docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/:

**type** (single line, no newline at end):
```
longrun
```

**notification-fd** (single line):
```
3
```

**run** (executable script using execlineb):
```bash
#!/command/execlineb -P
# Initialize PostgreSQL data directory if needed
foreground {
  if { s6-test ! -f /data/pg_data/PG_VERSION }
  foreground { echo "Initializing PostgreSQL data directory..." }
  su -c "initdb -D /data/pg_data" postgres
}

# Create cocosearch user and database if needed
foreground {
  if { s6-test -f /data/pg_data/PG_VERSION }
  if { s6-test ! -f /data/pg_data/.cocosearch_initialized }
  foreground { echo "Creating cocosearch database..." }
  foreground {
    su -c "pg_ctl start -D /data/pg_data -l /tmp/pg_init.log -w" postgres
  }
  foreground {
    su -c "psql -c \"CREATE USER cocosearch WITH PASSWORD 'cocosearch';\"" postgres
  }
  foreground {
    su -c "psql -c \"CREATE DATABASE cocosearch OWNER cocosearch;\"" postgres
  }
  foreground {
    su -c "psql -d cocosearch -c \"CREATE EXTENSION IF NOT EXISTS vector;\"" postgres
  }
  foreground {
    su -c "pg_ctl stop -D /data/pg_data -m fast" postgres
  }
  touch /data/pg_data/.cocosearch_initialized
}

# Start PostgreSQL with readiness notification
s6-notifyoncheck -d -n 60 -s 1000 -w 5000 -c /etc/s6-overlay/s6-rc.d/svc-postgresql/data/check
exec su -c "postgres -D /data/pg_data" postgres
```

Note: The execlineb syntax above is pseudocode. Actual implementation should use proper execlineb or a shell wrapper. Since execlineb is complex, use a simpler shell approach:

**run** (executable shell script - PREFERRED approach):
```bash
#!/bin/sh
set -e

# Initialize PostgreSQL data directory if needed
if [ ! -f /data/pg_data/PG_VERSION ]; then
    echo "Initializing PostgreSQL data directory..."
    chown -R postgres:postgres /data/pg_data
    su postgres -c "initdb -D /data/pg_data"
fi

# Create cocosearch user and database if needed
if [ -f /data/pg_data/PG_VERSION ] && [ ! -f /data/pg_data/.cocosearch_initialized ]; then
    echo "Creating cocosearch database..."
    su postgres -c "pg_ctl start -D /data/pg_data -l /tmp/pg_init.log -w"
    su postgres -c "psql -c \"CREATE USER cocosearch WITH PASSWORD 'cocosearch';\"" || true
    su postgres -c "psql -c \"CREATE DATABASE cocosearch OWNER cocosearch;\"" || true
    su postgres -c "psql -d cocosearch -c \"CREATE EXTENSION IF NOT EXISTS vector;\"" || true
    su postgres -c "pg_ctl stop -D /data/pg_data -m fast"
    touch /data/pg_data/.cocosearch_initialized
fi

echo "Starting PostgreSQL..."
# Use s6-notifyoncheck for readiness notification
exec s6-notifyoncheck -d -n 60 -s 1000 -w 5000 \
    -c /etc/s6-overlay/s6-rc.d/svc-postgresql/data/check \
    su postgres -c "postgres -D /data/pg_data"
```

**finish** (executable, handles shutdown - use SIGINT for fast shutdown):
```bash
#!/bin/sh
echo "Stopping PostgreSQL gracefully..."
su postgres -c "pg_ctl stop -D /data/pg_data -m fast" || true
```

**data/check** (executable, readiness check):
```bash
#!/bin/sh
exec pg_isready -h localhost -U postgres
```

Make all scripts executable (chmod +x).
  </action>
  <verify>
Files exist with correct content:
```bash
cat docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/type  # should be "longrun"
cat docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/notification-fd  # should be "3"
head -5 docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/run
head -5 docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/data/check
ls -la docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/  # all should be executable
```
  </verify>
  <done>
PostgreSQL service definition complete with initialization logic, readiness notification via pg_isready, and fast shutdown via SIGINT.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Ollama longrun service with readiness notification and warmup oneshot</name>
  <files>
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-ollama/type
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-ollama/run
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-ollama/notification-fd
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-ollama/data/check
docker/rootfs/etc/s6-overlay/s6-rc.d/init-warmup/type
docker/rootfs/etc/s6-overlay/s6-rc.d/init-warmup/up
docker/rootfs/etc/s6-overlay/s6-rc.d/init-warmup/dependencies.d/svc-ollama
docker/rootfs/etc/s6-overlay/scripts/warmup-ollama
  </files>
  <action>
Create Ollama service definition in docker/rootfs/etc/s6-overlay/s6-rc.d/svc-ollama/:

**type**:
```
longrun
```

**notification-fd**:
```
3
```

**run** (executable):
```bash
#!/bin/sh
echo "Starting Ollama..."

# Ensure model directory exists and has correct permissions
mkdir -p /data/ollama_models

# Auto-pull model if not present (supports override via COCOSEARCH_EMBED_MODEL)
MODEL="${COCOSEARCH_EMBED_MODEL:-nomic-embed-text}"

# Start Ollama with readiness notification
# -n 120: max 120 attempts, -s 2000: 2s between checks, -w 10000: 10s timeout per check
exec s6-notifyoncheck -d -n 120 -s 2000 -w 10000 \
    -c /etc/s6-overlay/s6-rc.d/svc-ollama/data/check \
    ollama serve
```

**data/check** (executable):
```bash
#!/bin/sh
# Check if Ollama API is responding
curl -sf http://localhost:11434/api/tags > /dev/null 2>&1
```

Create warmup oneshot in docker/rootfs/etc/s6-overlay/s6-rc.d/init-warmup/:

**type**:
```
oneshot
```

**up** (path to script, not the script itself):
```
/etc/s6-overlay/scripts/warmup-ollama
```

**dependencies.d/svc-ollama** (empty file - creates dependency):
Create empty file to ensure warmup runs after Ollama is ready.

Create warmup script in docker/rootfs/etc/s6-overlay/scripts/warmup-ollama:

**warmup-ollama** (executable):
```bash
#!/bin/sh
# Preload embedding model into memory with a warmup request
MODEL="${COCOSEARCH_EMBED_MODEL:-nomic-embed-text}"

echo "Warming up Ollama model: $MODEL"

# Retry logic for warmup
MAX_RETRIES=3
RETRY=0

while [ $RETRY -lt $MAX_RETRIES ]; do
    if curl -sf http://localhost:11434/api/embeddings \
        -d "{\"model\": \"$MODEL\", \"prompt\": \"warmup\"}" > /dev/null 2>&1; then
        echo "Ollama model warm-up complete"
        exit 0
    fi
    RETRY=$((RETRY + 1))
    echo "Warmup attempt $RETRY failed, retrying..."
    sleep 2
done

echo "Warning: Ollama warmup failed after $MAX_RETRIES attempts"
# Don't fail - model will be loaded on first real request
exit 0
```

Make all scripts executable.
  </action>
  <verify>
```bash
cat docker/rootfs/etc/s6-overlay/s6-rc.d/svc-ollama/type
cat docker/rootfs/etc/s6-overlay/s6-rc.d/init-warmup/type
cat docker/rootfs/etc/s6-overlay/s6-rc.d/init-warmup/up
ls docker/rootfs/etc/s6-overlay/s6-rc.d/init-warmup/dependencies.d/
cat docker/rootfs/etc/s6-overlay/scripts/warmup-ollama
```
  </verify>
  <done>
Ollama service definition complete with readiness notification. Warmup oneshot runs after Ollama is ready to preload model into memory.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create MCP server longrun service with dependencies</name>
  <files>
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/type
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/run
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/svc-postgresql
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/svc-ollama
docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/init-warmup
  </files>
  <action>
Create MCP server service definition in docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/:

**type**:
```
longrun
```

**run** (executable):
```bash
#!/bin/sh
echo "Starting CocoSearch MCP server..."

# Wait a moment for database connections to stabilize
sleep 1

# Resolve configuration from environment
TRANSPORT="${COCOSEARCH_MCP_TRANSPORT:-streamable-http}"
PORT="${COCOSEARCH_MCP_PORT:-3000}"

echo "Transport: $TRANSPORT, Port: $PORT"

# Start the MCP server
# Use exec to replace shell with python process for proper signal handling
exec python -m cocosearch mcp --transport "$TRANSPORT" --port "$PORT"
```

**dependencies.d/** - Create empty files to declare dependencies:
- svc-postgresql (MCP needs database)
- svc-ollama (MCP needs embeddings)
- init-warmup (ensure model is warm before accepting requests)

These empty files tell s6-rc that svc-mcp depends on these services being ready.

Make run script executable.
  </action>
  <verify>
```bash
cat docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/type
cat docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/run
ls docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/
```
Should show: svc-postgresql, svc-ollama, init-warmup
  </verify>
  <done>
MCP server service definition complete with dependencies on PostgreSQL, Ollama, and warmup. Service will only start after all dependencies are ready.
  </done>
</task>

</tasks>

<verification>
1. All service directories exist with correct structure:
   - `ls -la docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/`
   - `ls -la docker/rootfs/etc/s6-overlay/s6-rc.d/svc-ollama/`
   - `ls -la docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/`
   - `ls -la docker/rootfs/etc/s6-overlay/s6-rc.d/init-warmup/`

2. Dependency chain is correct:
   - svc-mcp depends on svc-postgresql, svc-ollama, init-warmup
   - init-warmup depends on svc-ollama

3. All executable scripts have correct permissions

4. Rebuild Docker image with: `docker build -t cocosearch-test -f docker/Dockerfile .`
</verification>

<success_criteria>
- PostgreSQL service has run, finish, notification-fd, and data/check
- Ollama service has run, notification-fd, and data/check
- MCP service has run and dependencies.d/ with three dependency files
- Warmup oneshot has type, up, and dependencies.d/svc-ollama
- All scripts are executable
- Docker image builds with all service definitions
</success_criteria>

<output>
After completion, create `.planning/phases/24-container-foundation/24-02-SUMMARY.md`
</output>
