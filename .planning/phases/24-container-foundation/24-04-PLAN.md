---
phase: 24-container-foundation
plan: 04
type: execute
wave: 3
depends_on: ["24-02", "24-03"]
files_modified:
  - docker/.dockerignore
autonomous: false

must_haves:
  truths:
    - "User can start entire stack with single docker run cocosearch command"
    - "Container starts services in correct order (PostgreSQL ready before MCP)"
    - "User can mount local codebase via -v /path/to/code:/mnt/repos:ro"
    - "User can persist data across container restarts via -v cocosearch-data:/data"
    - "Container shuts down cleanly on docker stop without data corruption"
  artifacts:
    - path: "docker/.dockerignore"
      provides: "Ignore patterns for Docker build context"
  key_links:
    - from: "docker run"
      to: "all services"
      via: "s6-overlay dependency chain"
      pattern: "COCOSEARCH_READY"
---

<objective>
Verify end-to-end container functionality and create .dockerignore for optimal build context.

Purpose: This plan validates all phase success criteria work together: single docker run command, correct service ordering, volume mounts, data persistence, and graceful shutdown.

Output: docker/.dockerignore file, verified working container
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/24-container-foundation/24-CONTEXT.md
@.planning/phases/24-container-foundation/24-01-PLAN.md
@.planning/phases/24-container-foundation/24-02-PLAN.md
@.planning/phases/24-container-foundation/24-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .dockerignore for efficient builds</name>
  <files>docker/.dockerignore</files>
  <action>
Create docker/.dockerignore to exclude unnecessary files from build context:

```
# Git
.git
.gitignore

# Planning docs
.planning

# Python artifacts
__pycache__
*.pyc
*.pyo
*.egg-info
.eggs
dist
build
*.egg

# Virtual environments
.venv
venv
.env

# IDE
.idea
.vscode
*.swp
*.swo

# Tests
tests
.pytest_cache
.coverage
htmlcov

# Documentation
docs
*.md
!README.md

# Local development
.claude
docker-compose.yml
dev-setup.sh
cocosearch.yaml

# OS files
.DS_Store
Thumbs.db
```

This reduces build context size significantly, speeding up builds.
  </action>
  <verify>
```bash
cat docker/.dockerignore
wc -l docker/.dockerignore  # should have ~35 lines
```
  </verify>
  <done>
.dockerignore created to exclude development artifacts from build context.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build and test container startup</name>
  <files></files>
  <action>
Build the Docker image and verify basic startup:

```bash
# Build the image
docker build -t cocosearch:test -f docker/Dockerfile .

# Start container with volume mounts
docker run -d \
  --name cocosearch-e2e-test \
  -p 3000:3000 \
  -p 5432:5432 \
  -p 11434:11434 \
  -v cocosearch-test-data:/data \
  -v "$(pwd)/src:/mnt/repos:ro" \
  cocosearch:test

# Wait for startup (watch logs)
echo "Waiting for container startup..."
timeout 120 sh -c 'until docker logs cocosearch-e2e-test 2>&1 | grep -q "COCOSEARCH_READY"; do sleep 5; echo "Still starting..."; done'

# Verify all services are accessible
echo "Testing PostgreSQL..."
docker exec cocosearch-e2e-test pg_isready -h localhost -U cocosearch -d cocosearch

echo "Testing Ollama..."
docker exec cocosearch-e2e-test curl -sf http://localhost:11434/api/tags

echo "Testing MCP health..."
curl -sf http://localhost:3000/health
```

If any test fails, check logs with:
```bash
docker logs cocosearch-e2e-test
```
  </action>
  <verify>
All three service checks should pass:
- pg_isready returns 0
- Ollama /api/tags returns JSON
- MCP /health returns {"status": "ok"}
  </verify>
  <done>
Container starts successfully with all three services running and accessible.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test graceful shutdown and data persistence</name>
  <files></files>
  <action>
Test graceful shutdown and data persistence:

```bash
# Test indexing (creates data that should persist)
echo "Testing index command..."
docker exec cocosearch-e2e-test python -m cocosearch index /mnt/repos -n test-index

# Verify index exists
docker exec cocosearch-e2e-test python -m cocosearch list --pretty

# Stop container gracefully
echo "Stopping container..."
docker stop cocosearch-e2e-test

# Check logs for clean shutdown (no errors/corruption messages)
docker logs cocosearch-e2e-test 2>&1 | tail -20

# Start container again with same volume
echo "Restarting container..."
docker start cocosearch-e2e-test

# Wait for startup
timeout 120 sh -c 'until docker logs cocosearch-e2e-test 2>&1 | grep -q "COCOSEARCH_READY"; do sleep 5; done'

# Verify data persisted
echo "Verifying data persistence..."
docker exec cocosearch-e2e-test python -m cocosearch list --pretty
# Should show test-index

# Clean up
docker stop cocosearch-e2e-test
docker rm cocosearch-e2e-test
docker volume rm cocosearch-test-data
```
  </action>
  <verify>
- `docker stop` completes without timeout
- No "database system was not properly shut down" errors on restart
- Index data persists across restart (test-index still exists)
  </verify>
  <done>
Container shuts down gracefully and data persists across restarts.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>All-in-one Docker container with PostgreSQL, Ollama, and MCP server</what-built>
  <how-to-verify>
Run the following to test the complete container:

1. **Build the image:**
   ```bash
   docker build -t cocosearch:latest -f docker/Dockerfile .
   ```

2. **Start with volume mounts:**
   ```bash
   docker run -d \
     --name cocosearch-verify \
     -p 3000:3000 \
     -p 5432:5432 \
     -p 11434:11434 \
     -v cocosearch-verify-data:/data \
     -v "$(pwd):/mnt/repos:ro" \
     cocosearch:latest
   ```

3. **Wait for COCOSEARCH_READY:**
   ```bash
   docker logs -f cocosearch-verify
   ```
   Wait until you see "COCOSEARCH_READY" in output.

4. **Test MCP health endpoint:**
   ```bash
   curl http://localhost:3000/health
   ```
   Expected: `{"status":"ok"}`

5. **Test indexing:**
   ```bash
   docker exec cocosearch-verify python -m cocosearch index /mnt/repos -n verify-test
   docker exec cocosearch-verify python -m cocosearch list --pretty
   ```
   Expected: verify-test index appears in list

6. **Test search:**
   ```bash
   docker exec cocosearch-verify python -m cocosearch search "MCP server" -n verify-test --pretty
   ```
   Expected: Results from the mounted codebase

7. **Test graceful shutdown:**
   ```bash
   docker stop cocosearch-verify
   docker logs cocosearch-verify 2>&1 | tail -10
   ```
   Expected: Clean shutdown, no corruption warnings

8. **Test data persistence:**
   ```bash
   docker start cocosearch-verify
   # Wait for COCOSEARCH_READY
   docker logs -f cocosearch-verify
   docker exec cocosearch-verify python -m cocosearch list --pretty
   ```
   Expected: verify-test index still exists

9. **Clean up:**
   ```bash
   docker stop cocosearch-verify
   docker rm cocosearch-verify
   docker volume rm cocosearch-verify-data
   ```

**Phase Success Criteria Checklist:**
- [ ] Single `docker run cocosearch` starts entire stack
- [ ] Services start in correct order (PostgreSQL before MCP)
- [ ] Volume mount works (`-v /path/to/code:/mnt/repos:ro`)
- [ ] Data persists across restarts (`-v cocosearch-data:/data`)
- [ ] Clean shutdown on `docker stop` (no data corruption)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 24 success criteria from ROADMAP:
1. User can start entire stack with single `docker run cocosearch` command - VERIFY
2. Container starts services in correct order (PostgreSQL ready before MCP) - VERIFY via logs
3. User can mount local codebase via `-v /path/to/code:/mnt/repos:ro` - VERIFY
4. User can persist data across container restarts via `-v cocosearch-data:/data` - VERIFY
5. Container shuts down cleanly on `docker stop` without data corruption - VERIFY
</verification>

<success_criteria>
- .dockerignore excludes development artifacts
- Docker image builds successfully
- Container starts with all services
- COCOSEARCH_READY appears in logs
- Health endpoint returns 200
- Indexing and search work
- Graceful shutdown works
- Data persists across restarts
- User confirms all phase success criteria met
</success_criteria>

<output>
After completion, create `.planning/phases/24-container-foundation/24-04-SUMMARY.md`
</output>
