---
phase: 29-symbol-aware-indexing
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/cocosearch/indexer/flow.py
  - src/cocosearch/indexer/schema_migration.py
  - tests/unit/indexer/test_flow.py
autonomous: true

must_haves:
  truths:
    - "Indexing flow collects symbol_type, symbol_name, symbol_signature fields"
    - "Symbol columns are added to database during schema migration"
    - "Schema migration is idempotent (safe to run multiple times)"
    - "Python files have symbol metadata extracted during indexing"
  artifacts:
    - path: "src/cocosearch/indexer/flow.py"
      provides: "Symbol extraction integration"
      contains: "symbol_metadata"
    - path: "src/cocosearch/indexer/schema_migration.py"
      provides: "Symbol columns migration"
      contains: "symbol_type"
  key_links:
    - from: "src/cocosearch/indexer/flow.py"
      to: "src/cocosearch/indexer/symbols.py"
      via: "extract_symbol_metadata import"
      pattern: "from cocosearch.indexer.symbols import"
    - from: "src/cocosearch/indexer/schema_migration.py"
      to: "PostgreSQL"
      via: "ALTER TABLE ADD COLUMN"
      pattern: "ALTER TABLE.*symbol_type"
---

<objective>
Integrate symbol extraction into the CocoIndex indexing flow and create schema migration for symbol columns.

Purpose: Connect the symbol extraction module (from Plan 01) to the indexing pipeline so that Python functions and classes are automatically extracted and stored during indexing.

Output: Updated flow.py that extracts symbol metadata, and schema_migration.py that adds nullable symbol columns to existing tables.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 29 context and research
@.planning/phases/29-symbol-aware-indexing/29-CONTEXT.md
@.planning/phases/29-symbol-aware-indexing/29-RESEARCH.md

# Plan 01 summary (symbol extraction module)
@.planning/phases/29-symbol-aware-indexing/29-01-SUMMARY.md

# Files to modify
@src/cocosearch/indexer/flow.py
@src/cocosearch/indexer/schema_migration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate symbol extraction into indexing flow</name>
  <files>src/cocosearch/indexer/flow.py</files>
  <action>
Update `src/cocosearch/indexer/flow.py` to extract symbol metadata during indexing.

Changes required:

1. Import the symbol extraction function:
```python
from cocosearch.indexer.symbols import extract_symbol_metadata
```

2. In the chunk processing loop (inside `with file["chunks"].row() as chunk:`), add symbol extraction AFTER existing metadata extraction:
```python
# Extract symbol metadata (function/class/method info)
chunk["symbol_metadata"] = chunk["text"].transform(
    extract_symbol_metadata,
    language=file["extension"],
)
```

3. Update `code_embeddings.collect()` to include symbol fields:
```python
code_embeddings.collect(
    # ... existing fields ...
    symbol_type=chunk["symbol_metadata"]["symbol_type"],
    symbol_name=chunk["symbol_metadata"]["symbol_name"],
    symbol_signature=chunk["symbol_metadata"]["symbol_signature"],
)
```

The symbol fields will be NULL for non-Python files and for Python chunks that don't contain symbol definitions (e.g., import statements, comments).
  </action>
  <verify>
Run: `uv run python -c "from cocosearch.indexer.flow import create_code_index_flow; print('flow import OK')"`
Should succeed without errors.
  </verify>
  <done>Indexing flow extracts and stores symbol metadata for each chunk</done>
</task>

<task type="auto">
  <name>Task 2: Add symbol columns to schema migration</name>
  <files>src/cocosearch/indexer/schema_migration.py</files>
  <action>
Update `src/cocosearch/indexer/schema_migration.py` to add symbol columns.

Add a new function `ensure_symbol_columns()` following the pattern of existing `ensure_hybrid_search_schema()`:

```python
def ensure_symbol_columns(conn: psycopg.Connection, table_name: str) -> dict[str, Any]:
    """Ensure symbol metadata columns exist on a table.

    This is idempotent - safe to call multiple times.
    Adds nullable TEXT columns (no default value) for backward compatibility.

    Args:
        conn: PostgreSQL connection
        table_name: Name of the chunks table (e.g., "myindex_chunks")

    Returns:
        Dict with migration results:
        - columns_added: list of column names added
        - already_exists: bool if all columns existed
    """
    results = {
        "columns_added": [],
        "already_exists": False,
    }

    symbol_columns = ["symbol_type", "symbol_name", "symbol_signature"]

    with conn.cursor() as cur:
        # Check which columns exist
        cur.execute("""
            SELECT column_name
            FROM information_schema.columns
            WHERE table_name = %s AND column_name = ANY(%s)
        """, (table_name, symbol_columns))
        existing = {row[0] for row in cur.fetchall()}

        if len(existing) == len(symbol_columns):
            results["already_exists"] = True
            logger.info(f"Symbol columns already exist for {table_name}")
            return results

        # Add missing columns as TEXT NULL
        for col in symbol_columns:
            if col not in existing:
                logger.info(f"Adding {col} column to {table_name}")
                cur.execute(f"ALTER TABLE {table_name} ADD COLUMN {col} TEXT NULL")
                results["columns_added"].append(col)

        conn.commit()

    logger.info(f"Symbol schema migration complete for {table_name}: {results}")
    return results
```

Also add a `verify_symbol_columns()` function for verification:

```python
def verify_symbol_columns(conn: psycopg.Connection, table_name: str) -> bool:
    """Verify symbol columns exist on a table.

    Args:
        conn: PostgreSQL connection
        table_name: Name of the chunks table

    Returns:
        True if all symbol columns exist
    """
    with conn.cursor() as cur:
        cur.execute("""
            SELECT column_name
            FROM information_schema.columns
            WHERE table_name = %s AND column_name IN ('symbol_type', 'symbol_name', 'symbol_signature')
        """, (table_name,))
        existing = {row[0] for row in cur.fetchall()}
        return len(existing) == 3
```

Note: These columns are added as nullable TEXT with no default. This allows:
1. Fast ALTER TABLE (no table rewrite)
2. Backward compatibility (pre-v1.7 indexes have NULL values)
3. CocoIndex to write NULL for non-symbol chunks
  </action>
  <verify>
Run: `uv run python -c "from cocosearch.indexer.schema_migration import ensure_symbol_columns, verify_symbol_columns; print('schema migration OK')"`
Should succeed without errors.
  </verify>
  <done>Schema migration functions created for symbol columns</done>
</task>

<task type="auto">
  <name>Task 3: Update flow unit tests</name>
  <files>tests/unit/indexer/test_flow.py</files>
  <action>
Update `tests/unit/indexer/test_flow.py` to verify symbol extraction integration.

Add new test cases:

1. **Test symbol fields in collector:**
   - Mock the flow and verify that `code_embeddings.collect()` is called with symbol_type, symbol_name, symbol_signature fields
   - Use existing mock patterns from test_flow.py

2. **Test symbol extraction called:**
   - Verify that `extract_symbol_metadata` is called for each chunk
   - Mock the function and verify it receives chunk text and language

3. **Test non-Python files:**
   - Verify that non-Python files (e.g., .js, .md) have NULL symbol fields
   - Symbol extraction should still be called but return NULL

Add to existing test file, following the established patterns. Use @pytest.mark.unit decorator.
  </action>
  <verify>
Run: `uv run pytest tests/unit/indexer/test_flow.py -v -k symbol`
Symbol-related tests should pass.
  </verify>
  <done>Flow unit tests verify symbol extraction integration</done>
</task>

</tasks>

<verification>
1. Flow imports: `uv run python -c "from cocosearch.indexer.flow import create_code_index_flow"`
2. Schema migration imports: `uv run python -c "from cocosearch.indexer.schema_migration import ensure_symbol_columns"`
3. Unit tests: `uv run pytest tests/unit/indexer/test_flow.py -v`
</verification>

<success_criteria>
- flow.py extracts symbol metadata using extract_symbol_metadata transform
- flow.py collects symbol_type, symbol_name, symbol_signature fields
- schema_migration.py has ensure_symbol_columns() function
- Schema migration is idempotent (can run multiple times safely)
- Symbol columns are nullable TEXT (no defaults)
- Flow unit tests pass including new symbol tests
</success_criteria>

<output>
After completion, create `.planning/phases/29-symbol-aware-indexing/29-02-SUMMARY.md`
</output>
