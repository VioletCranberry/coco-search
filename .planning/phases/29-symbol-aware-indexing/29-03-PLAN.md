---
phase: 29-symbol-aware-indexing
plan: 03
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/cocosearch/search/db.py
  - tests/unit/search/test_db.py
autonomous: true

must_haves:
  truths:
    - "Pre-v1.7 indexes work without symbol columns (graceful degradation)"
    - "check_symbol_columns_exist() returns False for pre-v1.7 indexes"
    - "check_symbol_columns_exist() returns True for v1.7+ indexes"
    - "Module-level flag prevents repeated column checks"
  artifacts:
    - path: "src/cocosearch/search/db.py"
      provides: "Symbol column checks"
      exports: ["check_symbol_columns_exist"]
    - path: "tests/unit/search/test_db.py"
      provides: "Unit tests for symbol column checks"
      contains: "test_check_symbol_columns"
  key_links:
    - from: "src/cocosearch/search/db.py"
      to: "information_schema.columns"
      via: "SQL query"
      pattern: "symbol_type.*symbol_name.*symbol_signature"
---

<objective>
Add graceful degradation support for symbol columns so that pre-v1.7 indexes continue to work without errors.

Purpose: Ensure backward compatibility per SYMB-10 requirement. Pre-v1.7 indexes lack symbol_type, symbol_name, symbol_signature columns. Search operations must detect this and disable symbol filtering rather than crashing.

Output: Updated db.py with symbol column existence checks, following the same pattern used for hybrid search columns.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 29 context and research
@.planning/phases/29-symbol-aware-indexing/29-CONTEXT.md
@.planning/phases/29-symbol-aware-indexing/29-RESEARCH.md

# Existing column check pattern
@src/cocosearch/search/db.py
@tests/unit/search/test_db.py

# Hybrid search graceful degradation (prior art)
@.planning/phases/27-hybrid-search-foundation/27-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add symbol column existence check</name>
  <files>src/cocosearch/search/db.py</files>
  <action>
Update `src/cocosearch/search/db.py` to add symbol column checking functionality.

Add a module-level cache for symbol column availability (similar to existing pattern for hybrid search):

```python
# Module-level cache for symbol column availability per table
_symbol_columns_available: dict[str, bool] = {}
```

Add a function to check if symbol columns exist:

```python
def check_symbol_columns_exist(table_name: str) -> bool:
    """Check if symbol columns exist in a table.

    Uses module-level caching to avoid repeated database queries.
    Pre-v1.7 indexes lack symbol columns; this enables graceful degradation.

    Args:
        table_name: Full table name (e.g., "codeindex_myproject__myproject_chunks")

    Returns:
        True if all symbol columns (symbol_type, symbol_name, symbol_signature) exist.
    """
    # Check cache first
    if table_name in _symbol_columns_available:
        return _symbol_columns_available[table_name]

    # Query database
    result = _check_all_symbol_columns(table_name)
    _symbol_columns_available[table_name] = result

    if not result:
        logger.info(f"Index {table_name} lacks symbol columns (pre-v1.7)")

    return result


def _check_all_symbol_columns(table_name: str) -> bool:
    """Internal: Check if all three symbol columns exist."""
    required_columns = {"symbol_type", "symbol_name", "symbol_signature"}
    existing = set()

    pool = get_connection_pool()
    with pool.connection() as conn:
        with conn.cursor() as cur:
            cur.execute(
                """
                SELECT column_name FROM information_schema.columns
                WHERE table_name = %s AND column_name = ANY(%s)
                """,
                (table_name, list(required_columns)),
            )
            existing = {row[0] for row in cur.fetchall()}

    return existing == required_columns
```

Add a function to reset the cache (for testing):

```python
def reset_symbol_columns_cache() -> None:
    """Reset the symbol columns availability cache.

    Used by tests to ensure clean state between test runs.
    """
    global _symbol_columns_available
    _symbol_columns_available = {}
```

This follows the same pattern established in Phase 27 for hybrid search column checks.
  </action>
  <verify>
Run: `uv run python -c "from cocosearch.search.db import check_symbol_columns_exist, reset_symbol_columns_cache; print('db imports OK')"`
Should succeed without errors.
  </verify>
  <done>Symbol column existence check functions added to db.py</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for symbol column checks</name>
  <files>tests/unit/search/test_db.py</files>
  <action>
Update `tests/unit/search/test_db.py` to add tests for symbol column checking.

Add test cases:

1. **test_check_symbol_columns_exist_all_present:**
   - Mock database query to return all three columns
   - Assert function returns True

2. **test_check_symbol_columns_exist_missing:**
   - Mock database query to return empty result (pre-v1.7 index)
   - Assert function returns False

3. **test_check_symbol_columns_exist_partial:**
   - Mock database query to return only some columns
   - Assert function returns False (need all three)

4. **test_check_symbol_columns_exist_cached:**
   - Call function twice for same table
   - Assert database is only queried once (caching works)
   - Use reset_symbol_columns_cache() in test setup

5. **test_reset_symbol_columns_cache:**
   - Populate cache with a result
   - Call reset_symbol_columns_cache()
   - Verify cache is cleared

Use pytest fixtures to mock the connection pool. Follow existing patterns in test_db.py.

Use @pytest.mark.unit decorator.
  </action>
  <verify>
Run: `uv run pytest tests/unit/search/test_db.py -v -k symbol`
All symbol-related tests should pass.
  </verify>
  <done>Unit tests verify symbol column checks work correctly</done>
</task>

</tasks>

<verification>
1. Module imports: `uv run python -c "from cocosearch.search.db import check_symbol_columns_exist, reset_symbol_columns_cache"`
2. All db tests: `uv run pytest tests/unit/search/test_db.py -v`
3. Symbol-specific tests: `uv run pytest tests/unit/search/test_db.py -v -k symbol`
</verification>

<success_criteria>
- db.py has check_symbol_columns_exist() function
- Function checks for all three columns: symbol_type, symbol_name, symbol_signature
- Module-level caching prevents repeated database queries
- Cache can be reset for testing
- Pre-v1.7 indexes return False (graceful degradation path)
- Unit tests cover all column check scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/29-symbol-aware-indexing/29-03-SUMMARY.md`
</output>
