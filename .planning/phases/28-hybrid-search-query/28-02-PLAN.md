---
phase: 28-hybrid-search-query
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - src/cocosearch/search/query.py
  - src/cocosearch/cli.py
  - src/cocosearch/mcp/server.py
  - tests/unit/test_search_query.py
autonomous: true

must_haves:
  truths:
    - "CLI --hybrid flag enables hybrid search mode"
    - "MCP use_hybrid_search parameter enables hybrid search"
    - "Identifier patterns in query automatically trigger hybrid search"
    - "Search results include match_type indicator (semantic/keyword/both)"
  artifacts:
    - path: "src/cocosearch/search/query.py"
      provides: "Search function with hybrid mode support"
      contains: "use_hybrid"
    - path: "src/cocosearch/cli.py"
      provides: "CLI with --hybrid flag on search command"
      contains: "--hybrid"
    - path: "src/cocosearch/mcp/server.py"
      provides: "MCP tool with use_hybrid_search parameter"
      contains: "use_hybrid_search"
  key_links:
    - from: "src/cocosearch/cli.py"
      to: "src/cocosearch/search/query.py"
      via: "search() call with use_hybrid parameter"
      pattern: "search\\(.*use_hybrid"
    - from: "src/cocosearch/mcp/server.py"
      to: "src/cocosearch/search/query.py"
      via: "search() call with use_hybrid parameter"
      pattern: "search\\(.*use_hybrid"
    - from: "src/cocosearch/search/query.py"
      to: "src/cocosearch/search/hybrid.py"
      via: "hybrid_search import and call"
      pattern: "from cocosearch.search.hybrid import"
---

<objective>
Integrate hybrid search into CLI and MCP interfaces.

Purpose: Wire the hybrid search algorithm (from Plan 01) into the search command CLI flag and MCP tool parameter, enabling users to explicitly request hybrid search or have it auto-triggered by identifier patterns.

Output:
- Updated query.py with hybrid search support
- Updated cli.py with --hybrid flag
- Updated mcp/server.py with use_hybrid_search parameter
- Extended tests for integration points
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-hybrid-search-query/28-CONTEXT.md
@.planning/phases/28-hybrid-search-query/28-01-SUMMARY.md

Key existing code:
@src/cocosearch/search/query.py (extend with hybrid mode)
@src/cocosearch/cli.py (add --hybrid flag)
@src/cocosearch/mcp/server.py (add use_hybrid_search param)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend search() function with hybrid mode</name>
  <files>src/cocosearch/search/query.py</files>
  <action>
Extend the main search() function to support hybrid mode.

Add new parameters to search():
```python
def search(
    query: str,
    index_name: str,
    limit: int = 10,
    min_score: float = 0.0,
    language_filter: str | None = None,
    use_hybrid: bool | None = None,  # NEW: None=auto, True=force, False=vector-only
) -> list[SearchResult]:
```

Implementation logic:
1. If use_hybrid is None (auto mode):
   - Import has_identifier_pattern from query_analyzer
   - Check if query contains identifier patterns
   - If yes AND _has_content_text_column is True, use hybrid search
   - Otherwise, fall back to vector-only search

2. If use_hybrid is True (explicit):
   - Verify _has_content_text_column is True
   - If not, log warning and fall back to vector-only
   - If yes, use hybrid search

3. If use_hybrid is False:
   - Use vector-only search (existing behavior)

4. When using hybrid search:
   - Import hybrid_search from hybrid module
   - Call hybrid_search() instead of direct SQL
   - Convert HybridSearchResult to SearchResult (add match_type field)

5. Update SearchResult dataclass:
   - Add match_type: str = "" (empty for vector-only backward compat)
   - Add vector_score: float | None = None (optional breakdown)
   - Add keyword_score: float | None = None (optional breakdown)

Graceful degradation:
- If hybrid requested but content_text column missing, fall back silently
- Existing indexes (pre-v1.7) continue to work with vector-only
  </action>
  <verify>
Extend tests/unit/test_search_query.py with:
- test_search_auto_hybrid_triggered_by_camelcase
- test_search_auto_hybrid_triggered_by_snake_case
- test_search_explicit_hybrid_mode
- test_search_vector_only_when_hybrid_false
- test_search_fallback_when_no_hybrid_columns

Run: `uv run pytest tests/unit/test_search_query.py -v`
  </verify>
  <done>
search() function supports use_hybrid parameter with auto/explicit/disabled modes, graceful fallback works.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --hybrid flag to CLI search command</name>
  <files>src/cocosearch/cli.py</files>
  <action>
Add --hybrid flag to the search subcommand parser.

1. Add argument to search_parser:
```python
search_parser.add_argument(
    "--hybrid",
    action="store_true",
    default=None,  # None means auto-detect
    help="Enable hybrid search (vector + keyword). Auto-enabled for identifier patterns.",
)
```

Note: Need special handling for None vs False:
- Not specified (default): None -> auto-detect from query
- --hybrid specified: True -> force hybrid
- No way to explicitly disable via CLI (vector-only is the fallback anyway)

2. Update search_command() to pass use_hybrid to search():
```python
results = search(
    query=query,
    index_name=index_name,
    limit=limit,
    min_score=min_score,
    language_filter=lang_filter,
    use_hybrid=args.hybrid,  # Will be None or True
)
```

3. Update format_pretty() output to show match_type indicator:
- If result has match_type, display it: [semantic], [keyword], or [both]
- Use color coding: cyan for semantic, green for keyword, yellow for both

4. Update format_json() output to include new fields:
- match_type in JSON output
- vector_score and keyword_score when available
  </action>
  <verify>
Test CLI manually or via subprocess:
- `cocosearch search "getUserById" --pretty` should auto-detect hybrid
- `cocosearch search "authentication handler" --pretty` should use vector-only
- `cocosearch search "database connection" --hybrid --pretty` should force hybrid

Run existing CLI tests: `uv run pytest tests/unit/test_cli.py -v -k search`
  </verify>
  <done>
CLI --hybrid flag works, auto-detection triggers for identifier patterns, match_type shown in output.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add use_hybrid_search parameter to MCP tool</name>
  <files>src/cocosearch/mcp/server.py</files>
  <action>
Add use_hybrid_search parameter to the search_code MCP tool.

1. Update search_code function signature:
```python
@mcp.tool()
def search_code(
    query: Annotated[str, Field(description="Natural language search query")],
    index_name: Annotated[str | None, Field(...)],
    limit: Annotated[int, Field(description="Maximum results to return")] = 10,
    language: Annotated[str | None, Field(...)],
    use_hybrid_search: Annotated[
        bool | None,
        Field(
            description="Enable hybrid search (vector + keyword matching). "
            "None=auto (enabled for identifier patterns like camelCase/snake_case), "
            "True=always use hybrid, False=vector-only"
        ),
    ] = None,  # NEW parameter
) -> list[dict]:
```

2. Pass parameter to search():
```python
results = search(
    query=query,
    index_name=index_name,
    limit=limit,
    language_filter=language,
    use_hybrid=use_hybrid_search,  # Pass through
)
```

3. Include hybrid-specific fields in output dict:
```python
output.append({
    "file_path": r.filename,
    "start_line": start_line,
    "end_line": end_line,
    "score": r.score,
    "content": content,
    "block_type": r.block_type,
    "hierarchy": r.hierarchy,
    "language_id": r.language_id,
    # NEW fields for hybrid search
    "match_type": r.match_type if hasattr(r, 'match_type') else "semantic",
    "vector_score": r.vector_score if hasattr(r, 'vector_score') else None,
    "keyword_score": r.keyword_score if hasattr(r, 'keyword_score') else None,
})
```
  </action>
  <verify>
Test MCP tool (via unit test or direct call):
- search_code(query="getUserById", use_hybrid_search=None) -> auto-triggers hybrid
- search_code(query="database", use_hybrid_search=True) -> forces hybrid
- search_code(query="database", use_hybrid_search=False) -> vector-only

Run: `uv run pytest tests/unit/mcp/ -v`
  </verify>
  <done>
MCP use_hybrid_search parameter works, output includes match_type and score breakdowns.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run full test suite: `uv run pytest tests/unit/ -v -k "search or hybrid or query_analyzer"`
2. Manual CLI test:
   - `cocosearch search "getUserById" --pretty` (auto-hybrid)
   - `cocosearch search "user authentication" --pretty` (vector-only)
3. Verify backward compatibility: existing search without hybrid params still works
</verification>

<success_criteria>
- CLI --hybrid flag enables hybrid search mode (HYBR-02)
- MCP use_hybrid_search parameter enables hybrid mode (HYBR-03)
- Identifier patterns automatically trigger hybrid search (HYBR-04)
- Search results show match_type indicator
- Existing search behavior unchanged when hybrid not requested
- Graceful degradation for pre-v1.7 indexes
</success_criteria>

<output>
After completion, create `.planning/phases/28-hybrid-search-query/28-02-SUMMARY.md`
</output>
