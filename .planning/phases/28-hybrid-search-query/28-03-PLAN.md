---
phase: 28-hybrid-search-query
plan: 03
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - src/cocosearch/search/formatter.py
  - tests/unit/search/test_formatter.py
autonomous: true

must_haves:
  truths:
    - "Pretty output shows [semantic], [keyword], or [both] match type indicator"
    - "JSON output includes vector_score, keyword_score, combined_score, matched_terms"
    - "Match quality indicator distinguishes exact vs normalized matches"
  artifacts:
    - path: "src/cocosearch/search/formatter.py"
      provides: "Output formatting with match type indicators"
      contains: "match_type"
    - path: "tests/unit/search/test_formatter.py"
      provides: "Unit tests for hybrid search output formatting"
      min_lines: 40
  key_links:
    - from: "src/cocosearch/search/formatter.py"
      to: "SearchResult dataclass"
      via: "result.match_type attribute access"
      pattern: "match_type"
---

<objective>
Implement output presentation for hybrid search results.

Purpose: Format hybrid search results with match type indicators, score breakdowns, and match quality information per the CONTEXT.md decisions.

Output:
- Updated formatter.py with hybrid-aware formatting
- Unit tests for hybrid output formatting
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-hybrid-search-query/28-CONTEXT.md
@.planning/phases/28-hybrid-search-query/28-01-SUMMARY.md

Key existing code:
@src/cocosearch/search/formatter.py (update for hybrid output)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update pretty output format with match type indicators</name>
  <files>src/cocosearch/search/formatter.py</files>
  <action>
Update format_pretty() to display match type indicators for hybrid search results.

1. Add match type indicator display:
   - [semantic] - cyan color - for vector-only matches
   - [keyword] - green color - for keyword-only matches
   - [both] - yellow color - for double matches (both vector and keyword)

2. Display after score in result header:
   Current: `File: path/to/file.py (score: 0.85)`
   New:     `File: path/to/file.py (score: 0.85) [both]`

3. Use Rich markup for colors:
   ```python
   match_indicator = ""
   if hasattr(result, 'match_type') and result.match_type:
       if result.match_type == "semantic":
           match_indicator = " [cyan][semantic][/cyan]"
       elif result.match_type == "keyword":
           match_indicator = " [green][keyword][/green]"
       elif result.match_type == "both":
           match_indicator = " [yellow][both][/yellow]"
   ```

4. Optional verbose mode: if --verbose flag present, show score breakdown:
   ```
   File: path/to/file.py (score: 0.85) [both]
     vector: 0.82, keyword: 0.45
   ```
   (Note: verbose mode is optional enhancement, not required for this phase)

5. Backward compatibility:
   - If match_type is empty string or not present, don't show indicator
   - Existing non-hybrid results display unchanged
  </action>
  <verify>
Create test case in tests/unit/search/test_formatter.py:
- test_format_pretty_semantic_match_type
- test_format_pretty_keyword_match_type
- test_format_pretty_both_match_type
- test_format_pretty_no_match_type_backward_compat

Run: `uv run pytest tests/unit/search/test_formatter.py -v`
  </verify>
  <done>
Pretty output correctly displays match type indicators with appropriate colors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update JSON output format with score breakdowns</name>
  <files>src/cocosearch/search/formatter.py</files>
  <action>
Update format_json() to include detailed score breakdown for MCP clients.

1. Add hybrid-specific fields to JSON output:
   ```python
   result_dict = {
       "file_path": r.filename,
       "start_line": start_line,
       "end_line": end_line,
       "score": r.score,  # Combined score for hybrid, cosine for vector-only
       "content": content,
       # Existing metadata
       "block_type": r.block_type,
       "hierarchy": r.hierarchy,
       "language_id": r.language_id,
       # NEW: Hybrid search fields (only present when applicable)
       "match_type": getattr(r, 'match_type', ''),
       "vector_score": getattr(r, 'vector_score', None),
       "keyword_score": getattr(r, 'keyword_score', None),
   }
   ```

2. Clean up None values:
   - If vector_score is None, omit from JSON (don't include "vector_score": null)
   - Same for keyword_score
   - This keeps output clean for non-hybrid results

3. Per CONTEXT.md decisions:
   - Include matched_terms when keyword search returns matches
   - This requires hybrid.py to track which terms matched (optional enhancement)
   - For MVP: matched_terms can be omitted, added in future iteration

4. Backward compatibility:
   - Existing JSON consumers should not break
   - New fields are additive (match_type, vector_score, keyword_score)
  </action>
  <verify>
Create test cases in tests/unit/search/test_formatter.py:
- test_format_json_includes_match_type
- test_format_json_includes_score_breakdown
- test_format_json_omits_none_scores
- test_format_json_backward_compat_no_hybrid_fields

Run: `uv run pytest tests/unit/search/test_formatter.py -v`
  </verify>
  <done>
JSON output includes match_type and score breakdown, None values omitted, backward compatible.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. Run formatter tests: `uv run pytest tests/unit/search/test_formatter.py -v`
2. Run all search tests: `uv run pytest tests/unit/search/ tests/unit/test_search_query.py -v`
3. Manual verification:
   - Check pretty output colors render correctly
   - Check JSON output parses correctly with new fields
</verification>

<success_criteria>
- Match type indicator [semantic], [keyword], [both] shown in pretty output (per CONTEXT.md)
- JSON output includes vector_score, keyword_score, combined_score breakdown (per CONTEXT.md)
- Backward compatibility maintained for non-hybrid results
- All formatter unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/28-hybrid-search-query/28-03-SUMMARY.md`
</output>
