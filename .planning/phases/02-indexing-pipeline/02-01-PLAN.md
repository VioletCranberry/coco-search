---
phase: 02-indexing-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/cocosearch/indexer/__init__.py
  - src/cocosearch/indexer/config.py
  - src/cocosearch/indexer/file_filter.py
autonomous: true

must_haves:
  truths:
    - ".gitignore patterns are parsed and applied to file listing"
    - "User-specified include/exclude patterns filter files correctly"
    - "Config file (.cocosearch.yaml) is loaded when present"
    - "Default patterns exclude common generated files (node_modules, __pycache__, .git)"
  artifacts:
    - path: "src/cocosearch/indexer/config.py"
      provides: "IndexingConfig Pydantic model with defaults"
      exports: ["IndexingConfig", "load_config"]
    - path: "src/cocosearch/indexer/file_filter.py"
      provides: ".gitignore parsing and pattern filtering"
      exports: ["build_exclude_patterns", "load_gitignore_patterns"]
  key_links:
    - from: "src/cocosearch/indexer/config.py"
      to: "yaml"
      via: "pyyaml for .cocosearch.yaml loading"
      pattern: "yaml\\.safe_load"
    - from: "src/cocosearch/indexer/file_filter.py"
      to: "pathspec"
      via: "GitIgnoreSpec for .gitignore parsing"
      pattern: "pathspec"
---

<objective>
Set up indexer module with configuration and file filtering infrastructure.

Purpose: Establish the foundation for the indexing pipeline with proper config loading, .gitignore respect, and pattern-based file filtering. This enables INDEX-03 (gitignore respect) and INDEX-04 (include/exclude patterns).

Output: `src/cocosearch/indexer/` module with config.py and file_filter.py, plus new dependencies installed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-indexing-pipeline/02-RESEARCH.md
@.planning/phases/02-indexing-pipeline/02-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 2 dependencies</name>
  <files>pyproject.toml</files>
  <action>
Add the following dependencies to pyproject.toml:
- pathspec>=1.0.3 (for .gitignore parsing via GitIgnoreSpec)
- pyyaml>=6.0.2 (for .cocosearch.yaml config loading)
- rich>=13.0.0 (for progress bars during indexing)

Run `uv sync` to install them.

Note: pydantic is already available via mcp dependency, so no need to add explicitly.
  </action>
  <verify>
Run `uv run python -c "import pathspec; import yaml; import rich; print('OK')"` - should print OK without errors.
  </verify>
  <done>Dependencies pathspec, pyyaml, and rich are installed and importable.</done>
</task>

<task type="auto">
  <name>Task 2: Create indexer config module</name>
  <files>src/cocosearch/indexer/__init__.py, src/cocosearch/indexer/config.py</files>
  <action>
Create `src/cocosearch/indexer/` directory and module.

In `config.py`, implement:

1. `IndexingConfig` Pydantic model with fields:
   - include_patterns: list[str] = ["*.py", "*.js", "*.ts", "*.tsx", "*.jsx", "*.rs", "*.go", "*.java", "*.c", "*.cpp", "*.h", "*.hpp", "*.rb", "*.php", "*.swift", "*.kt", "*.scala", "*.md", "*.mdx"]
   - exclude_patterns: list[str] = []
   - chunk_size: int = 1000 (bytes)
   - chunk_overlap: int = 300 (bytes)

2. `load_config(codebase_path: str) -> IndexingConfig` function:
   - Look for `.cocosearch.yaml` in codebase_path
   - If exists, load with yaml.safe_load and parse "indexing" section
   - If not exists, return IndexingConfig with defaults
   - Handle missing/malformed config gracefully (return defaults)

In `__init__.py`, export: IndexingConfig, load_config
  </action>
  <verify>
Run:
```
uv run python -c "
from cocosearch.indexer import IndexingConfig, load_config
cfg = IndexingConfig()
print(f'chunk_size={cfg.chunk_size}, patterns={len(cfg.include_patterns)}')
"
```
Should print: chunk_size=1000, patterns=20 (or similar count)
  </verify>
  <done>IndexingConfig Pydantic model created with sensible defaults, load_config function reads .cocosearch.yaml when present.</done>
</task>

<task type="auto">
  <name>Task 3: Create file filter module</name>
  <files>src/cocosearch/indexer/file_filter.py</files>
  <action>
Create `file_filter.py` with:

1. `load_gitignore_patterns(codebase_path: str) -> list[str]`:
   - Read .gitignore file if exists at codebase_path
   - Return list of pattern lines (stripped, non-empty, non-comment)
   - Return empty list if file doesn't exist

2. `DEFAULT_EXCLUDES` constant list:
   - ".*" (hidden files/dirs)
   - "**/node_modules"
   - "**/__pycache__"
   - "**/target" (Rust)
   - "**/vendor" (Go, PHP)
   - "**/*.min.js"
   - "**/*.min.css"
   - "**/dist"
   - "**/build"
   - "**/.git"

3. `build_exclude_patterns(codebase_path: str, user_excludes: list[str] | None = None, respect_gitignore: bool = True) -> list[str]`:
   - Start with DEFAULT_EXCLUDES
   - If respect_gitignore, add patterns from load_gitignore_patterns()
   - Add user_excludes if provided
   - Filter out empty strings and comment lines (starting with #)
   - Return combined list

Export: load_gitignore_patterns, build_exclude_patterns, DEFAULT_EXCLUDES from file_filter.py
Update __init__.py to export these as well.
  </action>
  <verify>
Run:
```
uv run python -c "
from cocosearch.indexer import build_exclude_patterns, DEFAULT_EXCLUDES
patterns = build_exclude_patterns('/tmp', user_excludes=['*.log'])
print(f'default_count={len(DEFAULT_EXCLUDES)}, total={len(patterns)}')
assert '*.log' in patterns
assert '**/node_modules' in patterns
print('OK')
"
```
Should print default count, total count, and OK.
  </verify>
  <done>File filter module correctly combines default excludes, .gitignore patterns, and user excludes into unified exclude list.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Dependencies installed:
   ```bash
   uv run python -c "import pathspec, yaml, rich; print('deps OK')"
   ```

2. Config module works:
   ```bash
   uv run python -c "from cocosearch.indexer import IndexingConfig; print(IndexingConfig().model_dump_json(indent=2))"
   ```

3. File filter module works:
   ```bash
   uv run python -c "from cocosearch.indexer import build_exclude_patterns; print(build_exclude_patterns('.'))"
   ```

4. Module structure exists:
   ```bash
   ls -la src/cocosearch/indexer/
   ```
   Should show: __init__.py, config.py, file_filter.py
</verification>

<success_criteria>
- pathspec, pyyaml, rich dependencies added to pyproject.toml and importable
- IndexingConfig Pydantic model with sensible defaults for code indexing
- load_config() reads .cocosearch.yaml when present, returns defaults otherwise
- build_exclude_patterns() combines defaults + .gitignore + user patterns
- All exports available from cocosearch.indexer package
</success_criteria>

<output>
After completion, create `.planning/phases/02-indexing-pipeline/02-01-SUMMARY.md`
</output>
