---
phase: 19-config-env-var-substitution
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/cocosearch/config/env_substitution.py
  - tests/unit/config/test_env_substitution.py
autonomous: true

must_haves:
  truths:
    - "Function substitutes ${VAR} with environment variable value"
    - "Function substitutes ${VAR:-default} with default when VAR missing"
    - "Function returns list of missing required env vars"
    - "Function handles nested dicts and lists recursively"
  artifacts:
    - path: "src/cocosearch/config/env_substitution.py"
      provides: "substitute_env_vars function"
      exports: ["substitute_env_vars"]
    - path: "tests/unit/config/test_env_substitution.py"
      provides: "Unit tests for env var substitution"
      min_lines: 80
  key_links:
    - from: "src/cocosearch/config/env_substitution.py"
      to: "os.environ"
      via: "os.environ.get() for env var lookup"
      pattern: "os\\.environ\\.get"
---

<objective>
Create a pure function for environment variable substitution in config data structures.

Purpose: Enable config values like `${DATABASE_URL}` to resolve to actual env var values, with support for defaults via `${VAR:-default}` syntax.
Output: New module `env_substitution.py` with `substitute_env_vars()` function, fully tested.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-config-env-var-substitution/19-RESEARCH.md

# Existing config module structure
@src/cocosearch/config/schema.py
@src/cocosearch/config/loader.py

# Test patterns
@tests/unit/config/test_loader.py
</context>

<feature>
  <name>Environment Variable Substitution</name>
  <files>
    src/cocosearch/config/env_substitution.py
    tests/unit/config/test_env_substitution.py
  </files>
  <behavior>
    Pure function `substitute_env_vars(data: Any) -> tuple[Any, list[str]]`

    Input: Parsed YAML data (dict, list, or scalar)
    Output: Tuple of (substituted_data, missing_required_vars)

    Substitution rules:
    - `${VAR}` -> os.environ["VAR"] (if exists), else keep original and add to missing list
    - `${VAR:-default}` -> os.environ.get("VAR", "default") (never missing)
    - Non-string values pass through unchanged
    - Recursively processes dicts and lists

    Test cases:
    - "${VAR}" with VAR set -> returns VAR value, empty missing list
    - "${VAR}" with VAR unset -> returns original "${VAR}", ["VAR"] in missing
    - "${VAR:-fallback}" with VAR unset -> returns "fallback", empty missing
    - "${VAR:-fallback}" with VAR set -> returns VAR value, empty missing
    - "prefix_${VAR}_suffix" -> "prefix_value_suffix" (partial substitution)
    - Multiple ${} in one string -> all substituted
    - Nested dict -> recursive substitution
    - List of strings -> each element substituted
    - Empty string as default "${VAR:-}" -> empty string when VAR unset
    - Integer/float/bool values -> unchanged (not strings)
    - None values -> unchanged
  </behavior>
  <implementation>
    Use regex pattern `r'\$\{([^}^{]+)\}'` to match ${...} syntax.

    In replacer function:
    1. Extract expression from match
    2. If contains ":-", split into var_name and default
    3. Return os.environ.get(var_name, default) for default case
    4. For required vars, check os.environ.get(var_name)
    5. If None, append to missing list and return original match
    6. Else return the value

    Use re.sub() for global replacement in strings.

    Reference: 19-RESEARCH.md code examples for exact pattern.
  </implementation>
</feature>

<verification>
1. Run tests: `uv run pytest tests/unit/config/test_env_substitution.py -v`
2. All tests pass with no skips
3. Coverage check: `uv run pytest tests/unit/config/test_env_substitution.py --cov=src/cocosearch/config/env_substitution --cov-report=term-missing`
</verification>

<success_criteria>
- [ ] `substitute_env_vars()` function exists and is importable
- [ ] All test cases from <behavior> have passing tests
- [ ] Function correctly handles ${VAR} and ${VAR:-default} syntax
- [ ] Function returns tuple of (result, missing_vars)
- [ ] Tests use monkeypatch for env var mocking (not direct os.environ manipulation)
</success_criteria>

<output>
After completion, create `.planning/phases/19-config-env-var-substitution/19-01-SUMMARY.md`
</output>
