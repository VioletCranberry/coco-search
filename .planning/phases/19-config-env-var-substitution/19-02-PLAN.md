---
phase: 19-config-env-var-substitution
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - src/cocosearch/config/loader.py
  - src/cocosearch/config/__init__.py
  - tests/unit/config/test_loader.py
autonomous: true

must_haves:
  truths:
    - "User can write ${DATABASE_URL} in cocosearch.yaml and it resolves to env var value"
    - "User sees clear error message listing all missing env vars when they are not set"
    - "User can use env var substitution in indexing, search, and embedding config sections"
  artifacts:
    - path: "src/cocosearch/config/loader.py"
      provides: "Config loading with env var substitution"
      contains: "substitute_env_vars"
    - path: "tests/unit/config/test_loader.py"
      provides: "Tests for env var substitution in config loading"
      contains: "test_.*env.*var"
  key_links:
    - from: "src/cocosearch/config/loader.py"
      to: "src/cocosearch/config/env_substitution.py"
      via: "import and call substitute_env_vars"
      pattern: "from .env_substitution import substitute_env_vars"
    - from: "src/cocosearch/config/loader.py"
      to: "ConfigError"
      via: "raise on missing env vars"
      pattern: "raise ConfigError.*Missing.*environment"
---

<objective>
Integrate environment variable substitution into the config loading pipeline.

Purpose: Users can now use `${VAR}` and `${VAR:-default}` syntax anywhere in cocosearch.yaml, enabling flexible deployment configurations.
Output: Modified loader.py that substitutes env vars after YAML parse, before Pydantic validation.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-config-env-var-substitution/19-RESEARCH.md
@.planning/phases/19-config-env-var-substitution/19-01-SUMMARY.md

# Files to modify
@src/cocosearch/config/loader.py
@src/cocosearch/config/__init__.py
@tests/unit/config/test_loader.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate substitution into loader.py</name>
  <files>
    src/cocosearch/config/loader.py
    src/cocosearch/config/__init__.py
  </files>
  <action>
    Modify `load_config()` in loader.py to call `substitute_env_vars()` after yaml.safe_load() and before model_validate():

    1. Import at top: `from .env_substitution import substitute_env_vars`

    2. In load_config(), after `data = yaml.safe_load(f)` and before `CocoSearchConfig.model_validate(data)`:
       ```python
       # Substitute environment variables
       data, missing_vars = substitute_env_vars(data)
       if missing_vars:
           raise ConfigError(
               f"Missing required environment variables in {path}: "
               f"{', '.join(sorted(missing_vars))}"
           )
       ```

    3. Update __init__.py to export `substitute_env_vars` if useful for external use (optional, can skip if not needed).

    4. Update docstring for load_config() to mention env var substitution support.
  </action>
  <verify>
    Create test config file with ${TEST_VAR:-default} and verify:
    - `TEST_VAR=custom uv run python -c "from cocosearch.config import load_config; print(load_config(...))"` shows custom value
    - Without TEST_VAR, shows default value
  </verify>
  <done>
    load_config() integrates env var substitution in the correct position in the pipeline.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add loader integration tests</name>
  <files>tests/unit/config/test_loader.py</files>
  <action>
    Add new test class `TestEnvVarSubstitution` to test_loader.py with tests:

    1. `test_substitutes_env_var_in_index_name` - verify ${VAR} in indexName resolves
    2. `test_substitutes_env_var_with_default` - verify ${VAR:-default} works
    3. `test_substitutes_env_var_in_indexing_section` - verify substitution in indexing.includePatterns
    4. `test_substitutes_env_var_in_search_section` - verify substitution in search section (note: numeric fields like resultLimit won't work with substitution due to strict=True, test with a string that becomes valid)
    5. `test_substitutes_env_var_in_embedding_section` - verify embedding.model substitution
    6. `test_raises_config_error_on_missing_required_env_var` - verify clear error message
    7. `test_error_message_lists_all_missing_vars` - verify multiple missing vars all listed

    Use monkeypatch.setenv() / monkeypatch.delenv() for env var mocking.

    Pattern for tests:
    ```python
    def test_substitutes_env_var_in_index_name(self, tmp_path, monkeypatch):
        monkeypatch.setenv("MY_INDEX", "production-index")
        config_file = tmp_path / "cocosearch.yaml"
        config_file.write_text("indexName: ${MY_INDEX}")

        config = load_config(config_file)

        assert config.indexName == "production-index"
    ```
  </action>
  <verify>`uv run pytest tests/unit/config/test_loader.py -v -k "env"` runs all new tests and passes</verify>
  <done>
    All three config sections (indexing, search, embedding) have tests proving env var substitution works.
    Error case tests verify clear error messages with missing var names.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full test suite passes</name>
  <files>None (verification only)</files>
  <action>
    Run the complete unit test suite to ensure no regressions:

    1. Run all unit tests: `uv run pytest tests/unit/ -v`
    2. Run config-specific tests: `uv run pytest tests/unit/config/ -v`
    3. Verify no test failures or unexpected warnings
  </action>
  <verify>`uv run pytest tests/unit/ -v` completes with 0 failures</verify>
  <done>
    Entire unit test suite passes with env var substitution integrated.
  </done>
</task>

</tasks>

<verification>
1. Create a test cocosearch.yaml with env vars:
   ```yaml
   indexName: ${PROJECT_NAME:-default-project}
   embedding:
     model: ${OLLAMA_MODEL:-nomic-embed-text}
   ```

2. Test with env var set:
   ```bash
   PROJECT_NAME=my-project uv run python -c "
   from pathlib import Path
   from cocosearch.config import load_config
   config = load_config(Path('test-config.yaml'))
   print(f'indexName: {config.indexName}')
   print(f'model: {config.embedding.model}')
   "
   ```
   Expected: indexName=my-project, model=nomic-embed-text

3. Test with required env var missing:
   ```yaml
   indexName: ${REQUIRED_VAR}
   ```
   Expected: ConfigError mentioning REQUIRED_VAR
</verification>

<success_criteria>
- [ ] load_config() calls substitute_env_vars() between YAML parse and Pydantic validation
- [ ] Missing required env vars raise ConfigError with clear message listing all missing vars
- [ ] Env var substitution works in indexName, indexing, search, and embedding sections
- [ ] All existing loader tests still pass (no regressions)
- [ ] New integration tests cover all three config sections
- [ ] Full unit test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/19-config-env-var-substitution/19-02-SUMMARY.md`
</output>
