---
phase: 17-developer-setup-script
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - dev-setup.sh
autonomous: true

must_haves:
  truths:
    - "Running ./dev-setup.sh from repo root starts all required services"
    - "Script waits for PostgreSQL to be healthy before proceeding"
    - "Script starts Ollama in Docker and pulls nomic-embed-text model"
    - "Script indexes the CocoSearch codebase automatically"
    - "Running the script multiple times is safe (idempotent)"
    - "Script shows plain text progress with inline prefixes"
    - "Script prompts to keep containers on failure"
  artifacts:
    - path: "dev-setup.sh"
      provides: "Developer setup automation"
      min_lines: 100
    - path: "docker-compose.yml"
      provides: "PostgreSQL and Ollama service definitions"
      contains: "ollama"
  key_links:
    - from: "dev-setup.sh"
      to: "docker-compose.yml"
      via: "docker compose up"
      pattern: "docker compose up"
    - from: "dev-setup.sh"
      to: "cocosearch index"
      via: "uv run"
      pattern: "uv run cocosearch index"
---

<objective>
Create dev-setup.sh script and supporting infrastructure for one-command developer setup

Purpose: Enable new developers to get from zero to a working CocoSearch environment with a single command
Output: Executable dev-setup.sh script that starts containers, installs dependencies, and indexes the codebase
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-developer-setup-script/17-CONTEXT.md
@.planning/phases/17-developer-setup-script/17-RESEARCH.md
@docker-compose.yml
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Ollama service to docker-compose.yml</name>
  <files>docker-compose.yml</files>
  <action>
Update docker-compose.yml to add the Ollama service alongside PostgreSQL.

Add Ollama service with:
- Image: ollama/ollama:latest
- Container name: cocosearch-ollama
- Port mapping: 11434:11434
- Volume for model persistence: ollama_data:/root/.ollama
- Health check: curl to /api/tags endpoint (interval: 10s, timeout: 5s, retries: 5, start_period: 30s)
- restart: unless-stopped

Add ollama_data volume to volumes section.

Keep existing PostgreSQL service (db) and postgres_data volume unchanged.
  </action>
  <verify>
Validate docker-compose.yml syntax:
```bash
docker compose config > /dev/null
```
  </verify>
  <done>docker-compose.yml contains both db and ollama services with health checks</done>
</task>

<task type="auto">
  <name>Task 2: Create dev-setup.sh script</name>
  <files>dev-setup.sh</files>
  <action>
Create dev-setup.sh in the repository root with the following structure:

**Header:**
- Shebang: #!/usr/bin/env bash
- Strict mode: set -euo pipefail
- Script location detection: SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

**Variables:**
- CLEANUP_NEEDED=false (flag for trap handler)

**Trap handlers:**
- cleanup_on_exit function:
  - Check exit code and CLEANUP_NEEDED flag
  - If failed and containers started: prompt "Keep containers for debugging? [y/N]"
  - If user says no: run docker compose down
- Register trap for EXIT
- Register trap for INT/TERM with "Interrupted" message

**Functions:**

1. check_docker():
   - Verify docker command exists (command -v docker)
   - Verify Docker daemon running (docker info)
   - Print actionable error with install URL if missing

2. check_uv():
   - Verify uv command exists (command -v uv)
   - Print install instructions if missing (curl -LsSf https://astral.sh/uv/install.sh | sh)

3. check_port():
   - Parameters: port, service_name
   - Use lsof -Pi :PORT -sTCP:LISTEN -t
   - If port in use: show which process and exit 1

4. start_services():
   - echo "postgres: Starting container..."
   - echo "ollama: Starting container..."
   - docker compose up -d --wait
   - Set CLEANUP_NEEDED=true after starting

5. pull_model():
   - MODEL="nomic-embed-text"
   - Check if model exists: docker exec cocosearch-ollama ollama list | grep -q "$MODEL"
   - If not: echo "ollama: Pulling $MODEL model..." and docker exec cocosearch-ollama ollama pull "$MODEL"
   - If exists: echo "ollama: $MODEL already available"

6. install_dependencies():
   - echo "dependencies: Installing Python packages..."
   - uv sync

7. index_codebase():
   - echo "cocosearch: Indexing codebase..."
   - uv run cocosearch index . --name cocosearch
   - Use --name cocosearch for the index name

8. run_demo_search():
   - echo ""
   - echo "cocosearch: Running demo search..."
   - uv run cocosearch search "how does indexing work" --name cocosearch --limit 3 --pretty
   - (This proves the setup works end-to-end)

9. show_next_steps():
   - Print section header "Setup complete!"
   - Print quick reference commands:
     - Search: uv run cocosearch search "query" --name cocosearch --pretty
     - Index: uv run cocosearch index /path/to/codebase --name my-index
     - REPL: uv run cocosearch repl --name cocosearch
   - Print teardown instructions:
     - Stop services: docker compose down
     - Remove data: docker compose down -v

**Main flow:**
```bash
main() {
    cd "$SCRIPT_DIR"  # Ensure we're in repo root

    echo "CocoSearch Developer Setup"
    echo "=========================="
    echo ""

    check_docker
    check_uv
    check_port 5432 "PostgreSQL"
    check_port 11434 "Ollama"

    start_services
    pull_model
    install_dependencies
    index_codebase
    run_demo_search
    show_next_steps
}

main
```

**Output format (per CONTEXT.md):**
- Plain text, no colors, no emojis
- Inline prefix format: "postgres: Starting container..."
- Stream all output from underlying tools

**Idempotency (per DEVS-07):**
- Port checks happen before starting (avoids conflicts)
- docker compose up -d is idempotent (won't recreate running containers)
- uv sync is idempotent (just verifies deps)
- ollama list check before pull (skips if already present)
- cocosearch index is safe to re-run (incremental indexing)

Make the script executable:
```bash
chmod +x dev-setup.sh
```
  </action>
  <verify>
1. Script is executable:
```bash
test -x dev-setup.sh && echo "Executable: yes"
```

2. Script passes shellcheck (if available):
```bash
shellcheck dev-setup.sh 2>/dev/null || echo "shellcheck not installed, skipping"
```

3. Script syntax is valid:
```bash
bash -n dev-setup.sh && echo "Syntax: valid"
```
  </verify>
  <done>dev-setup.sh exists, is executable, and has valid bash syntax</done>
</task>

<task type="auto">
  <name>Task 3: Verify complete setup flow</name>
  <files>dev-setup.sh, docker-compose.yml</files>
  <action>
Run the complete dev-setup.sh script to verify it works end-to-end.

Before running:
1. Stop any existing containers: docker compose down
2. Ensure ports 5432 and 11434 are free

Run the script:
```bash
./dev-setup.sh
```

Expected flow:
1. Docker and UV checks pass
2. Port checks pass (or fail with clear message if in use)
3. PostgreSQL and Ollama containers start
4. Containers become healthy (--wait succeeds)
5. Model is pulled (or skipped if present)
6. Dependencies install via uv sync
7. Codebase is indexed
8. Demo search returns results
9. Next steps are printed

If any step fails, the script should:
1. Print clear error message
2. Prompt to keep containers for debugging
3. Exit with non-zero code

After successful run, verify:
1. Both containers are running: docker ps --filter "name=cocosearch"
2. Model is available: docker exec cocosearch-ollama ollama list | grep nomic-embed-text
3. Index exists: uv run cocosearch list --json | grep cocosearch
  </action>
  <verify>
```bash
# Containers running
docker ps --filter "name=cocosearch" --format "{{.Names}}" | sort

# Model available
docker exec cocosearch-ollama ollama list | grep nomic-embed-text

# Index created
uv run cocosearch list --json 2>/dev/null | grep -q cocosearch && echo "Index: created"
```
  </verify>
  <done>dev-setup.sh completes successfully with indexed codebase and working search</done>
</task>

</tasks>

<verification>
Phase-level verification:

1. Script existence and permissions:
```bash
test -x dev-setup.sh && echo "dev-setup.sh: executable"
```

2. Docker Compose has both services:
```bash
docker compose config --services | sort
# Expected: db, ollama
```

3. Full idempotency test (run twice):
```bash
./dev-setup.sh && echo "First run: success"
./dev-setup.sh && echo "Second run: success (idempotent)"
```

4. Cleanup works (Ctrl+C during run should trigger prompt)
</verification>

<success_criteria>
1. dev-setup.sh exists in repo root and is executable
2. docker-compose.yml contains both db (PostgreSQL) and ollama services
3. Running ./dev-setup.sh from fresh state completes successfully
4. Script is idempotent (second run succeeds without errors)
5. Script uses plain text output with inline prefixes (no colors/emojis)
6. Demo search at end proves the setup works
7. Next steps printed with copy-paste ready commands
</success_criteria>

<output>
After completion, create `.planning/phases/17-developer-setup-script/17-01-SUMMARY.md`
</output>
