---
phase: 38-multi-repo-mcp-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cocosearch/cli.py
  - src/cocosearch/mcp/server.py
autonomous: true

must_haves:
  truths:
    - "MCP server accepts --project-from-cwd flag"
    - "When search runs on unindexed repo, user receives clear guidance to index"
    - "When search runs on stale index, user receives warning about freshness"
    - "Resolved project path shown in search context"
  artifacts:
    - path: "src/cocosearch/cli.py"
      provides: "--project-from-cwd CLI flag for mcp command"
      contains: "project-from-cwd"
    - path: "src/cocosearch/mcp/server.py"
      provides: "Staleness warning in search results"
      contains: "staleness"
  key_links:
    - from: "src/cocosearch/cli.py"
      to: "src/cocosearch/mcp/server.py"
      via: "COCOSEARCH_PROJECT_PATH environment variable"
      pattern: "COCOSEARCH_PROJECT_PATH"
---

<objective>
Add --project-from-cwd flag to MCP server CLI and integrate staleness warnings into search results.

Purpose: Enable single MCP registration that works across all user projects by passing workspace context via environment variable, and provide users with actionable feedback about index health.

Output: CLI flag for workspace detection, staleness warnings in search results, header showing resolved project path.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/38-multi-repo-mcp-support/38-CONTEXT.md
@.planning/phases/38-multi-repo-mcp-support/38-RESEARCH.md
@src/cocosearch/cli.py
@src/cocosearch/mcp/server.py
@src/cocosearch/management/context.py
@src/cocosearch/management/stats.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --project-from-cwd CLI flag</name>
  <files>src/cocosearch/cli.py</files>
  <action>
Add `--project-from-cwd` flag to the MCP subcommand parser (after --port argument):

```python
mcp_parser.add_argument(
    "--project-from-cwd",
    action="store_true",
    default=False,
    help="Auto-detect project from current working directory. Required for user-scope MCP registration.",
)
```

In `mcp_command()` function, after resolving port and before calling `run_server()`:

```python
# Pass project path via environment variable if --project-from-cwd is set
if args.project_from_cwd:
    import os
    project_path = os.getcwd()
    os.environ["COCOSEARCH_PROJECT_PATH"] = project_path
```

This environment variable will be read by the MCP server to override the default cwd detection.
  </action>
  <verify>
Run `cocosearch mcp --help` and verify `--project-from-cwd` flag is documented.
Run `COCOSEARCH_PROJECT_PATH=/tmp cocosearch mcp --transport stdio` with ctrl-c and verify no errors.
  </verify>
  <done>
CLI shows --project-from-cwd in help output. Flag sets COCOSEARCH_PROJECT_PATH environment variable when used.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate project path and staleness into MCP search</name>
  <files>src/cocosearch/mcp/server.py</files>
  <action>
Modify the `search_code` MCP tool to:

1. Use COCOSEARCH_PROJECT_PATH environment variable if set (before calling `find_project_root()`):

```python
# Check for explicit project path from --project-from-cwd
project_path_env = os.environ.get("COCOSEARCH_PROJECT_PATH")
if index_name is None:
    if project_path_env:
        # Use explicit path from --project-from-cwd flag
        start_path = Path(project_path_env)
        root_path, detection_method = find_project_root(start_path)
    else:
        root_path, detection_method = find_project_root()
    # ... rest of existing logic
```

2. Add header with resolved project path when auto-detecting. At the start of the results, add a context dict:

```python
# Build header with project context
search_header = {
    "searching": str(root_path),
    "index_name": index_name,
}
```

3. After successful search and before returning results, check staleness and add warning as final result if stale:

```python
from cocosearch.management.stats import check_staleness

# Check staleness and add footer warning if needed
is_stale, staleness_days = check_staleness(index_name, threshold_days=7)

if is_stale and staleness_days > 0:
    output.append({
        "warning": "Index may be stale",
        "message": (
            f"Index last updated {staleness_days} days ago. "
            f"Run `cocosearch index {root_path}` to refresh."
        ),
        "staleness_days": staleness_days
    })
```

4. Add `search_header` to the first result or as first item in output list to provide context about what was searched.

Import `Path` from `pathlib` at the top of the file.
  </action>
  <verify>
Test with an existing index that has metadata:
1. Run search and verify no staleness warning appears for fresh index
2. Manually update metadata to make index appear stale (or wait/mock)
3. Verify staleness warning appears in search results

Test auto-detection:
1. `cd` to a project with existing index
2. Run search via MCP without specifying index_name
3. Verify search works and shows correct project path
  </verify>
  <done>
Search results include project context header. Stale indexes show warning with reindex command. Fresh indexes show no warning.
  </done>
</task>

</tasks>

<verification>
1. `cocosearch mcp --help` shows `--project-from-cwd` flag
2. Search results on stale index (>7 days) include staleness warning
3. Search results on fresh index have no staleness warning
4. Auto-detected searches show resolved project path
5. Unindexed project returns clear guidance message (existing functionality preserved)
</verification>

<success_criteria>
- --project-from-cwd flag documented in CLI help
- Staleness warnings appear only for indexes older than 7 days
- Warning message includes exact reindex command
- Project path visible in search context
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/38-multi-repo-mcp-support/38-01-SUMMARY.md`
</output>
