---
phase: 16-cli-config-integration
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/cocosearch/cli.py
  - tests/unit/test_cli_config_integration.py
autonomous: true

must_haves:
  truths:
    - "User can run 'coco config show' to see effective configuration with sources"
    - "User can run 'coco config path' to see config file location"
    - "CLI help shows config key and env var equivalents for flags"
    - "CLI flags override config file values"
    - "Env vars override config file values when CLI flag not provided"
  artifacts:
    - path: "src/cocosearch/cli.py"
      provides: "Config subcommands and CLI flag precedence integration"
      contains: ["config_show_command", "config_path_command", "ConfigResolver"]
    - path: "tests/unit/test_cli_config_integration.py"
      provides: "Tests for config subcommands and precedence"
      min_lines: 50
  key_links:
    - from: "src/cocosearch/cli.py"
      to: "ConfigResolver"
      via: "import from config module"
      pattern: "from cocosearch\\.config import.*ConfigResolver"
    - from: "src/cocosearch/cli.py"
      to: "Rich Table"
      via: "import for config show"
      pattern: "from rich\\.table import Table"
---

<objective>
Add config subcommands and integrate CLI flag precedence into existing commands

Purpose: Complete CONF-09 by wiring ConfigResolver into CLI, adding config inspection commands, and showing config/env equivalents in help text.

Output: Working `coco config show/path` commands, CLI flags that override config, help text with config metadata
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-cli-config-integration/16-CONTEXT.md
@.planning/phases/16-cli-config-integration/16-RESEARCH.md
@.planning/phases/16-cli-config-integration/16-01-SUMMARY.md

# Existing CLI to extend
@src/cocosearch/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add config subcommand group</name>
  <files>src/cocosearch/cli.py</files>
  <action>
    Add `coco config show` and `coco config path` subcommands to CLI.

    1. Create config subparser with subcommands:
       ```python
       config_parser = subparsers.add_parser(
           "config",
           help="Configuration management",
           description="Inspect and manage CocoSearch configuration.",
       )
       config_subparsers = config_parser.add_subparsers(dest="config_command")
       ```

    2. Add `show` subcommand:
       - Displays Rich Table with columns: KEY, VALUE, SOURCE
       - Uses ConfigResolver to get all effective values with sources
       - Shows all config fields (indexName, indexing.*, search.*, embedding.*)

    3. Add `path` subcommand:
       - Prints config file path if found, or "No config file found"
       - Uses find_config_file() from config module

    4. Create command handlers:
       - config_show_command(args: argparse.Namespace) -> int
       - config_path_command(args: argparse.Namespace) -> int

    5. Update main() to route config commands:
       - Add "config" to known_subcommands
       - Add routing for config show/path
  </action>
  <verify>
    Run `python -m cocosearch config show` - shows table with KEY/VALUE/SOURCE
    Run `python -m cocosearch config path` - shows path or "No config file found"
  </verify>
  <done>
    - `coco config show` displays effective config as Rich Table
    - `coco config path` shows config file location
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CLI flags with config metadata</name>
  <files>src/cocosearch/cli.py</files>
  <action>
    Update argument definitions to show config/env equivalents in help text.

    1. Create helper function:
       ```python
       def add_config_arg(parser, *flags, config_key: str, help_text: str, **kwargs):
           """Add argument with config key and env var in help text."""
           env_var = config_key_to_env_var(config_key)
           full_help = f"{help_text} [config: {config_key}] [env: {env_var}]"
           parser.add_argument(*flags, help=full_help, **kwargs)
       ```

    2. Update index command arguments to use add_config_arg for:
       - --name -> config_key="indexName"
       - --include -> config_key="indexing.includePatterns"
       - --exclude -> config_key="indexing.excludePatterns"

    3. Update search command arguments to use add_config_arg for:
       - --index -> config_key="indexName"
       - --limit -> config_key="search.resultLimit"
       - --min-score -> config_key="search.minScore"

    Note: Keep existing --lang, --context, --pretty, --interactive as they don't have config equivalents.

    Import config_key_to_env_var from cocosearch.config.resolver.
  </action>
  <verify>
    Run `python -m cocosearch index --help` - shows [config: indexName] [env: COCOSEARCH_INDEX_NAME]
    Run `python -m cocosearch search --help` - shows config/env for relevant flags
  </verify>
  <done>
    - CLI help text shows config key equivalents: [config: X]
    - CLI help text shows env var equivalents: [env: COCOSEARCH_X_Y]
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate ConfigResolver into commands</name>
  <files>src/cocosearch/cli.py</files>
  <action>
    Wire ConfigResolver into index_command and search_command for precedence resolution.

    1. Import ConfigResolver: `from cocosearch.config import ConfigResolver`

    2. Update index_command:
       ```python
       # Create resolver with loaded config
       resolver = ConfigResolver(project_config, config_path)

       # Resolve index name with CLI > env > config > default precedence
       index_name, index_source = resolver.resolve(
           "indexName",
           cli_value=args.name,
           env_var="COCOSEARCH_INDEX_NAME"
       )
       if not index_name:
           index_name = derive_index_name(codebase_path)

       # Show source in verbose mode (when config loaded)
       if index_source != "default" and index_source != "CLI flag":
           console.print(f"[dim]Using index name: {index_name} ({index_source})[/dim]")
       ```

    3. Update search_command similarly:
       - Resolve limit, min_score via ConfigResolver
       - Apply resolved values to search() call

    4. Keep existing behavior: if value is None after resolution, fall back to derive_index_name or defaults.

    5. Ensure env vars work: test with COCOSEARCH_INDEX_NAME=test-env coco index .
  </action>
  <verify>
    Test precedence:
    1. `COCOSEARCH_INDEX_NAME=from-env python -m cocosearch index . --name from-cli` -> uses "from-cli"
    2. `COCOSEARCH_INDEX_NAME=from-env python -m cocosearch index .` -> uses "from-env"
    3. With cocosearch.yaml having indexName, no env, no CLI -> uses config value
  </verify>
  <done>
    - CLI flag values override env vars
    - Env var values override config file
    - Config file values override defaults
    - Precedence chain is CLI > env > config > default
  </done>
</task>

<task type="auto">
  <name>Task 4: Unit tests for config integration</name>
  <files>tests/unit/test_cli_config_integration.py</files>
  <action>
    Create comprehensive tests for config subcommands and precedence integration.

    1. Test config show command:
       - Returns 0 exit code
       - Output contains expected column headers
       - Shows values with sources

    2. Test config path command:
       - Returns path when config exists
       - Returns "No config file found" when no config

    3. Test help text:
       - Index command help contains [config: indexName]
       - Search command help contains [env: COCOSEARCH_SEARCH_RESULT_LIMIT]

    4. Test precedence in index command (mock environment):
       - CLI overrides env
       - Env overrides config
       - Config overrides default

    Use pytest fixtures to set up temp config files and mock environment variables.
  </action>
  <verify>
    Run: `pytest tests/unit/test_cli_config_integration.py -v`
    All tests pass
  </verify>
  <done>
    - Tests verify config show/path commands work
    - Tests verify help text contains config/env metadata
    - Tests verify precedence chain
  </done>
</task>

</tasks>

<verification>
1. `python -m cocosearch config show` - displays table
2. `python -m cocosearch config path` - shows path or "not found"
3. `python -m cocosearch index --help | grep -q "config:"` - shows config equivalents
4. `COCOSEARCH_INDEX_NAME=test python -m cocosearch index . --name cli-override` - uses cli-override
5. `pytest tests/unit/test_cli_config_integration.py -v` - all tests pass
</verification>

<success_criteria>
- `coco config show` displays Rich Table with KEY, VALUE, SOURCE columns
- `coco config path` shows config file location or "No config file found"
- CLI help text shows [config: X] [env: COCOSEARCH_X] for relevant flags
- CLI flag > env var > config file > default precedence works
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-cli-config-integration/16-02-SUMMARY.md`
</output>
