---
phase: 25-auto-detect
plan: 03
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - src/cocosearch/cli.py
  - src/cocosearch/management/clear.py
autonomous: true

must_haves:
  truths:
    - "CLI index command registers path-to-index mapping after successful indexing"
    - "CLI clear command removes path metadata when deleting index"
    - "Path registration detects collisions at index time with clear guidance"
  artifacts:
    - path: "src/cocosearch/cli.py"
      provides: "CLI with path registration on index"
      contains: "register_index_path"
    - path: "src/cocosearch/management/clear.py"
      provides: "Clear command with metadata cleanup"
      contains: "clear_index_path"
  key_links:
    - from: "src/cocosearch/cli.py"
      to: "src/cocosearch/management/metadata.py"
      via: "import register_index_path"
      pattern: "from cocosearch.management import.*register_index_path"
    - from: "src/cocosearch/management/clear.py"
      to: "src/cocosearch/management/metadata.py"
      via: "import clear_index_path"
      pattern: "from.*import.*clear_index_path"
---

<objective>
Integrate path registration into CLI indexing flow and metadata cleanup into clear operations, ensuring both CLI and MCP paths maintain consistent metadata.

Purpose: Maintain accurate path-to-index mappings for collision detection by registering paths during indexing and cleaning up during deletion, regardless of whether users use CLI or MCP.

Output: Updated CLI index_command with path registration, updated clear module with metadata cleanup.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-auto-detect/25-CONTEXT.md
@.planning/phases/25-auto-detect/25-01-SUMMARY.md
@src/cocosearch/cli.py
@src/cocosearch/management/clear.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add path registration to CLI index command</name>
  <files>src/cocosearch/cli.py</files>
  <action>
Update `src/cocosearch/cli.py` to register path-to-index mapping after successful indexing:

1. Add import near top with other management imports:
```python
from cocosearch.management import clear_index, derive_index_from_git, get_stats, list_indexes
# Add after existing line:
from cocosearch.management import register_index_path
```

2. In index_command function, after successful indexing (after `progress.complete(stats)`), add path registration:

```python
def index_command(args: argparse.Namespace) -> int:
    # ... existing code up to progress.complete(stats) ...

    # Run indexing with progress display
    try:
        with IndexingProgress(console) as progress:
            progress.start_indexing(codebase_path)

            # Run the indexing flow
            update_info = run_index(
                index_name=index_name,
                codebase_path=codebase_path,
                config=config,
                respect_gitignore=not args.no_gitignore,
            )

            # Extract stats from update_info
            stats = {
                "files_added": 0,
                "files_removed": 0,
                "files_updated": 0,
            }

            if hasattr(update_info, "stats") and isinstance(update_info.stats, dict):
                file_stats = update_info.stats.get("files", {})
                stats["files_added"] = file_stats.get("num_insertions", 0)
                stats["files_removed"] = file_stats.get("num_deletions", 0)
                stats["files_updated"] = file_stats.get("num_updates", 0)

            progress.complete(stats)

        # Register path-to-index mapping for collision detection
        try:
            register_index_path(index_name, codebase_path)
        except ValueError as collision_error:
            # Collision detected - show warning but indexing already succeeded
            console.print(f"[bold yellow]Warning:[/bold yellow] {collision_error}")
            console.print("[dim]Index was created but path mapping was not updated.[/dim]")

        return 0

    except Exception as e:
        console.print(f"[bold red]Error:[/bold red] Indexing failed: {e}")
        return 1
```

The collision warning is shown as yellow warning (not error) because:
- The index was successfully created
- User should be informed of the collision
- They can still use the index with explicit --index flag
- The warning message from register_index_path includes resolution steps
  </action>
  <verify>
```bash
# Verify CLI syntax and import
python -c "
import inspect
from cocosearch import cli

# Check register_index_path is imported
assert hasattr(cli, 'register_index_path') or 'register_index_path' in dir(cli) or 'from cocosearch.management import register_index_path' in inspect.getsource(cli)
print('Import check requires source inspection...')

# Check index_command source
source = inspect.getsource(cli.index_command)
assert 'register_index_path' in source, 'index_command should call register_index_path'
assert 'collision' in source.lower() or 'ValueError' in source, 'index_command should handle collision'
print('Path registration in index_command: OK')

print('CLI index command updates verified')
"
```
  </verify>
  <done>
- CLI index command imports register_index_path
- Path registration happens after successful indexing
- Collision errors are caught and displayed as warnings
- Warning includes resolution guidance from the exception message
  </done>
</task>

<task type="auto">
  <name>Task 2: Add metadata cleanup to clear operations</name>
  <files>src/cocosearch/management/clear.py</files>
  <action>
Update `src/cocosearch/management/clear.py` to clear path metadata when deleting an index:

1. Read current clear.py to understand its structure

2. Add import for clear_index_path:
```python
from cocosearch.management.metadata import clear_index_path
```

3. In the clear_index function, after successfully dropping tables, also clear metadata:

```python
def clear_index(index_name: str) -> dict:
    """Clear (delete) a code index.

    Removes all data associated with the named index including:
    - The CocoIndex storage tables
    - The path-to-index metadata mapping

    Args:
        index_name: Name of the index to delete.

    Returns:
        Dict with success status and details.

    Raises:
        ValueError: If the index does not exist.
    """
    # ... existing table dropping logic ...

    # After successful table drop, also clear metadata
    try:
        from cocosearch.management.metadata import clear_index_path
        clear_index_path(index_name)
    except Exception as e:
        # Log but don't fail - primary operation (table drop) succeeded
        import logging
        logging.getLogger(__name__).warning(f"Failed to clear path metadata: {e}")

    return {"success": True, ...}
```

Note: Import inside function to avoid potential circular import issues during module initialization.

The metadata cleanup is non-critical:
- If it fails, the main index tables are already gone
- Orphaned metadata entries don't cause problems (will be overwritten on next index)
- Log warning for debugging but don't fail the operation
  </action>
  <verify>
```bash
# Verify clear.py updates
python -c "
import inspect
from cocosearch.management import clear

# Check clear_index source
source = inspect.getsource(clear.clear_index)
assert 'clear_index_path' in source, 'clear_index should call clear_index_path'
print('Metadata cleanup in clear_index: OK')

# Verify function is callable
from cocosearch.management import clear_index
assert callable(clear_index)
print('clear_index is callable: OK')

print('Clear module updates verified')
"
```
  </verify>
  <done>
- clear.py imports clear_index_path (inside function to avoid circular imports)
- clear_index calls clear_index_path after dropping tables
- Metadata cleanup errors are logged but don't fail the operation
- Both CLI and MCP clear paths go through this function
  </done>
</task>

</tasks>

<verification>
1. CLI index command includes path registration
2. Clear module includes metadata cleanup
3. Both modules import without errors
4. Path registration handles collisions gracefully
5. Metadata cleanup doesn't break clear operation on failure
</verification>

<success_criteria>
- `cocosearch index /path` registers path-to-index mapping
- Collision during CLI indexing shows yellow warning with guidance
- `cocosearch clear index_name` removes path metadata
- Metadata cleanup failure doesn't prevent index deletion
- All paths (CLI and MCP) maintain consistent metadata
</success_criteria>

<output>
After completion, create `.planning/phases/25-auto-detect/25-03-SUMMARY.md`
</output>
