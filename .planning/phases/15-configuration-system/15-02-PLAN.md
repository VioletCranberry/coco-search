---
phase: 15-configuration-system
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/cocosearch/config/errors.py
  - src/cocosearch/config/loader.py
  - src/cocosearch/config/__init__.py
  - tests/unit/config/test_errors.py
autonomous: true

must_haves:
  truths:
    - "Unknown fields produce 'Did you mean X?' suggestions"
    - "All validation errors reported at once, not just first"
    - "Error messages include field path for nested errors"
    - "Type errors show expected vs actual type"
  artifacts:
    - path: "src/cocosearch/config/errors.py"
      provides: "Error formatting with typo suggestions"
      exports: ["format_validation_errors", "suggest_field_name"]
    - path: "tests/unit/config/test_errors.py"
      provides: "Error formatting tests"
      min_lines: 50
  key_links:
    - from: "src/cocosearch/config/errors.py"
      to: "difflib"
      via: "stdlib import"
      pattern: "from difflib import get_close_matches"
---

<objective>
Implement validation error formatting with typo suggestions and all-at-once error reporting.

Purpose: Provide users with actionable error messages when config is invalid.
Output: Error formatting module with typo detection via difflib and comprehensive error messages.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-configuration-system/15-RESEARCH.md
@.planning/phases/15-configuration-system/15-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error formatting module with typo suggestions</name>
  <files>
    src/cocosearch/config/errors.py
    src/cocosearch/config/__init__.py
  </files>
  <action>
Create errors.py with:

1. **VALID_FIELDS** constant dict mapping section names to valid field lists:
   ```python
   VALID_FIELDS = {
       "root": ["indexName", "indexing", "search", "embedding"],
       "indexing": ["includePatterns", "excludePatterns", "languages", "chunkSize", "chunkOverlap"],
       "search": ["resultLimit", "minScore"],
       "embedding": ["model"],
   }
   ```

2. **suggest_field_name(unknown: str, section: str = "root") -> str | None**:
   - Get valid fields for the section from VALID_FIELDS
   - Use `difflib.get_close_matches(unknown, valid_fields, n=1, cutoff=0.6)`
   - Return first match or None

3. **format_validation_errors(exc: ValidationError, config_path: Path | None = None) -> str**:
   - Build error message header: "Configuration errors in {path}:" or "Configuration errors:"
   - For each error in exc.errors():
     - Build field path from error["loc"] (e.g., "indexing.chunkSize")
     - Get error message from error["msg"]
     - Get error type from error["type"]
     - If type is "extra_forbidden":
       - Extract field name from loc
       - Determine section (parent in loc or "root")
       - Call suggest_field_name for suggestion
       - Format: "  - {path}: Unknown field. Did you mean '{suggestion}'?" or "  - {path}: Unknown field"
     - If type is "int_type" or "string_type" or similar type errors:
       - Format: "  - {path}: Expected {expected_type}, got {actual_type}"
     - For other errors:
       - Format: "  - {path}: {msg}"
   - Join all error lines with newlines

4. Update __init__.py to export: `format_validation_errors`, `suggest_field_name`
  </action>
  <verify>
python -c "
from pydantic import ValidationError
from cocosearch.config.schema import CocoSearchConfig
from cocosearch.config.errors import format_validation_errors

try:
    CocoSearchConfig.model_validate({'indxName': 'test', 'indexing': {'chunkSze': 100}})
except ValidationError as e:
    print(format_validation_errors(e))
"
  </verify>
  <done>
Error formatter produces multi-line output with typo suggestions for unknown fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate error formatting into loader</name>
  <files>
    src/cocosearch/config/loader.py
  </files>
  <action>
Update loader.py to use the error formatter:

1. Import format_validation_errors from errors module
2. In load_config(), when catching ValidationError:
   - Call format_validation_errors(exc, path) to get formatted message
   - Raise ConfigError(formatted_message) from exc

This integrates Plan 02's error formatting into Plan 01's loader.
The loader.py must import from errors.py (handle circular import by importing inside function if needed, but prefer top-level import since errors.py doesn't import from loader.py).
  </action>
  <verify>
python -c "
from cocosearch.config import load_config, ConfigError
from pathlib import Path
import tempfile

with tempfile.NamedTemporaryFile(mode='w', suffix='.yaml', delete=False) as f:
    f.write('indxName: test\nindexing:\n  chunkSze: 100')
    f.flush()
    try:
        load_config(Path(f.name))
    except ConfigError as e:
        print(str(e))
"
  </verify>
  <done>
load_config raises ConfigError with formatted message including typo suggestions
  </done>
</task>

<task type="auto">
  <name>Task 3: Unit tests for error formatting</name>
  <files>
    tests/unit/config/test_errors.py
  </files>
  <action>
Create test_errors.py with:

1. **test_suggest_field_name_finds_close_match**:
   - "indxName" -> "indexName"
   - "chunkSze" -> "chunkSize"
   - "resultLimt" -> "resultLimit"

2. **test_suggest_field_name_returns_none_for_no_match**:
   - "xyzabc123" -> None

3. **test_suggest_field_name_uses_correct_section**:
   - "mdel" in "embedding" section -> "model"
   - "mdel" in "root" section -> None (no close match in root)

4. **test_format_validation_errors_unknown_field_with_suggestion**:
   - Create ValidationError for unknown field "indxName"
   - Verify output contains "Did you mean 'indexName'?"

5. **test_format_validation_errors_unknown_field_no_suggestion**:
   - Create ValidationError for unknown field "xyzabc"
   - Verify output contains "Unknown field" but no "Did you mean"

6. **test_format_validation_errors_type_error**:
   - Create ValidationError for chunkSize: "not a number"
   - Verify output mentions type mismatch

7. **test_format_validation_errors_multiple_errors**:
   - Create ValidationError with 3 different errors
   - Verify all three appear in output

8. **test_format_validation_errors_nested_path**:
   - Create ValidationError for indexing.chunkSize
   - Verify output shows "indexing.chunkSize" path

9. **test_format_validation_errors_includes_config_path**:
   - Pass config_path to format_validation_errors
   - Verify path appears in header
  </action>
  <verify>
pytest tests/unit/config/test_errors.py -v
  </verify>
  <done>
All error formatting tests pass, covering suggestions, multiple errors, and nested paths
  </done>
</task>

</tasks>

<verification>
1. `python -c "from cocosearch.config import format_validation_errors, suggest_field_name"` succeeds
2. `pytest tests/unit/config/test_errors.py -v` passes all tests
3. Typo suggestion works: `suggest_field_name("indxName")` returns "indexName"
4. Integration works: load_config with invalid config raises ConfigError with suggestions
</verification>

<success_criteria>
- Unknown fields produce typo suggestions when close match exists (CONF-08)
- All validation errors reported at once (CONF-08)
- Error messages include field paths for nested errors
- Type errors clearly state expected vs actual type
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-configuration-system/15-02-SUMMARY.md`
</output>
