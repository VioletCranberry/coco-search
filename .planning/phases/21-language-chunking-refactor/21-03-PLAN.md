---
phase: 21-language-chunking-refactor
plan: 03
type: execute
wave: 3
depends_on: ["21-02"]
files_modified:
  - src/cocosearch/indexer/flow.py
  - src/cocosearch/indexer/languages.py
  - src/cocosearch/indexer/metadata.py
autonomous: true

must_haves:
  truths:
    - "flow.py imports DEVOPS_CUSTOM_LANGUAGES from handlers package"
    - "flow.py imports extract_devops_metadata from handlers package"
    - "Indexing behavior unchanged (same chunking, same metadata)"
    - "Old languages.py redirects to handlers for backward compatibility"
    - "Old metadata.py redirects to handlers for backward compatibility"
  artifacts:
    - path: "src/cocosearch/indexer/flow.py"
      provides: "Updated imports from handlers"
      contains: "from cocosearch.handlers"
    - path: "src/cocosearch/indexer/languages.py"
      provides: "Backward-compatible re-exports"
      contains: "from cocosearch.handlers"
    - path: "src/cocosearch/indexer/metadata.py"
      provides: "Backward-compatible re-exports"
      contains: "from cocosearch.handlers"
  key_links:
    - from: "src/cocosearch/indexer/flow.py"
      to: "src/cocosearch/handlers/__init__.py"
      via: "import statement"
      pattern: "from cocosearch\\.handlers import"
---

<objective>
Integrate the new handlers package into the indexing flow and create backward-compatible re-exports.

Purpose: Make flow.py use the new registry-based handlers while preserving external API.
Output: Updated flow.py using handlers, backward-compatible languages.py and metadata.py.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/21-language-chunking-refactor/21-CONTEXT.md
@.planning/phases/21-language-chunking-refactor/21-02-SUMMARY.md

# Files to update
@src/cocosearch/indexer/flow.py
@src/cocosearch/indexer/languages.py
@src/cocosearch/indexer/metadata.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update flow.py to use handlers package</name>
  <files>src/cocosearch/indexer/flow.py</files>
  <action>
    Update flow.py imports and usage:

    1. **Change imports**:
       - OLD: `from cocosearch.indexer.languages import DEVOPS_CUSTOM_LANGUAGES`
       - NEW: `from cocosearch.handlers import get_custom_languages`

       - OLD: `from cocosearch.indexer.metadata import extract_devops_metadata`
       - NEW: `from cocosearch.handlers import extract_devops_metadata`

    2. **Update SplitRecursively call** (around line 67-73):
       - OLD: `custom_languages=DEVOPS_CUSTOM_LANGUAGES`
       - NEW: `custom_languages=get_custom_languages()`

       The get_custom_languages() function returns list[CustomLanguageSpec] from all
       registered handlers, dynamically discovered.

    3. **Keep extract_devops_metadata usage unchanged**:
       The handlers package re-exports the CocoIndex-decorated function.

    Note: The handlers package __init__.py must export:
       - get_custom_languages() -> list[CustomLanguageSpec]
       - extract_devops_metadata (the @cocoindex.op.function decorated function)
  </action>
  <verify>
    ```bash
    # Check imports work
    python -c "
    from cocosearch.indexer.flow import create_code_index_flow
    print('flow.py imports OK')
    "

    # Verify get_custom_languages returns same specs
    python -c "
    from cocosearch.handlers import get_custom_languages
    langs = get_custom_languages()
    names = [l.language_name for l in langs]
    assert 'hcl' in names
    assert 'dockerfile' in names
    assert 'bash' in names
    print(f'Custom languages: {names}')
    "
    ```
  </verify>
  <done>
    flow.py uses handlers package for custom languages and metadata extraction.
    Behavior unchanged - same chunking specs, same metadata extraction.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create backward-compatible re-exports in old modules</name>
  <files>src/cocosearch/indexer/languages.py, src/cocosearch/indexer/metadata.py</files>
  <action>
    **languages.py** - Replace with re-exports:

    ```python
    """Backward-compatible re-exports from cocosearch.handlers.

    DEPRECATED: Import directly from cocosearch.handlers instead.
    This module is retained for backward compatibility only.
    """

    import warnings

    from cocosearch.handlers import get_custom_languages
    from cocosearch.handlers.hcl import HclHandler
    from cocosearch.handlers.dockerfile import DockerfileHandler
    from cocosearch.handlers.bash import BashHandler

    # Re-export individual language specs for backward compatibility
    HCL_LANGUAGE = HclHandler.SEPARATOR_SPEC
    DOCKERFILE_LANGUAGE = DockerfileHandler.SEPARATOR_SPEC
    BASH_LANGUAGE = BashHandler.SEPARATOR_SPEC

    # Re-export aggregated list
    DEVOPS_CUSTOM_LANGUAGES = get_custom_languages()

    __all__ = [
        "HCL_LANGUAGE",
        "DOCKERFILE_LANGUAGE",
        "BASH_LANGUAGE",
        "DEVOPS_CUSTOM_LANGUAGES",
    ]
    ```

    **metadata.py** - Replace with re-exports:

    ```python
    """Backward-compatible re-exports from cocosearch.handlers.

    DEPRECATED: Import directly from cocosearch.handlers instead.
    This module is retained for backward compatibility only.
    """

    from cocosearch.handlers import extract_devops_metadata
    from cocosearch.handlers.hcl import HclHandler
    from cocosearch.handlers.dockerfile import DockerfileHandler
    from cocosearch.handlers.bash import BashHandler

    # Re-export the metadata dataclass
    from dataclasses import dataclass

    @dataclass
    class DevOpsMetadata:
        """Backward-compatible metadata class."""
        block_type: str
        hierarchy: str
        language_id: str

    # Re-export extraction functions
    def extract_hcl_metadata(text: str) -> DevOpsMetadata:
        m = HclHandler().extract_metadata(text)
        return DevOpsMetadata(**m)

    def extract_dockerfile_metadata(text: str) -> DevOpsMetadata:
        m = DockerfileHandler().extract_metadata(text)
        return DevOpsMetadata(**m)

    def extract_bash_metadata(text: str) -> DevOpsMetadata:
        m = BashHandler().extract_metadata(text)
        return DevOpsMetadata(**m)

    # Re-export internal patterns for tests (they import these)
    _HCL_COMMENT_LINE = HclHandler._HCL_COMMENT_LINE
    _DOCKERFILE_COMMENT_LINE = DockerfileHandler._DOCKERFILE_COMMENT_LINE
    _BASH_COMMENT_LINE = BashHandler._BASH_COMMENT_LINE
    _LANGUAGE_DISPATCH = {
        "hcl": extract_hcl_metadata,
        "tf": extract_hcl_metadata,
        "tfvars": extract_hcl_metadata,
        "dockerfile": extract_dockerfile_metadata,
        "sh": extract_bash_metadata,
        "bash": extract_bash_metadata,
        "zsh": extract_bash_metadata,
        "shell": extract_bash_metadata,
    }
    _LANGUAGE_ID_MAP = {
        "hcl": "hcl", "tf": "hcl", "tfvars": "hcl",
        "dockerfile": "dockerfile",
        "sh": "bash", "bash": "bash", "zsh": "bash", "shell": "bash",
    }
    _EMPTY_METADATA = DevOpsMetadata(block_type="", hierarchy="", language_id="")

    def _strip_leading_comments(text, pattern):
        # Re-export from HclHandler (they all use the same logic)
        from cocosearch.handlers.hcl import _strip_leading_comments as strip_fn
        return strip_fn(text, pattern)

    __all__ = [
        "DevOpsMetadata",
        "extract_devops_metadata",
        "extract_hcl_metadata",
        "extract_dockerfile_metadata",
        "extract_bash_metadata",
    ]
    ```

    NOTE: The re-exports ensure existing tests continue to work. Internal patterns
    (_HCL_COMMENT_LINE, etc.) are re-exported so tests don't need immediate updates.
  </action>
  <verify>
    ```bash
    # Verify backward-compatible imports work
    python -c "
    from cocosearch.indexer.languages import (
        HCL_LANGUAGE, DOCKERFILE_LANGUAGE, BASH_LANGUAGE, DEVOPS_CUSTOM_LANGUAGES
    )
    print(f'HCL: {HCL_LANGUAGE.language_name}')
    print(f'Dockerfile: {DOCKERFILE_LANGUAGE.language_name}')
    print(f'Bash: {BASH_LANGUAGE.language_name}')
    print(f'Total: {len(DEVOPS_CUSTOM_LANGUAGES)} languages')
    "

    python -c "
    from cocosearch.indexer.metadata import (
        DevOpsMetadata, extract_hcl_metadata, extract_dockerfile_metadata
    )
    m = extract_hcl_metadata('resource \"type\" \"name\" {')
    assert m.block_type == 'resource'
    print('metadata.py re-exports OK')
    "
    ```
  </verify>
  <done>
    languages.py re-exports from handlers for backward compatibility.
    metadata.py re-exports from handlers for backward compatibility.
    Existing imports continue to work unchanged.
  </done>
</task>

</tasks>

<verification>
Run from project root:

```bash
# Run existing unit tests to verify no regression
pytest tests/unit/indexer/test_languages.py tests/unit/indexer/test_metadata.py -v

# Verify flow works with handlers
python -c "
from cocosearch.indexer.flow import create_code_index_flow
print('flow.py works with handlers')
"
```
</verification>

<success_criteria>
1. flow.py imports from cocosearch.handlers
2. languages.py re-exports DEVOPS_CUSTOM_LANGUAGES from handlers
3. metadata.py re-exports extraction functions from handlers
4. Existing tests pass without modification (backward compatibility)
5. Indexing behavior unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/21-language-chunking-refactor/21-03-SUMMARY.md`
</output>
