---
phase: 21-language-chunking-refactor
plan: 04
type: execute
wave: 3
depends_on: ["21-02"]
files_modified:
  - tests/unit/handlers/__init__.py
  - tests/unit/handlers/test_hcl.py
  - tests/unit/handlers/test_dockerfile.py
  - tests/unit/handlers/test_bash.py
  - tests/unit/handlers/test_registry.py
  - src/cocosearch/handlers/README.md
autonomous: true

must_haves:
  truths:
    - "Each language handler has dedicated test file in tests/unit/handlers/"
    - "Registry autodiscovery has dedicated test coverage"
    - "handlers/README.md documents extension workflow"
  artifacts:
    - path: "tests/unit/handlers/test_hcl.py"
      provides: "HclHandler unit tests"
      contains: "class TestHclHandler"
    - path: "tests/unit/handlers/test_dockerfile.py"
      provides: "DockerfileHandler unit tests"
      contains: "class TestDockerfileHandler"
    - path: "tests/unit/handlers/test_bash.py"
      provides: "BashHandler unit tests"
      contains: "class TestBashHandler"
    - path: "tests/unit/handlers/test_registry.py"
      provides: "Registry autodiscovery tests"
      contains: "test_.*discover"
    - path: "src/cocosearch/handlers/README.md"
      provides: "Extension workflow documentation"
      contains: "## Adding a New Language"
  key_links:
    - from: "tests/unit/handlers/test_registry.py"
      to: "src/cocosearch/handlers/__init__.py"
      via: "import get_handler, get_custom_languages"
      pattern: "from cocosearch\\.handlers import"
---

<objective>
Create handler-specific tests and extension documentation.

Purpose: Ensure handler modules have proper test coverage and developers can easily add new languages.
Output: Test files for each handler, registry tests, and README.md documentation.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/21-language-chunking-refactor/21-CONTEXT.md
@.planning/phases/21-language-chunking-refactor/21-02-SUMMARY.md

# Existing test patterns to follow
@tests/unit/indexer/test_languages.py
@tests/unit/indexer/test_metadata.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create handler unit tests</name>
  <files>tests/unit/handlers/__init__.py, tests/unit/handlers/test_hcl.py, tests/unit/handlers/test_dockerfile.py, tests/unit/handlers/test_bash.py</files>
  <action>
    Create tests/unit/handlers/ directory and test files following existing patterns from
    tests/unit/indexer/test_languages.py and test_metadata.py.

    **tests/unit/handlers/__init__.py** - Empty file for package.

    **tests/unit/handlers/test_hcl.py**:
    - Test EXTENSIONS contains ['.tf', '.hcl', '.tfvars'] (or without dots per implementation)
    - Test SEPARATOR_SPEC.language_name == "hcl"
    - Test SEPARATOR_SPEC.aliases == ["tf", "tfvars"]
    - Test separator contains all 12 HCL keywords (from test_languages.py)
    - Test no lookaheads in separators (from test_languages.py)
    - Test extract_metadata for resource, data, module, variable, output, etc.
    - Test extract_metadata with leading comments
    - Test extract_metadata with unrecognized content returns empty

    **tests/unit/handlers/test_dockerfile.py**:
    - Test EXTENSIONS contains "dockerfile"
    - Test SEPARATOR_SPEC.language_name == "dockerfile"
    - Test FROM separator higher priority than other instructions
    - Test extract_metadata for FROM with AS (stage hierarchy)
    - Test extract_metadata for FROM without AS (image hierarchy)
    - Test extract_metadata for RUN, COPY, ENV (empty hierarchy)
    - Test extract_metadata with leading comments

    **tests/unit/handlers/test_bash.py**:
    - Test EXTENSIONS contains ["sh", "bash", "zsh", "shell"]
    - Test SEPARATOR_SPEC.language_name == "bash"
    - Test function keyword is Level 1 separator
    - Test extract_metadata for POSIX function syntax
    - Test extract_metadata for ksh function syntax
    - Test extract_metadata for hybrid function syntax
    - Test extract_metadata for non-function content

    All test classes should use pytest markers: @pytest.mark.unit
  </action>
  <verify>
    ```bash
    pytest tests/unit/handlers/ -v --collect-only
    pytest tests/unit/handlers/test_hcl.py -v
    pytest tests/unit/handlers/test_dockerfile.py -v
    pytest tests/unit/handlers/test_bash.py -v
    ```
  </verify>
  <done>
    Each handler has comprehensive unit tests matching existing test patterns.
    Tests cover EXTENSIONS, SEPARATOR_SPEC, and extract_metadata.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create registry tests and documentation</name>
  <files>tests/unit/handlers/test_registry.py, src/cocosearch/handlers/README.md</files>
  <action>
    **tests/unit/handlers/test_registry.py**:

    Test registry autodiscovery and public API:
    - test_discover_finds_all_handlers: _HANDLER_REGISTRY has 3+ handlers
    - test_get_handler_hcl: get_handler('tf') returns HclHandler
    - test_get_handler_dockerfile: get_handler('dockerfile') returns DockerfileHandler
    - test_get_handler_bash: get_handler('sh') returns BashHandler
    - test_get_handler_unknown_returns_text: get_handler('unknown') returns TextHandler
    - test_get_custom_languages_returns_all_specs: len(get_custom_languages()) == 3
    - test_template_excluded_from_discovery: '_template' not in registered extensions
    - test_text_handler_not_in_registry: TextHandler has empty EXTENSIONS, used as fallback

    **src/cocosearch/handlers/README.md**:

    Document the extension workflow:

    ```markdown
    # Language Handlers

    This package provides language-aware chunking for code indexing.

    ## Architecture

    - Each language has a dedicated handler module (e.g., `hcl.py`, `dockerfile.py`)
    - Handlers implement the `LanguageHandler` protocol
    - Registry autodiscovers handlers at import time
    - Unknown extensions fall back to TextHandler

    ## Adding a New Language

    1. Copy `_template.py` to `<language>.py`
    2. Update EXTENSIONS list with file extensions (without dots)
    3. Define SEPARATOR_SPEC with CustomLanguageSpec
    4. Implement extract_metadata() returning dict with:
       - block_type: str
       - hierarchy: str
       - language_id: str
    5. Create `tests/unit/handlers/test_<language>.py`
    6. Run tests: `pytest tests/unit/handlers/test_<language>.py -v`

    ## Handler Interface

    Handlers implement the LanguageHandler protocol:

    - `EXTENSIONS: list[str]` - File extensions this handler claims
    - `SEPARATOR_SPEC: CustomLanguageSpec` - CocoIndex chunking configuration
    - `extract_metadata(text: str) -> dict` - Extract metadata from chunk

    ## Testing

    Each handler must have a corresponding test file. Run all handler tests:

    ```bash
    pytest tests/unit/handlers/ -v
    ```

    ## Existing Handlers

    | Handler | Extensions | Language |
    |---------|------------|----------|
    | HclHandler | tf, hcl, tfvars | HCL/Terraform |
    | DockerfileHandler | dockerfile | Dockerfile |
    | BashHandler | sh, bash, zsh, shell | Bash/Shell |
    | TextHandler | (fallback) | Plain text |
    ```
  </action>
  <verify>
    ```bash
    pytest tests/unit/handlers/test_registry.py -v
    cat src/cocosearch/handlers/README.md
    ```
  </verify>
  <done>
    Registry has comprehensive test coverage.
    README.md documents extension workflow for developers.
  </done>
</task>

</tasks>

<verification>
Run from project root:

```bash
# Run all handler tests
pytest tests/unit/handlers/ -v

# Verify all tests pass
pytest tests/unit/handlers/ -v --tb=short

# Check documentation exists
ls -la src/cocosearch/handlers/README.md
```
</verification>

<success_criteria>
1. tests/unit/handlers/ directory exists with test files
2. test_hcl.py covers HclHandler EXTENSIONS, SEPARATOR_SPEC, extract_metadata
3. test_dockerfile.py covers DockerfileHandler
4. test_bash.py covers BashHandler
5. test_registry.py covers autodiscovery and get_handler
6. handlers/README.md documents adding new languages
7. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/21-language-chunking-refactor/21-04-SUMMARY.md`
</output>
