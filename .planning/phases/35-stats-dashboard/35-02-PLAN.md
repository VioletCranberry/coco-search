---
phase: 35-stats-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified:
  - src/cocosearch/mcp/server.py
  - src/cocosearch/dashboard/__init__.py
  - src/cocosearch/dashboard/terminal.py
  - src/cocosearch/cli.py
autonomous: true

must_haves:
  truths:
    - "HTTP API serves stats at /api/stats endpoint"
    - "API returns JSON matching IndexStats structure"
    - "Terminal dashboard shows live stats with multi-pane layout"
    - "Terminal dashboard displays Unicode bar charts"
    - "cocosearch stats --live shows terminal dashboard"
    - "cocosearch stats --watch enables auto-refresh"
  artifacts:
    - path: "src/cocosearch/mcp/server.py"
      provides: "/api/stats endpoint via @mcp.custom_route"
      contains: "@mcp.custom_route"
    - path: "src/cocosearch/dashboard/terminal.py"
      provides: "Terminal dashboard with Rich Layout"
      contains: "from rich.layout import Layout"
    - path: "src/cocosearch/dashboard/__init__.py"
      provides: "Dashboard module exports"
      contains: "run_terminal_dashboard"
  key_links:
    - from: "src/cocosearch/mcp/server.py"
      to: "src/cocosearch/management/stats.py"
      via: "get_comprehensive_stats import"
      pattern: "get_comprehensive_stats"
    - from: "src/cocosearch/dashboard/terminal.py"
      to: "src/cocosearch/management/stats.py"
      via: "get_comprehensive_stats import"
      pattern: "get_comprehensive_stats"
    - from: "src/cocosearch/cli.py"
      to: "src/cocosearch/dashboard/terminal.py"
      via: "run_terminal_dashboard import"
      pattern: "run_terminal_dashboard"
---

<objective>
Add HTTP API endpoint for stats at /api/stats and create a multi-pane terminal dashboard invoked via `cocosearch stats --live` with optional auto-refresh via `--watch`.

Purpose: Enable programmatic access to stats for web UI and external tools, and provide an htop-style terminal interface for monitoring index health.

Output: /api/stats endpoint in MCP server returning IndexStats JSON; new dashboard/terminal.py module with Rich Layout-based multi-pane dashboard; CLI flags --live and --watch for terminal dashboard.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/35-stats-dashboard/35-CONTEXT.md
@.planning/phases/35-stats-dashboard/35-RESEARCH.md
@.planning/phases/35-stats-dashboard/35-01-SUMMARY.md

@src/cocosearch/mcp/server.py
@src/cocosearch/management/stats.py
@src/cocosearch/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add /api/stats HTTP endpoint to MCP server</name>
  <files>src/cocosearch/mcp/server.py</files>
  <action>
Add HTTP API endpoint for stats using FastMCP custom_route:

1. Import get_comprehensive_stats from management.stats at the top:
   ```python
   from cocosearch.management.stats import get_comprehensive_stats
   ```

2. Add /api/stats endpoint:
   ```python
   @mcp.custom_route("/api/stats", methods=["GET"])
   async def api_stats(request):
       """Stats API endpoint for web dashboard and programmatic access."""
       index_name = request.query_params.get("index")

       if index_name:
           # Single index stats
           try:
               stats = get_comprehensive_stats(index_name)
               return JSONResponse(stats.to_dict())
           except ValueError as e:
               return JSONResponse({"error": str(e)}, status_code=404)
       else:
           # All indexes stats
           indexes = mgmt_list_indexes()
           all_stats = []
           for idx in indexes:
               try:
                   stats = get_comprehensive_stats(idx["name"])
                   all_stats.append(stats.to_dict())
               except ValueError:
                   continue
           return JSONResponse(all_stats)
   ```

3. Add /api/stats/{index_name} endpoint for cleaner URL:
   ```python
   @mcp.custom_route("/api/stats/{index_name}", methods=["GET"])
   async def api_stats_single(request):
       """Stats for a single index by name."""
       index_name = request.path_params["index_name"]
       try:
           stats = get_comprehensive_stats(index_name)
           return JSONResponse(stats.to_dict())
       except ValueError as e:
           return JSONResponse({"error": str(e)}, status_code=404)
   ```

4. Add Cache-Control header to prevent stale data (from RESEARCH.md pitfall):
   ```python
   return JSONResponse(
       stats.to_dict(),
       headers={"Cache-Control": "no-cache, no-store, must-revalidate"}
   )
   ```
  </action>
  <verify>
Start MCP server: `cocosearch mcp --transport sse --port 3001 &`
Then: `curl http://localhost:3001/api/stats`
Expected: JSON array of all index stats

Then: `curl http://localhost:3001/api/stats/cocosearch`
Expected: JSON object with single index stats including languages, symbols, warnings
  </verify>
  <done>
/api/stats endpoint returns JSON array of all indexes. /api/stats/{index_name} returns single index stats. Response includes Cache-Control header.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create terminal dashboard module with Rich Layout</name>
  <files>
src/cocosearch/dashboard/__init__.py
src/cocosearch/dashboard/terminal.py
  </files>
  <action>
Create new dashboard module with terminal UI:

1. Create src/cocosearch/dashboard/__init__.py:
   ```python
   """Dashboard module for cocosearch.

   Provides terminal and web dashboard interfaces for index observability.
   """

   from cocosearch.dashboard.terminal import run_terminal_dashboard

   __all__ = ["run_terminal_dashboard"]
   ```

2. Create src/cocosearch/dashboard/terminal.py with htop-style layout:

   ```python
   """Terminal dashboard for cocosearch.

   Provides Rich-based multi-pane dashboard with live updates.
   """

   import time
   from datetime import datetime

   from rich.bar import Bar
   from rich.console import Console
   from rich.layout import Layout
   from rich.live import Live
   from rich.panel import Panel
   from rich.table import Table

   from cocosearch.management.stats import get_comprehensive_stats, IndexStats
   from cocosearch.management import list_indexes


   def create_layout() -> Layout:
       """Create htop-style multi-pane layout.

       Layout structure:
       +------------------+
       |      header      |
       +--------+---------+
       | summary| details |
       +--------+---------+
       """
       layout = Layout()
       layout.split_column(
           Layout(name="header", size=5),
           Layout(name="body"),
       )
       layout["body"].split_row(
           Layout(name="summary", ratio=1),
           Layout(name="details", ratio=2),
       )
       return layout


   def format_header(stats: IndexStats, last_refresh: datetime) -> Panel:
       """Format header panel with warnings and refresh time."""
       lines = []

       # Warnings first (prominent)
       if stats.warnings:
           for w in stats.warnings:
               lines.append(f"[bold yellow]! {w}[/bold yellow]")
           lines.append("")

       # Title and refresh time
       lines.append(f"[bold]Index: {stats.name}[/bold]  |  Last refresh: {last_refresh.strftime('%H:%M:%S')}")

       return Panel("\n".join(lines), title="[bold]Stats Dashboard[/bold]", border_style="blue")


   def format_summary_panel(stats: IndexStats) -> Panel:
       """Format left summary panel with key metrics."""
       table = Table(show_header=False, box=None, padding=(0, 1))
       table.add_column("Metric", style="dim")
       table.add_column("Value", style="bold")

       table.add_row("Files", f"{stats.file_count:,}")
       table.add_row("Chunks", f"{stats.chunk_count:,}")
       table.add_row("Size", stats.storage_size_pretty)
       table.add_row("", "")

       # Timestamps
       if stats.created_at:
           table.add_row("Created", stats.created_at.strftime("%Y-%m-%d"))
       if stats.updated_at:
           table.add_row("Updated", stats.updated_at.strftime("%Y-%m-%d"))
           table.add_row("", f"({stats.staleness_days}d ago)")

       return Panel(table, title="Summary", border_style="green")


   def format_details_panel(stats: IndexStats) -> Panel:
       """Format right details panel with language and symbol breakdown."""
       # Language distribution with bars
       lang_table = Table(title="Languages", show_header=True, expand=True)
       lang_table.add_column("Lang", style="cyan", width=10)
       lang_table.add_column("Files", justify="right", width=6)
       lang_table.add_column("Chunks", justify="right", width=7)
       lang_table.add_column("Distribution", width=20)

       max_chunks = max((l["chunk_count"] for l in stats.languages), default=1)
       for lang in stats.languages[:10]:  # Top 10
           ratio = lang["chunk_count"] / max_chunks if max_chunks > 0 else 0
           bar = Bar(size=20, begin=0, end=ratio * 20)
           lang_table.add_row(
               lang["language"][:10],
               str(lang["file_count"]),
               str(lang["chunk_count"]),
               bar
           )

       # Symbol distribution (if available)
       if stats.symbols:
           sym_table = Table(title="Symbols", show_header=True, expand=True)
           sym_table.add_column("Type", style="magenta", width=10)
           sym_table.add_column("Count", justify="right", width=8)

           for sym_type, count in sorted(stats.symbols.items(), key=lambda x: -x[1])[:5]:
               sym_table.add_row(sym_type, f"{count:,}")

           # Combine tables vertically
           from rich.console import Group
           content = Group(lang_table, "", sym_table)
       else:
           content = lang_table

       return Panel(content, title="Details", border_style="cyan")


   def run_terminal_dashboard(
       index_name: str,
       watch: bool = False,
       refresh_interval: float = 1.0,
   ) -> None:
       """Run the terminal dashboard.

       Args:
           index_name: Name of the index to display
           watch: If True, auto-refresh stats periodically
           refresh_interval: Seconds between refreshes (default: 1)
       """
       console = Console()
       layout = create_layout()

       # Initial stats fetch
       try:
           stats = get_comprehensive_stats(index_name)
       except ValueError as e:
           console.print(f"[bold red]Error:[/bold red] {e}")
           return

       last_refresh = datetime.now()

       if watch:
           # Live updating mode
           with Live(layout, console=console, refresh_per_second=4, screen=True) as live:
               try:
                   while True:
                       # Update layout
                       layout["header"].update(format_header(stats, last_refresh))
                       layout["summary"].update(format_summary_panel(stats))
                       layout["details"].update(format_details_panel(stats))

                       time.sleep(refresh_interval)

                       # Refresh stats
                       try:
                           stats = get_comprehensive_stats(index_name)
                           last_refresh = datetime.now()
                       except Exception:
                           pass  # Keep showing last good stats

               except KeyboardInterrupt:
                   pass  # Clean exit on Ctrl+C
       else:
           # Static snapshot mode (--live without --watch)
           layout["header"].update(format_header(stats, last_refresh))
           layout["summary"].update(format_summary_panel(stats))
           layout["details"].update(format_details_panel(stats))

           # Display once and return
           console.print(layout)
           console.print("\n[dim]Press Ctrl+C to exit. Use --watch for auto-refresh.[/dim]")
   ```
  </action>
  <verify>
Run: `python -c "from cocosearch.dashboard import run_terminal_dashboard; print('OK')"`
Expected: Prints OK (module imports successfully)
  </verify>
  <done>
Dashboard module exists with run_terminal_dashboard function. Terminal dashboard shows multi-pane layout with header (warnings + refresh time), summary (metrics), and details (languages + symbols with bars).
  </done>
</task>

<task type="auto">
  <name>Task 3: Add --live and --watch flags to CLI stats command</name>
  <files>src/cocosearch/cli.py</files>
  <action>
Enhance stats_parser and stats_command to support terminal dashboard:

1. Add new flags to stats_parser:
   ```python
   stats_parser.add_argument(
       "--live",
       action="store_true",
       help="Show terminal dashboard (multi-pane layout with bar charts)",
   )
   stats_parser.add_argument(
       "--watch",
       action="store_true",
       help="Auto-refresh terminal dashboard (requires --live)",
   )
   stats_parser.add_argument(
       "--refresh-interval",
       type=float,
       default=1.0,
       metavar="SECONDS",
       help="Refresh interval for --watch mode (default: 1.0)",
   )
   ```

2. Update stats_command to handle --live mode:
   ```python
   from cocosearch.dashboard import run_terminal_dashboard

   def stats_command(args: argparse.Namespace) -> int:
       # ... existing initialization ...

       # Determine index for dashboard
       if args.live:
           # Dashboard requires a specific index
           if not args.index:
               # Auto-detect from cwd
               git_index = derive_index_from_git()
               if git_index:
                   index_name = git_index
               else:
                   index_name = derive_index_name(os.getcwd())
           else:
               index_name = args.index

           # Validate index exists before starting dashboard
           try:
               get_stats(index_name)  # Quick validation
           except ValueError as e:
               console.print(f"[bold red]Error:[/bold red] {e}")
               return 1

           # Run terminal dashboard
           run_terminal_dashboard(
               index_name=index_name,
               watch=args.watch,
               refresh_interval=args.refresh_interval,
           )
           return 0

       # ... rest of existing stats_command logic ...
   ```

3. Add validation: --watch requires --live:
   ```python
   if args.watch and not args.live:
       console.print("[bold red]Error:[/bold red] --watch requires --live")
       return 1
   ```
  </action>
  <verify>
Run: `cocosearch stats --help`
Expected: Shows --live, --watch, --refresh-interval flags

Run: `cocosearch stats cocosearch --live` (then Ctrl+C to exit)
Expected: Shows multi-pane dashboard with summary, language bars, and symbol counts
  </verify>
  <done>
`cocosearch stats --live` shows terminal dashboard. `cocosearch stats --live --watch` enables auto-refresh. Dashboard displays correctly and handles Ctrl+C gracefully.
  </done>
</task>

</tasks>

<verification>
1. `curl http://localhost:PORT/api/stats` returns JSON array of all indexes
2. `curl http://localhost:PORT/api/stats/INDEX_NAME` returns single index JSON
3. `cocosearch stats cocosearch --live` shows multi-pane terminal dashboard
4. `cocosearch stats cocosearch --live --watch` auto-refreshes (visible in refresh time)
5. Terminal dashboard shows language distribution bars and symbol counts
6. Ctrl+C cleanly exits the dashboard
</verification>

<success_criteria>
- /api/stats endpoint accessible via MCP server
- API returns IndexStats-compatible JSON structure
- Terminal dashboard displays header with warnings
- Terminal dashboard shows summary panel with metrics
- Terminal dashboard shows details panel with language bars and symbols
- --live flag starts dashboard
- --watch flag enables auto-refresh
- Clean keyboard interrupt handling
</success_criteria>

<output>
After completion, create `.planning/phases/35-stats-dashboard/35-02-SUMMARY.md`
</output>
