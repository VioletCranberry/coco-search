---
phase: 35-stats-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cocosearch/management/stats.py
  - src/cocosearch/cli.py
autonomous: true

must_haves:
  truths:
    - "User sees health metrics (files, chunks, size, last update) when running cocosearch stats"
    - "User sees per-language breakdown with Unicode bar charts"
    - "User sees symbol type counts with -v flag"
    - "User sees staleness warning if index not updated in >7 days"
    - "User gets --json output for automation"
    - "User can view all indexes with --all flag"
  artifacts:
    - path: "src/cocosearch/management/stats.py"
      provides: "IndexStats dataclass, get_comprehensive_stats(), get_symbol_stats(), check_staleness()"
      contains: "class IndexStats"
    - path: "src/cocosearch/cli.py"
      provides: "Enhanced stats_command with -v, --json, --all flags, Unicode bars, warning banner"
      contains: "from rich.bar import Bar"
  key_links:
    - from: "src/cocosearch/cli.py"
      to: "src/cocosearch/management/stats.py"
      via: "get_comprehensive_stats() call"
      pattern: "get_comprehensive_stats"
    - from: "src/cocosearch/management/stats.py"
      to: "cocosearch_index_metadata table"
      via: "updated_at query for staleness"
      pattern: "updated_at"
---

<objective>
Enhance the `cocosearch stats` CLI command with comprehensive health metrics, per-language Unicode bar charts, symbol statistics, staleness warnings, and machine-readable JSON output.

Purpose: Enable users to understand index health at a glance with visual distribution charts and prominent warnings for stale or problematic indexes.

Output: Enhanced stats.py with IndexStats dataclass and comprehensive stats collection; enhanced cli.py with -v, --json, --all flags and Rich-based output with Unicode bars and warning banners.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/35-stats-dashboard/35-CONTEXT.md
@.planning/phases/35-stats-dashboard/35-RESEARCH.md

@src/cocosearch/management/stats.py
@src/cocosearch/management/metadata.py
@src/cocosearch/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IndexStats dataclass and comprehensive stats collection</name>
  <files>src/cocosearch/management/stats.py</files>
  <action>
Enhance stats.py with:

1. Create IndexStats dataclass with all required fields:
   ```python
   @dataclass
   class IndexStats:
       name: str
       file_count: int
       chunk_count: int
       storage_size: int
       storage_size_pretty: str
       created_at: datetime | None
       updated_at: datetime | None
       is_stale: bool
       staleness_days: int
       languages: list[dict]  # from get_language_stats
       symbols: dict[str, int]  # {symbol_type: count}
       warnings: list[str]
   ```

2. Add get_symbol_stats(index_name) function:
   - Query: `SELECT symbol_type, COUNT(*) FROM {table} WHERE symbol_type IS NOT NULL GROUP BY symbol_type ORDER BY COUNT(*) DESC`
   - Check for symbol_type column existence first (graceful degradation for pre-v1.7)
   - Return dict like `{"function": 150, "class": 25, "method": 80}`

3. Add check_staleness(index_name, threshold_days=7) function:
   - Query cocosearch_index_metadata table for updated_at
   - Calculate days since last update
   - Return tuple: (is_stale: bool, days_since_update: int)
   - Handle missing metadata gracefully (return True, -1 if no metadata)

4. Add collect_warnings(index_name) function:
   - Check staleness and add warning: "Index is stale ({N} days since last update)"
   - Query for files with zero chunks (if any): "N files produced zero chunks"
   - Return list of warning strings

5. Add get_comprehensive_stats(index_name) function:
   - Combines get_stats(), get_language_stats(), get_symbol_stats(), check_staleness(), collect_warnings()
   - Returns IndexStats instance
   - Add to_dict() method on IndexStats for JSON serialization

Keep existing get_stats() and get_language_stats() functions unchanged for backward compatibility.
  </action>
  <verify>
Run: `python -c "from cocosearch.management.stats import IndexStats, get_comprehensive_stats; print(IndexStats.__annotations__)"`
Expected: Shows all dataclass fields
  </verify>
  <done>
IndexStats dataclass exists with all fields. get_comprehensive_stats() returns populated IndexStats. check_staleness() returns correct staleness info. get_symbol_stats() returns symbol type counts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance CLI stats command with visual output and new flags</name>
  <files>src/cocosearch/cli.py</files>
  <action>
Enhance stats_command and stats_parser in cli.py:

1. Add new CLI flags to stats_parser:
   - `-v, --verbose`: Show symbol type breakdown
   - `--json`: Output machine-readable JSON (replaces --pretty inversion)
   - `--all`: Show stats for all indexed projects (default: current project via auto-detect)
   - `--staleness-threshold`: Days before staleness warning (default: 7)

2. Update stats_command logic:
   - If no index specified and not --all: auto-detect from cwd (like search command)
   - Import get_comprehensive_stats from management
   - Call get_comprehensive_stats(index_name) instead of get_stats()

3. Add warning banner display (BEFORE stats output):
   ```python
   from rich.panel import Panel

   def print_warnings(warnings: list[str], console: Console) -> None:
       if not warnings:
           return
       warning_text = "\n".join(f"[yellow]! {w}[/yellow]" for w in warnings)
       console.print(Panel(
           warning_text,
           title="[bold yellow]Warnings[/bold yellow]",
           border_style="yellow"
       ))
       console.print()  # Blank line after
   ```

4. Add language distribution with Unicode bars:
   ```python
   from rich.bar import Bar

   def format_language_table(languages: list[dict], console_width: int = 80) -> Table:
       table = Table(title="Language Distribution", show_header=True)
       table.add_column("Language", style="cyan", width=12)
       table.add_column("Files", justify="right", width=6)
       table.add_column("Chunks", justify="right", width=8)
       table.add_column("Distribution", width=30)

       max_chunks = max((l["chunk_count"] for l in languages), default=1)
       for lang in languages:
           ratio = lang["chunk_count"] / max_chunks if max_chunks > 0 else 0
           bar = Bar(size=30, begin=0, end=ratio * 30)
           table.add_row(lang["language"], str(lang["file_count"]), str(lang["chunk_count"]), bar)
       return table
   ```

5. Add symbol statistics display (verbose mode only):
   ```python
   def format_symbol_table(symbols: dict[str, int]) -> Table:
       if not symbols:
           return None
       table = Table(title="Symbol Statistics")
       table.add_column("Type", style="magenta")
       table.add_column("Count", justify="right")
       for sym_type, count in sorted(symbols.items(), key=lambda x: -x[1]):
           table.add_row(sym_type, f"{count:,}")
       return table
   ```

6. Add summary header with timestamps:
   ```python
   # Show: Index: name | Files: N | Chunks: N | Size: X MB
   # Show: Created: YYYY-MM-DD | Last Updated: YYYY-MM-DD (N days ago)
   ```

7. JSON output mode (--json flag):
   - Call stats.to_dict() for single index
   - For --all, return list of dicts
   - Output via json.dumps(output, indent=2, default=str) for datetime serialization

Keep backward compatibility: if only --pretty is passed (no --json), use visual output.
  </action>
  <verify>
Run: `cocosearch stats --help`
Expected: Shows -v, --json, --all, --staleness-threshold flags

Run: `cocosearch stats cocosearch --json`
Expected: JSON output with all fields including languages, symbols, warnings, is_stale
  </verify>
  <done>
`cocosearch stats` shows warning banner (if any), summary header with timestamps, language distribution with Unicode bars. `-v` shows symbol breakdown. `--json` outputs machine-readable format. `--all` shows all indexes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for new stats functionality</name>
  <files>tests/unit/test_stats.py</files>
  <action>
Create or enhance tests/unit/test_stats.py with tests for new stats functionality:

1. Test IndexStats dataclass:
   - Test instantiation with all fields
   - Test to_dict() serialization
   - Test datetime handling in to_dict()

2. Test check_staleness():
   - Mock database query to return various updated_at values
   - Test threshold boundary (7 days exactly)
   - Test missing metadata (returns True, -1)

3. Test get_symbol_stats():
   - Mock database query with symbol counts
   - Test graceful degradation when symbol_type column missing
   - Test empty result handling

4. Test collect_warnings():
   - Test stale index warning generation
   - Test multiple warnings combined

5. Test format_bytes() edge cases (already exists, ensure coverage):
   - 0 bytes
   - Exactly 1 KB, 1 MB, 1 GB boundaries

Use pytest fixtures and mocking patterns consistent with existing test suite.
Mark tests with @pytest.mark.unit.
  </action>
  <verify>
Run: `pytest tests/unit/test_stats.py -v`
Expected: All tests pass
  </verify>
  <done>
Unit tests exist for IndexStats, check_staleness(), get_symbol_stats(), collect_warnings(). All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cocosearch stats cocosearch` shows visual output with:
   - Warning banner (if stale or issues)
   - Summary header with timestamps
   - Language distribution table with Unicode bars
2. `cocosearch stats cocosearch -v` additionally shows symbol type breakdown
3. `cocosearch stats cocosearch --json` outputs machine-readable JSON
4. `cocosearch stats --all` shows stats for all indexes
5. `pytest tests/unit/test_stats.py -v` passes
</verification>

<success_criteria>
- IndexStats dataclass captures all health metrics
- CLI shows prominent warning banner before stats
- Unicode bar charts visualize language distribution
- Symbol stats available in verbose mode
- JSON output includes all fields for automation
- Auto-detect works when no index specified
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/35-stats-dashboard/35-01-SUMMARY.md`
</output>
