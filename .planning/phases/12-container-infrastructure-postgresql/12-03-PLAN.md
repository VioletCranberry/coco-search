---
phase: 12-container-infrastructure-postgresql
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - tests/integration/test_postgresql.py
autonomous: true

must_haves:
  truths:
    - "Integration tests connect to real PostgreSQL container"
    - "Vector similarity search returns correct results with real pgvector"
    - "Database operations (create, read, truncate) work correctly"
  artifacts:
    - path: "tests/integration/test_postgresql.py"
      provides: "PostgreSQL integration tests"
      exports: ["test_pgvector_extension_loaded", "test_vector_similarity_search", "test_table_cleanup_between_tests"]
  key_links:
    - from: "tests/integration/test_postgresql.py"
      to: "tests/fixtures/containers.py"
      via: "fixture injection"
      pattern: "integration_db_pool|initialized_db"
---

<objective>
Create PostgreSQL integration tests validating real pgvector operations.

Purpose: Verify that the container infrastructure works correctly and that vector similarity search produces expected results with real PostgreSQL+pgvector.

Output:
- Integration tests for pgvector extension
- Integration tests for vector similarity search
- Integration tests for table cleanup between tests
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-container-infrastructure-postgresql/12-CONTEXT.md
@.planning/phases/12-container-infrastructure-postgresql/12-RESEARCH.md
@.planning/phases/12-container-infrastructure-postgresql/12-01-SUMMARY.md
@.planning/phases/12-container-infrastructure-postgresql/12-02-SUMMARY.md
@tests/fixtures/containers.py
@src/cocosearch/search/db.py
@src/cocosearch/search/query.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PostgreSQL integration tests</name>
  <files>tests/integration/test_postgresql.py</files>
  <action>
Create tests/integration/test_postgresql.py with tests validating real PostgreSQL+pgvector operations:

```python
"""PostgreSQL integration tests.

Tests validating real PostgreSQL+pgvector behavior:
- pgvector extension loading
- Vector similarity search operations
- Table cleanup between tests
- Connection pool functionality

These tests require Docker and are marked with @pytest.mark.integration.
The marker is auto-applied by tests/integration/conftest.py.
"""

import pytest


class TestPgvectorExtension:
    """Tests for pgvector extension functionality."""

    def test_pgvector_extension_loaded(self, integration_db_pool):
        """Verify pgvector extension is installed and working.

        Requirement: PG-02 (pgvector extension initialized automatically)
        """
        with integration_db_pool.connection() as conn:
            with conn.cursor() as cur:
                # Check extension is installed
                cur.execute("""
                    SELECT extname FROM pg_extension
                    WHERE extname = 'vector'
                """)
                result = cur.fetchone()
                assert result is not None, "pgvector extension not installed"
                assert result[0] == "vector"

    def test_vector_type_available(self, integration_db_pool):
        """Verify vector type can be used in queries.

        Requirement: PG-02 (pgvector extension initialized automatically)
        """
        with integration_db_pool.connection() as conn:
            with conn.cursor() as cur:
                # Create a test table with vector column
                cur.execute("""
                    CREATE TEMPORARY TABLE test_vectors (
                        id SERIAL PRIMARY KEY,
                        embedding vector(3)
                    )
                """)
                # Insert a vector
                cur.execute("""
                    INSERT INTO test_vectors (embedding)
                    VALUES ('[1,2,3]')
                """)
                # Query it back
                cur.execute("SELECT embedding FROM test_vectors")
                result = cur.fetchone()
                assert result is not None
                # pgvector returns numpy array when registered
                import numpy as np
                assert isinstance(result[0], np.ndarray)
                assert list(result[0]) == [1.0, 2.0, 3.0]


class TestVectorSimilaritySearch:
    """Tests for vector similarity search operations."""

    def test_cosine_distance_operator(self, integration_db_pool):
        """Verify cosine distance operator (<=> ) works correctly.

        Requirement: PG-05 (Vector similarity search works correctly)
        """
        with integration_db_pool.connection() as conn:
            with conn.cursor() as cur:
                # Create test table
                cur.execute("""
                    CREATE TEMPORARY TABLE test_search (
                        id SERIAL PRIMARY KEY,
                        content TEXT,
                        embedding vector(3)
                    )
                """)
                # Insert test vectors
                cur.execute("""
                    INSERT INTO test_search (content, embedding) VALUES
                    ('similar', '[1,0,0]'),
                    ('different', '[0,1,0]'),
                    ('orthogonal', '[0,0,1]')
                """)

                # Search for vector similar to [1,0,0]
                cur.execute("""
                    SELECT content, 1 - (embedding <=> '[1,0,0]'::vector) AS score
                    FROM test_search
                    ORDER BY embedding <=> '[1,0,0]'::vector
                    LIMIT 3
                """)
                results = cur.fetchall()

                # First result should be 'similar' with score ~1.0
                assert results[0][0] == "similar"
                assert results[0][1] > 0.99  # cosine similarity ~1.0

                # Other results should have lower scores
                assert results[1][1] < 0.1  # orthogonal vectors
                assert results[2][1] < 0.1

    def test_vector_index_creation(self, integration_db_pool):
        """Verify IVFFlat index can be created for vectors.

        Requirement: PG-05 (Vector similarity search works correctly)
        """
        with integration_db_pool.connection() as conn:
            with conn.cursor() as cur:
                # Create test table
                cur.execute("""
                    CREATE TEMPORARY TABLE test_indexed (
                        id SERIAL PRIMARY KEY,
                        embedding vector(768)
                    )
                """)
                # Create IVFFlat index (used by CocoIndex)
                cur.execute("""
                    CREATE INDEX ON test_indexed
                    USING ivfflat (embedding vector_cosine_ops)
                    WITH (lists = 1)
                """)
                # Verify index was created
                cur.execute("""
                    SELECT indexname FROM pg_indexes
                    WHERE tablename = 'test_indexed'
                    AND indexdef LIKE '%ivfflat%'
                """)
                result = cur.fetchone()
                assert result is not None, "IVFFlat index not created"


class TestTableCleanup:
    """Tests verifying table cleanup between tests."""

    def test_table_creation_first(self, integration_db_pool):
        """Create a persistent table and insert data.

        This test runs first and creates state that should be cleaned up.
        """
        with integration_db_pool.connection() as conn:
            with conn.cursor() as cur:
                # Create a non-temporary table
                cur.execute("""
                    CREATE TABLE IF NOT EXISTS cleanup_test (
                        id SERIAL PRIMARY KEY,
                        data TEXT
                    )
                """)
                cur.execute("INSERT INTO cleanup_test (data) VALUES ('test1')")
            conn.commit()

            # Verify data exists
            with conn.cursor() as cur:
                cur.execute("SELECT COUNT(*) FROM cleanup_test")
                count = cur.fetchone()[0]
                assert count == 1

    def test_table_cleaned_second(self, integration_db_pool):
        """Verify the table from previous test was truncated.

        Requirement: INFRA-04 (Test isolation via database state cleanup)
        Requirement: PG-04 (Database state cleaned between tests)

        The clean_tables fixture should have truncated cleanup_test
        after test_table_creation_first.
        """
        with integration_db_pool.connection() as conn:
            with conn.cursor() as cur:
                # Table should exist but be empty
                cur.execute("""
                    SELECT EXISTS (
                        SELECT FROM pg_tables
                        WHERE tablename = 'cleanup_test'
                    )
                """)
                table_exists = cur.fetchone()[0]

                if table_exists:
                    # If table exists, it should be empty (truncated)
                    cur.execute("SELECT COUNT(*) FROM cleanup_test")
                    count = cur.fetchone()[0]
                    assert count == 0, "Table should be empty after cleanup"


class TestConnectionPool:
    """Tests for connection pool functionality."""

    def test_pool_provides_connections(self, integration_db_pool):
        """Verify pool can provide multiple connections.

        Requirement: INFRA-05 (Session-scoped container fixtures for performance)
        """
        # Get multiple connections from pool
        with integration_db_pool.connection() as conn1:
            with conn1.cursor() as cur:
                cur.execute("SELECT 1")
                assert cur.fetchone()[0] == 1

        with integration_db_pool.connection() as conn2:
            with conn2.cursor() as cur:
                cur.execute("SELECT 2")
                assert cur.fetchone()[0] == 2

    def test_pool_has_pgvector_registered(self, integration_db_pool):
        """Verify pgvector type handler is registered on pool connections.

        Requirement: PG-01 (Integration tests connect to real PostgreSQL+pgvector)
        """
        import numpy as np

        with integration_db_pool.connection() as conn:
            with conn.cursor() as cur:
                # Query a vector literal - should return numpy array
                cur.execute("SELECT '[1,2,3]'::vector")
                result = cur.fetchone()[0]
                assert isinstance(result[0], np.ndarray), \
                    "pgvector type handler not registered"
```

Key implementation notes:
- All tests automatically get @pytest.mark.integration from conftest.py
- Tests validate real pgvector operations, not mocks
- TestTableCleanup tests verify the cleanup fixture works
- Uses integration_db_pool fixture from containers.py
  </action>
  <verify>Run: pytest tests/integration/test_postgresql.py -v -m integration (requires Docker running)</verify>
  <done>PostgreSQL integration tests created validating pgvector operations</done>
</task>

<task type="auto">
  <name>Task 2: Verify all Phase 12 success criteria</name>
  <files>None (verification only)</files>
  <action>
Run the full integration test suite to verify all Phase 12 success criteria:

1. Integration tests connect to real PostgreSQL+pgvector container
   - pytest tests/integration/test_postgresql.py::TestPgvectorExtension -v -m integration

2. Containers start with health checks before tests execute
   - Verify container starts successfully (testcontainers handles health checks)

3. pgvector extension initializes automatically in test database
   - pytest tests/integration/test_postgresql.py::TestPgvectorExtension::test_pgvector_extension_loaded -v -m integration

4. Database state cleans between tests without container recreation
   - pytest tests/integration/test_postgresql.py::TestTableCleanup -v -m integration

5. Vector similarity search returns correct results with real pgvector
   - pytest tests/integration/test_postgresql.py::TestVectorSimilaritySearch -v -m integration

Run all tests:
```bash
pytest tests/integration/test_postgresql.py -v -m integration
```

Expected: All tests pass, demonstrating real PostgreSQL+pgvector integration works.
  </action>
  <verify>All integration tests pass when running pytest tests/integration/test_postgresql.py -v -m integration</verify>
  <done>All Phase 12 success criteria verified through passing integration tests</done>
</task>

</tasks>

<verification>
1. test_postgresql.py exists in tests/integration/
2. All test classes cover Phase 12 requirements (INFRA-*, PG-*)
3. Tests use real PostgreSQL via integration_db_pool fixture
4. Tests validate actual pgvector operations (not mocks)
5. All integration tests pass with Docker running
</verification>

<success_criteria>
- tests/integration/test_postgresql.py created with comprehensive tests
- TestPgvectorExtension validates extension loading and vector type
- TestVectorSimilaritySearch validates cosine distance and index creation
- TestTableCleanup validates TRUNCATE-based isolation works
- All tests pass when running with Docker available
</success_criteria>

<output>
After completion, create `.planning/phases/12-container-infrastructure-postgresql/12-03-SUMMARY.md`
</output>
