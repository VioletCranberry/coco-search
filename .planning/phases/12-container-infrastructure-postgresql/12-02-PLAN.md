---
phase: 12-container-infrastructure-postgresql
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - tests/fixtures/containers.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "pgvector extension is enabled in test database before tests run"
    - "Database tables are truncated between tests without container recreation"
    - "Integration tests can get a connection pool with pgvector support"
  artifacts:
    - path: "tests/fixtures/containers.py"
      provides: "Database initialization and cleanup fixtures"
      exports: ["initialized_db", "clean_tables", "integration_db_pool"]
    - path: "pyproject.toml"
      provides: "testcontainers dependency"
      contains: "testcontainers"
  key_links:
    - from: "tests/fixtures/containers.py:initialized_db"
      to: "tests/fixtures/containers.py:postgres_container"
      via: "fixture dependency"
      pattern: "CREATE EXTENSION.*vector"
    - from: "tests/fixtures/containers.py:clean_tables"
      to: "tests/fixtures/containers.py:initialized_db"
      via: "fixture dependency"
      pattern: "TRUNCATE.*CASCADE"
---

<objective>
Add database initialization with pgvector extension and TRUNCATE-based cleanup between tests.

Purpose: Enable test isolation through database state cleanup while maintaining container reuse for performance.

Output:
- pgvector extension initialization fixture (session-scoped)
- TRUNCATE-based cleanup fixture (function-scoped, autouse)
- Connection pool fixture for integration tests
- testcontainers dependency in pyproject.toml
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-container-infrastructure-postgresql/12-CONTEXT.md
@.planning/phases/12-container-infrastructure-postgresql/12-RESEARCH.md
@.planning/phases/12-container-infrastructure-postgresql/12-01-SUMMARY.md
@tests/fixtures/containers.py
@src/cocosearch/search/db.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add testcontainers dependency to pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
Add testcontainers[postgresql] to dev dependencies in pyproject.toml:

In the [dependency-groups] dev section, add:
```
"testcontainers[postgresql]>=4.14.0",
"docker>=7.0.0",
```

The docker package is needed for the Docker availability check in conftest.py.
testcontainers[postgresql] provides PostgresContainer with automatic cleanup via Ryuk.
  </action>
  <verify>Run: uv sync && python -c "from testcontainers.postgres import PostgresContainer; import docker; print('OK')"</verify>
  <done>testcontainers and docker dependencies added to pyproject.toml</done>
</task>

<task type="auto">
  <name>Task 2: Add database initialization and cleanup fixtures</name>
  <files>tests/fixtures/containers.py</files>
  <action>
Extend tests/fixtures/containers.py with database initialization and cleanup fixtures.

Add these fixtures after the existing postgres_container and test_db_url fixtures:

```python
import psycopg
from psycopg_pool import ConnectionPool
from pgvector.psycopg import register_vector


@pytest.fixture(scope="session")
def initialized_db(test_db_url):
    """Initialize database with pgvector extension.

    Runs once per session after container starts.
    pgvector/pgvector image has extension files installed,
    just need CREATE EXTENSION to enable it.

    Locked decision from CONTEXT.md: "pgvector extension baked into
    container entrypoint — ready before tests connect"
    """
    with psycopg.connect(test_db_url) as conn:
        # Enable pgvector extension (idempotent)
        conn.execute("CREATE EXTENSION IF NOT EXISTS vector")
        conn.commit()

    return test_db_url


@pytest.fixture(autouse=True)
def clean_tables(initialized_db, request):
    """Clean all tables between tests using TRUNCATE CASCADE.

    Locked decision from CONTEXT.md: "TRUNCATE tables between tests —
    fast cleanup, keeps schema"

    CASCADE handles foreign key constraints automatically.
    Only runs for integration tests (checks marker).
    """
    # Only run cleanup for integration tests
    if "integration" not in [m.name for m in request.node.iter_markers()]:
        yield
        return

    yield  # Run test first

    # Cleanup after test
    with psycopg.connect(initialized_db) as conn:
        with conn.cursor() as cur:
            # Get all user tables (exclude system tables)
            cur.execute("""
                SELECT tablename FROM pg_tables
                WHERE schemaname = 'public'
            """)
            tables = [row[0] for row in cur.fetchall()]

            if tables:
                # Quote table names for safety, CASCADE for foreign keys
                quoted = ', '.join(f'"{t}"' for t in tables)
                cur.execute(f"TRUNCATE TABLE {quoted} CASCADE")

        conn.commit()


@pytest.fixture
def integration_db_pool(initialized_db):
    """Provide connection pool with pgvector support for integration tests.

    Function scope: fresh pool per test.
    Registers pgvector type handler for vector operations.
    """
    def configure(conn):
        register_vector(conn)

    pool = ConnectionPool(
        conninfo=initialized_db,
        configure=configure,
        min_size=1,
        max_size=5,
        timeout=10,
    )

    # Wait for min_size connections (catches config errors early)
    pool.wait()

    yield pool

    # Always close to prevent connection leaks
    pool.close()
```

Also add the necessary imports at the top of the file:
- import psycopg
- from psycopg_pool import ConnectionPool
- from pgvector.psycopg import register_vector

These are already project dependencies (psycopg[pool] and pgvector are in pyproject.toml).
  </action>
  <verify>Run: python -c "from tests.fixtures.containers import initialized_db, clean_tables, integration_db_pool; print('OK')"</verify>
  <done>Database initialization and cleanup fixtures added with pgvector support</done>
</task>

</tasks>

<verification>
1. testcontainers[postgresql] and docker dependencies are in pyproject.toml
2. Dependencies install correctly with uv sync
3. initialized_db fixture creates pgvector extension
4. clean_tables fixture has autouse=True and runs TRUNCATE CASCADE
5. integration_db_pool provides ConnectionPool with pgvector registered
6. All fixtures import without errors
</verification>

<success_criteria>
- pyproject.toml includes testcontainers[postgresql]>=4.14.0 and docker>=7.0.0
- initialized_db fixture runs CREATE EXTENSION IF NOT EXISTS vector
- clean_tables fixture (autouse) truncates all public tables with CASCADE
- integration_db_pool fixture provides ConnectionPool with pgvector support
- All imports work without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-container-infrastructure-postgresql/12-02-SUMMARY.md`
</output>
