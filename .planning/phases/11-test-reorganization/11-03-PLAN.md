---
phase: 11-test-reorganization
plan: 03
type: execute
wave: 1
depends_on: ["11-02"]
files_modified: ["pyproject.toml"]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Default pytest run executes only unit tests"
    - "Integration tests run only when explicitly requested"
    - "All 327 unit tests still pass with new default"
  artifacts:
    - path: "pyproject.toml"
      provides: "Default -m unit marker filter in addopts"
      contains: "-m unit"
  key_links:
    - from: "pyproject.toml addopts"
      to: "pytest marker filtering"
      via: "-m unit flag"
      pattern: 'addopts.*-m unit'
---

<objective>
Fix default test execution to run only unit tests by adding `-m unit` to pytest addopts.

Purpose: Close verification gaps ORG-04 and ORG-05 - default test run must execute unit tests only (fast feedback), and integration tests must run only when explicitly requested.

Output: Updated pyproject.toml with default unit-only execution
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-test-reorganization/11-VERIFICATION.md
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add -m unit to pytest addopts</name>
  <files>pyproject.toml</files>
  <action>
    Update pyproject.toml [tool.pytest.ini_options] section:

    Change:
    ```
    addopts = "-v --tb=short --strict-markers"
    ```

    To:
    ```
    addopts = "-v --tb=short --strict-markers -m unit"
    ```

    This makes unit tests the default when running `pytest` without arguments.

    After this change:
    - `pytest` → runs only unit tests (327 tests)
    - `pytest -m integration` → runs only integration tests
    - `pytest -m "unit or integration"` → runs all tests
    - `pytest tests/integration/` → runs integration tests by path (overrides marker)
  </action>
  <verify>
    Run: `uv run pytest --collect-only 2>/dev/null | grep "test session starts" -A2`
    Expected: Shows collection from tests/unit and tests/integration but only unit tests selected

    Run: `uv run pytest --collect-only -q 2>/dev/null | tail -1`
    Expected: "327 tests collected" (all unit, no integration)
  </verify>
  <done>Default pytest run collects only 327 unit tests</done>
</task>

<task type="auto">
  <name>Task 2: Verify selective execution works</name>
  <files>pyproject.toml</files>
  <action>
    Verify all execution modes work correctly:

    1. Default (unit only): `uv run pytest --collect-only -q`
       Expected: 327 tests collected

    2. Explicit integration: `uv run pytest -m integration --collect-only -q`
       Expected: 0 tests collected (no integration tests yet)

    3. All tests: `uv run pytest -m "unit or integration" --collect-only -q`
       Expected: 327 tests collected (all unit, 0 integration)

    4. Run unit tests to confirm they pass: `uv run pytest`
       Expected: 327 passed
  </action>
  <verify>
    Run: `uv run pytest`
    Expected: All 327 tests pass

    Run: `uv run pytest -m integration`
    Expected: 0 tests collected/passed (deselected warning is OK)
  </verify>
  <done>All execution modes work correctly: default=unit, explicit marker for integration, combined marker for all</done>
</task>

</tasks>

<verification>
All phase 11 success criteria met:

1. Existing 327 unit tests run from tests/unit/ directory unchanged - VERIFIED (11-02)
2. Integration test structure exists in tests/integration/ with conftest.py - VERIFIED (11-01)
3. pytest markers enable selective execution (unit vs integration) - VERIFIED (11-01)
4. Default test run executes only unit tests (fast feedback) - NOW VERIFIED (this plan)
5. Integration tests run only when explicitly requested or in CI - NOW VERIFIED (this plan)

Commands to verify:
```bash
# Default = unit only
uv run pytest --collect-only -q 2>/dev/null | tail -1
# Should show: 327 tests collected

# Integration = explicit only
uv run pytest -m integration --collect-only -q 2>/dev/null | tail -1
# Should show: 0 tests collected

# All tests pass
uv run pytest
# Should show: 327 passed
```
</verification>

<success_criteria>
- pyproject.toml addopts includes `-m unit`
- `pytest` with no arguments collects only unit tests (327)
- `pytest -m integration` collects only integration tests (0 currently)
- All 327 unit tests pass with new default configuration
</success_criteria>

<output>
After completion, create `.planning/phases/11-test-reorganization/11-03-SUMMARY.md`
</output>
