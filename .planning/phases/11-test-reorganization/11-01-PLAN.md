---
phase: 11-test-reorganization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/unit/__init__.py
  - tests/unit/conftest.py
  - tests/integration/__init__.py
  - tests/integration/conftest.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "pytest recognizes unit and integration markers without warnings"
    - "Running pytest -m unit targets unit tests only"
    - "Running pytest -m integration targets integration tests only"
    - "Unmarked tests produce warnings during collection"
  artifacts:
    - path: "tests/unit/__init__.py"
      provides: "Unit test package marker"
    - path: "tests/unit/conftest.py"
      provides: "Auto-marking for unit tests"
      contains: "pytest.mark.unit"
    - path: "tests/integration/__init__.py"
      provides: "Integration test package marker"
    - path: "tests/integration/conftest.py"
      provides: "Auto-marking for integration tests"
      contains: "pytest.mark.integration"
    - path: "pyproject.toml"
      provides: "Marker registration and test paths"
      contains: "markers"
  key_links:
    - from: "tests/unit/conftest.py"
      to: "pyproject.toml"
      via: "registered markers"
      pattern: "pytest.mark.unit"
    - from: "tests/integration/conftest.py"
      to: "pyproject.toml"
      via: "registered markers"
      pattern: "pytest.mark.integration"
---

<objective>
Create test directory structure and pytest marker configuration for separating unit and integration tests.

Purpose: Establish the foundation that enables selective test execution - fast unit tests for development, integration tests for CI/Docker environments.

Output: Two new test directories (unit/, integration/) with auto-marking conftest.py files, and pyproject.toml with registered markers.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-test-reorganization/11-RESEARCH.md
@pyproject.toml
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test directory structure with conftest.py files</name>
  <files>
    tests/unit/__init__.py
    tests/unit/conftest.py
    tests/integration/__init__.py
    tests/integration/conftest.py
  </files>
  <action>
Create the unit and integration test directory structure:

1. Create `tests/unit/__init__.py` - empty file (package marker)

2. Create `tests/unit/conftest.py`:
```python
"""Unit test conftest.py - auto-apply unit marker to all tests in this directory."""

import pytest


def pytest_collection_modifyitems(items):
    """Add unit marker to all tests in tests/unit/."""
    for item in items:
        if "/unit/" in str(item.fspath):
            item.add_marker(pytest.mark.unit)
```

3. Create `tests/integration/__init__.py` - empty file (package marker)

4. Create `tests/integration/conftest.py`:
```python
"""Integration test conftest.py - auto-apply integration marker to all tests in this directory."""

import pytest


def pytest_collection_modifyitems(items):
    """Add integration marker to all tests in tests/integration/."""
    for item in items:
        if "/integration/" in str(item.fspath):
            item.add_marker(pytest.mark.integration)
```

Note: Keep the conftest files minimal. The auto-marking hook ensures tests get the correct marker based on directory location without requiring manual decoration on every test.
  </action>
  <verify>
```bash
# Verify directories exist
ls -la tests/unit/ tests/integration/
# Verify conftest.py files exist and contain marker logic
grep -l "pytest.mark.unit" tests/unit/conftest.py
grep -l "pytest.mark.integration" tests/integration/conftest.py
```
  </verify>
  <done>
Both tests/unit/ and tests/integration/ directories exist with __init__.py and conftest.py files. Conftest files contain pytest_collection_modifyitems hooks that auto-apply the appropriate marker.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register pytest markers and configure test paths</name>
  <files>pyproject.toml</files>
  <action>
Update `[tool.pytest.ini_options]` section in pyproject.toml:

1. Add `--strict-markers` to addopts (warns on unregistered markers)

2. Add `markers` list registering unit and integration:
```toml
markers = [
    "unit: marks tests as unit tests (use mocks, no infrastructure)",
    "integration: marks tests as integration tests (use real PostgreSQL, Ollama)",
]
```

3. Update `testpaths` to include both unit and integration directories:
```toml
testpaths = ["tests/unit", "tests/integration"]
```

The final `[tool.pytest.ini_options]` section should look like:
```toml
[tool.pytest.ini_options]
testpaths = ["tests/unit", "tests/integration"]
asyncio_mode = "strict"
asyncio_default_fixture_loop_scope = "function"
python_files = ["test_*.py"]
python_functions = ["test_*"]
addopts = "-v --tb=short --strict-markers"
markers = [
    "unit: marks tests as unit tests (use mocks, no infrastructure)",
    "integration: marks tests as integration tests (use real PostgreSQL, Ollama)",
]
```

Note: testpaths now points to the new directories. After Plan 02 migrates tests, running `pytest` will execute all tests from both directories. Running `pytest -m unit` executes only unit tests.
  </action>
  <verify>
```bash
# Verify markers are registered (no warnings)
uv run pytest --markers 2>&1 | grep -E "^@pytest.mark.(unit|integration)"
# Verify testpaths updated
grep -A2 "testpaths" pyproject.toml
```
  </verify>
  <done>
pyproject.toml contains registered markers (unit, integration) with --strict-markers enabled. testpaths points to tests/unit and tests/integration directories.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unmarked test warning to root conftest.py</name>
  <files>tests/conftest.py</files>
  <action>
Add a pytest_collection_modifyitems hook to the root conftest.py that warns about tests missing markers. This enforces marker discipline.

Add the following to tests/conftest.py (before or after existing fixtures):

```python
import warnings

# Built-in markers to ignore when checking for custom markers
BUILTIN_MARKERS = {
    'parametrize', 'skip', 'skipif', 'xfail', 'usefixtures',
    'filterwarnings', 'asyncio'
}

# Required custom markers - tests must have at least one
REQUIRED_MARKERS = {'unit', 'integration'}


def pytest_collection_modifyitems(items):
    """Warn if tests are missing unit/integration markers.

    This hook runs during test collection and emits warnings for any
    test that doesn't have a @pytest.mark.unit or @pytest.mark.integration
    marker. Tests in tests/unit/ and tests/integration/ get markers
    auto-applied by their respective conftest.py files.
    """
    for item in items:
        marker_names = {mark.name for mark in item.iter_markers()}
        custom_markers = marker_names - BUILTIN_MARKERS

        if not custom_markers.intersection(REQUIRED_MARKERS):
            warnings.warn(
                f"Test '{item.nodeid}' has no @pytest.mark.unit or "
                f"@pytest.mark.integration marker",
                UserWarning
            )
```

Keep the existing fixtures (`reset_db_pool`, `tmp_codebase`) and `pytest_plugins` list intact.
  </action>
  <verify>
```bash
# Verify hook added to conftest.py
grep -l "REQUIRED_MARKERS" tests/conftest.py
grep -l "pytest_collection_modifyitems" tests/conftest.py
```
  </verify>
  <done>
Root conftest.py contains pytest_collection_modifyitems hook that warns about unmarked tests. Existing fixtures and pytest_plugins list preserved.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Directory structure exists:
```bash
ls tests/unit/ tests/integration/
```

2. Markers registered without warnings:
```bash
uv run pytest --markers 2>&1 | grep -E "unit|integration"
```

3. pytest can collect tests (will be empty until Plan 02 migrates):
```bash
uv run pytest --collect-only tests/unit/ tests/integration/ 2>&1 | tail -3
```

4. Existing tests still discoverable from old location (temporary - Plan 02 will migrate):
```bash
uv run pytest --collect-only tests/ 2>&1 | grep "collected"
```
</verification>

<success_criteria>
- tests/unit/ directory exists with __init__.py and conftest.py
- tests/integration/ directory exists with __init__.py and conftest.py
- pyproject.toml has markers = ["unit: ...", "integration: ..."]
- pyproject.toml has testpaths = ["tests/unit", "tests/integration"]
- pyproject.toml has --strict-markers in addopts
- Root conftest.py has warning hook for unmarked tests
- `uv run pytest --markers` shows unit and integration markers without warnings
</success_criteria>

<output>
After completion, create `.planning/phases/11-test-reorganization/11-01-SUMMARY.md`
</output>
