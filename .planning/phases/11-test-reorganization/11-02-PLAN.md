---
phase: 11-test-reorganization
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - tests/unit/indexer/__init__.py
  - tests/unit/indexer/test_config.py
  - tests/unit/indexer/test_embedder.py
  - tests/unit/indexer/test_file_filter.py
  - tests/unit/indexer/test_flow.py
  - tests/unit/indexer/test_languages.py
  - tests/unit/indexer/test_metadata.py
  - tests/unit/indexer/test_progress.py
  - tests/unit/management/__init__.py
  - tests/unit/management/test_clear.py
  - tests/unit/management/test_discovery.py
  - tests/unit/management/test_git.py
  - tests/unit/management/test_stats.py
  - tests/unit/mcp/__init__.py
  - tests/unit/mcp/test_server.py
  - tests/unit/search/__init__.py
  - tests/unit/search/test_db.py
  - tests/unit/search/test_formatter.py
  - tests/unit/search/test_query.py
  - tests/unit/search/test_utils.py
  - tests/unit/test_cli.py
  - tests/unit/test_db_mocks.py
  - tests/unit/test_ollama_mocks.py
  - tests/unit/test_setup.py
autonomous: true

must_haves:
  truths:
    - "All 327 unit tests run from tests/unit/ directory"
    - "Running pytest -m unit executes all unit tests"
    - "Tests pass after migration with no failures"
    - "Old test directories are removed (tests/indexer, tests/management, etc.)"
  artifacts:
    - path: "tests/unit/indexer/test_flow.py"
      provides: "Migrated indexer flow tests"
    - path: "tests/unit/search/test_query.py"
      provides: "Migrated search query tests"
    - path: "tests/unit/mcp/test_server.py"
      provides: "Migrated MCP server tests"
    - path: "tests/unit/test_cli.py"
      provides: "Migrated CLI tests"
  key_links:
    - from: "tests/unit/**/test_*.py"
      to: "tests/conftest.py"
      via: "pytest_plugins import"
      pattern: "pytest_plugins"
    - from: "tests/unit/conftest.py"
      to: "tests/unit/**/test_*.py"
      via: "auto-marker hook"
      pattern: "pytest.mark.unit"
---

<objective>
Migrate all 327 existing unit tests from tests/ root and subdirectories into tests/unit/ directory structure.

Purpose: Complete the test reorganization by physically moving tests to their new locations, enabling selective test execution via pytest markers.

Output: All unit tests relocated to tests/unit/ with original test directories removed. All 327 tests pass with unit marker applied.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-test-reorganization/11-01-SUMMARY.md
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move test subdirectories to tests/unit/</name>
  <files>
    tests/unit/indexer/
    tests/unit/management/
    tests/unit/mcp/
    tests/unit/search/
  </files>
  <action>
Move the existing test subdirectories into tests/unit/ using shell commands:

```bash
# Move subdirectories (mv preserves content and git history awareness)
mv tests/indexer tests/unit/
mv tests/management tests/unit/
mv tests/mcp tests/unit/
mv tests/search tests/unit/
```

After moving, verify the structure exists:
- tests/unit/indexer/ (7 test files)
- tests/unit/management/ (4 test files)
- tests/unit/mcp/ (1 test file)
- tests/unit/search/ (5 test files)

Each directory should retain its __init__.py file from the original location.
  </action>
  <verify>
```bash
# Verify directories moved
ls tests/unit/indexer/ tests/unit/management/ tests/unit/mcp/ tests/unit/search/
# Verify old locations don't exist
ls tests/indexer 2>&1 | grep -q "No such file" && echo "indexer moved"
ls tests/management 2>&1 | grep -q "No such file" && echo "management moved"
```
  </verify>
  <done>
All test subdirectories (indexer/, management/, mcp/, search/) moved to tests/unit/. Original locations no longer exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move root-level test files to tests/unit/</name>
  <files>
    tests/unit/test_cli.py
    tests/unit/test_db_mocks.py
    tests/unit/test_ollama_mocks.py
    tests/unit/test_setup.py
  </files>
  <action>
Move the test files from tests/ root to tests/unit/:

```bash
# Move root-level test files
mv tests/test_cli.py tests/unit/
mv tests/test_db_mocks.py tests/unit/
mv tests/test_ollama_mocks.py tests/unit/
mv tests/test_setup.py tests/unit/
```

These files test:
- test_cli.py: CLI command interface
- test_db_mocks.py: Database mock validation
- test_ollama_mocks.py: Ollama mock validation
- test_setup.py: Basic pytest setup verification
  </action>
  <verify>
```bash
# Verify files moved
ls tests/unit/test_*.py
# Verify old locations don't exist
ls tests/test_cli.py 2>&1 | grep -q "No such file" && echo "test_cli.py moved"
```
  </verify>
  <done>
All root-level test files (test_cli.py, test_db_mocks.py, test_ollama_mocks.py, test_setup.py) moved to tests/unit/.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify all tests pass and count matches</name>
  <files>None (verification only)</files>
  <action>
Run the full test suite to verify migration succeeded:

```bash
# Run all tests from new location
uv run pytest tests/unit/ -v

# Verify count matches original 327
uv run pytest --collect-only tests/unit/ 2>&1 | grep "collected"

# Verify unit marker is applied (no warnings about missing markers)
uv run pytest tests/unit/ --collect-only 2>&1 | grep -c "warnings"
```

Expected outcomes:
1. All 327 tests pass
2. Collection shows "327 tests collected"
3. No warnings about missing markers (auto-applied by conftest.py hook)

If any tests fail, investigate import paths - the tests use absolute imports (`from cocosearch.x import y`) which should not be affected by the move.
  </action>
  <verify>
```bash
uv run pytest tests/unit/ 2>&1 | tail -5
```
  </verify>
  <done>
All 327 tests pass from tests/unit/ location. Marker auto-application working (no unmarked test warnings).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Test count matches:
```bash
uv run pytest --collect-only 2>&1 | grep "collected"
# Expected: 327 tests collected
```

2. All tests pass:
```bash
uv run pytest 2>&1 | grep -E "(passed|failed|error)"
# Expected: 327 passed
```

3. Marker filtering works:
```bash
uv run pytest -m unit --collect-only 2>&1 | grep "collected"
# Expected: 327 tests collected

uv run pytest -m integration --collect-only 2>&1 | grep "collected"
# Expected: 0 tests collected (no integration tests yet)
```

4. Old directories removed:
```bash
ls tests/indexer tests/management tests/mcp tests/search 2>&1 | grep "No such file"
```

5. Shared directories preserved:
```bash
ls tests/mocks/ tests/fixtures/
# Should still exist with all files
```
</verification>

<success_criteria>
- All 327 tests exist in tests/unit/
- All 327 tests pass with `uv run pytest`
- `pytest -m unit` collects all 327 tests
- `pytest -m integration` collects 0 tests
- Old test directories (tests/indexer, tests/management, tests/mcp, tests/search) removed
- Root test files (test_cli.py etc.) removed from tests/
- Shared directories (tests/mocks/, tests/fixtures/) preserved
- No warnings about unmarked tests
</success_criteria>

<output>
After completion, create `.planning/phases/11-test-reorganization/11-02-SUMMARY.md`
</output>
