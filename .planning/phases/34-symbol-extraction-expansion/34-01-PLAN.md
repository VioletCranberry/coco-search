---
phase: 34-symbol-extraction-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/cocosearch/indexer/symbols.py
  - src/cocosearch/indexer/queries/python.scm
  - src/cocosearch/indexer/queries/javascript.scm
  - src/cocosearch/indexer/queries/typescript.scm
  - src/cocosearch/indexer/queries/go.scm
  - src/cocosearch/indexer/queries/rust.scm
  - tests/unit/indexer/test_symbols.py
autonomous: true

must_haves:
  truths:
    - "tree-sitter-language-pack 0.13.0 is installed and importable"
    - "tree-sitter-languages is removed from dependencies"
    - "Existing Python/JS/TS/Go/Rust symbol extraction produces identical results"
    - "Query files are loaded from built-in queries/ directory"
    - "Query files can be overridden from ~/.cocosearch/queries/ or .cocosearch/queries/"
  artifacts:
    - path: "pyproject.toml"
      provides: "Updated dependencies"
      contains: "tree-sitter-language-pack>=0.13.0"
    - path: "src/cocosearch/indexer/queries/python.scm"
      provides: "Python symbol extraction query"
      min_lines: 10
    - path: "src/cocosearch/indexer/symbols.py"
      provides: "Refactored query-based symbol extraction"
      exports: ["extract_symbol_metadata", "LANGUAGE_MAP"]
  key_links:
    - from: "src/cocosearch/indexer/symbols.py"
      to: "tree_sitter_language_pack"
      via: "import get_parser, get_language"
      pattern: "from tree_sitter_language_pack import"
    - from: "src/cocosearch/indexer/symbols.py"
      to: "src/cocosearch/indexer/queries/*.scm"
      via: "importlib.resources for built-in queries"
      pattern: "importlib\\.resources\\.files.*queries"
---

<objective>
Migrate from tree-sitter-languages to tree-sitter-language-pack and implement external query file architecture for symbol extraction.

Purpose: Foundation for adding 5 new languages. The migration unblocks all language additions and the query file architecture makes symbol patterns user-extensible.

Output: Updated symbols.py using query-based extraction, .scm query files for existing 5 languages, all existing tests passing.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-symbol-extraction-expansion/34-CONTEXT.md
@.planning/phases/34-symbol-extraction-expansion/34-RESEARCH.md
@src/cocosearch/indexer/symbols.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update dependencies and create query file structure</name>
  <files>
    pyproject.toml
    src/cocosearch/indexer/queries/__init__.py
    src/cocosearch/indexer/queries/python.scm
    src/cocosearch/indexer/queries/javascript.scm
    src/cocosearch/indexer/queries/typescript.scm
    src/cocosearch/indexer/queries/go.scm
    src/cocosearch/indexer/queries/rust.scm
  </files>
  <action>
1. Update pyproject.toml dependencies:
   - Remove: tree-sitter>=0.21.0,<0.22.0
   - Remove: tree-sitter-languages>=1.10.0,<1.11.0
   - Add: tree-sitter>=0.25.0,<0.26.0
   - Add: tree-sitter-language-pack>=0.13.0

2. Create src/cocosearch/indexer/queries/ directory with empty __init__.py (needed for importlib.resources)

3. Create query files for existing 5 languages. Use tags.scm capture conventions:
   - @definition.class, @definition.function, @definition.method, @definition.interface
   - @name for the identifier node within each definition

python.scm:
```scheme
;; @doc Python symbol extraction: classes, functions, methods
(class_definition
  name: (identifier) @name) @definition.class

(function_definition
  name: (identifier) @name) @definition.function
```

javascript.scm:
```scheme
;; @doc JavaScript symbol extraction: functions, classes, methods
(function_declaration
  name: (identifier) @name) @definition.function

(class_declaration
  name: (identifier) @name) @definition.class

(method_definition
  name: (property_identifier) @name) @definition.method

(lexical_declaration
  (variable_declarator
    name: (identifier) @name
    value: (arrow_function))) @definition.function
```

typescript.scm (extends javascript):
```scheme
;; @doc TypeScript symbol extraction: functions, classes, methods, interfaces, type aliases
(function_declaration
  name: (identifier) @name) @definition.function

(class_declaration
  name: (identifier) @name) @definition.class

(method_definition
  name: (property_identifier) @name) @definition.method

(lexical_declaration
  (variable_declarator
    name: (identifier) @name
    value: (arrow_function))) @definition.function

(interface_declaration
  name: (type_identifier) @name) @definition.interface

(type_alias_declaration
  name: (type_identifier) @name) @definition.interface
```

go.scm:
```scheme
;; @doc Go symbol extraction: functions, methods, structs, interfaces
(function_declaration
  name: (identifier) @name) @definition.function

(method_declaration
  name: (field_identifier) @name) @definition.method

(type_declaration
  (type_spec
    name: (type_identifier) @name
    type: (struct_type))) @definition.class

(type_declaration
  (type_spec
    name: (type_identifier) @name
    type: (interface_type))) @definition.interface
```

rust.scm:
```scheme
;; @doc Rust symbol extraction: functions, methods, structs, traits, enums
(function_item
  name: (identifier) @name) @definition.function

(impl_item
  type: (_)
  body: (declaration_list
    (function_item
      name: (identifier) @name))) @definition.method

(struct_item
  name: (type_identifier) @name) @definition.class

(trait_item
  name: (type_identifier) @name) @definition.interface

(enum_item
  name: (type_identifier) @name) @definition.class
```

4. Run `uv sync` to install new dependencies
  </action>
  <verify>
    - `uv pip show tree-sitter-language-pack` shows version >=0.13.0
    - `uv pip show tree-sitter` shows version >=0.25.0
    - `python -c "from tree_sitter_language_pack import get_parser; p = get_parser('python'); print('OK')"` succeeds
    - All 5 .scm files exist in src/cocosearch/indexer/queries/
  </verify>
  <done>
    Dependencies upgraded, query files created for Python, JavaScript, TypeScript, Go, Rust
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor symbols.py to use query-based extraction</name>
  <files>
    src/cocosearch/indexer/symbols.py
  </files>
  <action>
1. Replace imports:
   - Remove: `from tree_sitter_languages import get_language`
   - Add: `from tree_sitter_language_pack import get_parser as pack_get_parser, get_language`
   - Add: `from tree_sitter import Query`
   - Add: `import importlib.resources`

2. Add query file resolution function (per 34-CONTEXT.md):
```python
def resolve_query_file(language: str, project_path: Path | None = None) -> str | None:
    """Resolve query file with priority: Project > User > Built-in."""
    query_name = f"{language}.scm"

    # Priority 1: Project-level override
    if project_path:
        project_query = project_path / ".cocosearch" / "queries" / query_name
        if project_query.exists():
            return project_query.read_text()

    # Priority 2: User-level override
    user_path = Path.home() / ".cocosearch" / "queries" / query_name
    if user_path.exists():
        return user_path.read_text()

    # Priority 3: Built-in queries
    try:
        return importlib.resources.files("cocosearch.indexer.queries").joinpath(query_name).read_text()
    except FileNotFoundError:
        return None
```

3. Update _get_parser() to use tree-sitter-language-pack:
```python
def _get_parser(language: str) -> Parser:
    global _PARSERS
    if language not in _PARSERS:
        _PARSERS[language] = pack_get_parser(language)
    return _PARSERS[language]
```

4. Add generic query-based symbol extraction function:
```python
def _extract_symbols_with_query(chunk_text: str, language: str, query_text: str) -> list[dict]:
    """Extract symbols using tree-sitter query."""
    lang = get_language(language)
    parser = _get_parser(language)
    tree = parser.parse(bytes(chunk_text, "utf8"))

    query = Query(lang, query_text)
    captures = query.captures(tree.root_node)

    symbols = []
    # Build dict: definition_node -> name_text
    definitions = {}  # node.id -> (node, capture_type)
    names = {}  # parent_node.id -> name_text

    for node, capture_name in captures:
        if capture_name.startswith("definition."):
            symbol_type = capture_name.split(".", 1)[1]
            definitions[node.id] = (node, symbol_type)
        elif capture_name == "name":
            # Find parent that is a definition
            parent = node.parent
            while parent:
                if parent.id in definitions:
                    names[parent.id] = chunk_text[node.start_byte:node.end_byte]
                    break
                parent = parent.parent

    for node_id, (node, symbol_type) in definitions.items():
        name = names.get(node_id)
        if name:
            # Build qualified name for methods
            qualified_name = _build_qualified_name(node, name, chunk_text, language)
            signature = _build_signature(node, chunk_text, language, symbol_type)

            symbols.append({
                "symbol_type": _map_symbol_type(symbol_type),
                "symbol_name": qualified_name,
                "symbol_signature": signature,
            })

    return symbols
```

5. Add helper functions for qualified names and signatures:
```python
def _map_symbol_type(raw_type: str) -> str:
    """Map query capture types to database symbol types."""
    mapping = {
        "function": "function",
        "method": "method",
        "class": "class",
        "interface": "interface",
        "struct": "class",
        "enum": "class",
        "trait": "interface",
        "module": "class",
        "namespace": "class",
        "type": "interface",
    }
    return mapping.get(raw_type, "function")

def _build_qualified_name(node, name: str, chunk_text: str, language: str) -> str:
    """Build qualified name with parent context (e.g., ClassName.method_name)."""
    container_types = {
        "python": ["class_definition"],
        "javascript": ["class_declaration", "class_body"],
        "typescript": ["class_declaration", "class_body"],
        "go": [],  # Go methods use receiver, handled differently
        "rust": ["impl_item"],
        "java": ["class_declaration", "interface_declaration", "enum_declaration"],
        "c": ["struct_specifier"],
        "cpp": ["class_specifier", "struct_specifier", "namespace_definition"],
        "ruby": ["class", "module"],
        "php": ["class_declaration", "interface_declaration", "trait_declaration"],
    }

    parents = []
    parent = node.parent
    while parent:
        if parent.type in container_types.get(language, []):
            parent_name = _get_container_name(parent, chunk_text, language)
            if parent_name:
                parents.append(parent_name)
        parent = parent.parent

    if not parents:
        return name

    separator = "::" if language in ("cpp",) else "."
    return separator.join(reversed(parents)) + separator + name
```

6. Update extract_symbol_metadata() to use query-based extraction:
```python
@cocoindex.op.function()
def extract_symbol_metadata(text: str, language: str) -> dict:
    ts_language = LANGUAGE_MAP.get(language)
    if ts_language is None:
        return {"symbol_type": None, "symbol_name": None, "symbol_signature": None}

    try:
        query_text = resolve_query_file(ts_language)
        if query_text is None:
            # No query file for this language - index without symbols
            return {"symbol_type": None, "symbol_name": None, "symbol_signature": None}

        symbols = _extract_symbols_with_query(text, ts_language, query_text)

        if symbols:
            return symbols[0]
        return {"symbol_type": None, "symbol_name": None, "symbol_signature": None}

    except Exception as e:
        logger.error(f"Symbol extraction failed: {e}", exc_info=True)
        return {"symbol_type": None, "symbol_name": None, "symbol_signature": None}
```

7. Remove the old language-specific extraction functions (_extract_python_symbols, _extract_javascript_symbols, etc.) after the new query-based approach is working. Keep them commented temporarily during testing.

8. Preserve the signature building logic from the old code - extract relevant parts into _build_signature() helper.
  </action>
  <verify>
    - `python -c "from cocosearch.indexer.symbols import extract_symbol_metadata; print(extract_symbol_metadata('def foo(): pass', 'py'))"` returns function symbol
    - No import errors when importing symbols module
  </verify>
  <done>
    symbols.py refactored to use tree-sitter 0.25.x API with query-based extraction
  </done>
</task>

<task type="auto">
  <name>Task 3: Update tests and verify backward compatibility</name>
  <files>
    tests/unit/indexer/test_symbols.py
  </files>
  <action>
1. Run existing tests to identify any failures:
   `pytest tests/unit/indexer/test_symbols.py -v`

2. Fix any test failures caused by:
   - API changes (captures() return format)
   - Signature format differences
   - Import changes

3. Add tests for query file resolution:
```python
def test_resolve_query_file_builtin():
    """Built-in query files should be found."""
    from cocosearch.indexer.symbols import resolve_query_file
    query = resolve_query_file("python")
    assert query is not None
    assert "definition.function" in query or "definition.class" in query

def test_resolve_query_file_missing():
    """Missing language returns None."""
    from cocosearch.indexer.symbols import resolve_query_file
    query = resolve_query_file("nonexistent_language")
    assert query is None
```

4. Verify all existing test cases still pass:
   - Python functions, classes, methods
   - JavaScript functions, classes, methods, arrow functions
   - TypeScript interfaces, type aliases
   - Go functions, methods, structs, interfaces
   - Rust functions, impl methods, structs, traits, enums

5. Run full test suite: `pytest tests/unit/indexer/test_symbols.py -v`
  </action>
  <verify>
    - `pytest tests/unit/indexer/test_symbols.py -v` - all tests pass
    - No deprecation warnings from tree-sitter (old warnings from tree-sitter-languages should be gone)
  </verify>
  <done>
    All existing symbol extraction tests pass with new query-based implementation
  </done>
</task>

</tasks>

<verification>
1. Dependencies: `uv pip list | grep -E "tree-sitter|language-pack"` shows correct versions
2. Query files: `ls src/cocosearch/indexer/queries/*.scm` shows 5 files
3. Tests: `pytest tests/unit/indexer/test_symbols.py -v` all pass
4. No deprecation warnings in test output
</verification>

<success_criteria>
- tree-sitter-language-pack 0.13.0+ installed
- tree-sitter 0.25.x installed
- tree-sitter-languages removed
- Query files exist for Python, JavaScript, TypeScript, Go, Rust
- All existing symbol extraction tests pass
- Query file override mechanism works (Project > User > Built-in)
</success_criteria>

<output>
After completion, create `.planning/phases/34-symbol-extraction-expansion/34-01-SUMMARY.md`
</output>
