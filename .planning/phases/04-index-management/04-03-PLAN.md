---
phase: 04-index-management
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/cocosearch/mcp/__init__.py
  - src/cocosearch/mcp/server.py
  - src/cocosearch/cli.py
autonomous: true

must_haves:
  truths:
    - "MCP server exposes search_code tool that returns code chunks"
    - "MCP server exposes list_indexes tool that returns all indexes"
    - "MCP server exposes index_stats tool that returns file/chunk/size"
    - "MCP server exposes clear_index tool that deletes an index"
    - "MCP server exposes index_codebase tool that indexes a directory"
    - "Server runs via 'cocosearch mcp' command using stdio transport"
  artifacts:
    - path: "src/cocosearch/mcp/__init__.py"
      provides: "Module exports"
      exports: ["create_server", "run_server"]
    - path: "src/cocosearch/mcp/server.py"
      provides: "FastMCP server with all tools"
      contains: "@mcp.tool()"
  key_links:
    - from: "src/cocosearch/mcp/server.py"
      to: "src/cocosearch/management/__init__.py"
      via: "management function imports"
      pattern: "from cocosearch\\.management import"
    - from: "src/cocosearch/mcp/server.py"
      to: "src/cocosearch/search/__init__.py"
      via: "search function import"
      pattern: "from cocosearch\\.search import search"
    - from: "src/cocosearch/cli.py"
      to: "src/cocosearch/mcp/server.py"
      via: "mcp command imports run_server"
      pattern: "from cocosearch\\.mcp import"
---

<objective>
Create MCP server with all index management and search tools.

Purpose: Enable Claude and other LLM clients to manage and search code indexes via MCP protocol.
Output: `src/cocosearch/mcp/` module with FastMCP server and `cocosearch mcp` CLI command.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-index-management/04-CONTEXT.md
@.planning/phases/04-index-management/04-RESEARCH.md
@.planning/phases/04-index-management/04-01-SUMMARY.md

# Existing code to reference
@src/cocosearch/search/query.py
@src/cocosearch/search/utils.py
@src/cocosearch/indexer/flow.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MCP server module with tools</name>
  <files>
    src/cocosearch/mcp/__init__.py
    src/cocosearch/mcp/server.py
  </files>
  <action>
Create the mcp module directory and files:

**server.py:**

CRITICAL: Configure logging to stderr immediately at module load (before any other imports that might log):
```python
import sys
import logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    stream=sys.stderr,
)
```

Imports:
```python
from typing import Annotated
from pydantic import Field
from mcp.server.fastmcp import FastMCP
import cocoindex

from cocosearch.management import list_indexes, get_stats, clear_index
from cocosearch.search import search
from cocosearch.search.utils import byte_to_line, read_chunk_content
from cocosearch.indexer import run_index, IndexingConfig
```

Create server:
```python
mcp = FastMCP("cocosearch")
```

**@mcp.tool() search_code:**
- Parameters: query (str), index_name (str), limit (int, default 10), language (str | None)
- Call `cocoindex.init()` first
- Call `search(query, index_name, limit, language_filter=language)`
- For each result: convert byte offsets to lines, read chunk content
- Return list of dicts with: file_path, start_line, end_line, score, content

**@mcp.tool() list_indexes:**
- No parameters
- Return `list_indexes()` result directly

**@mcp.tool() index_stats:**
- Parameter: index_name (str | None, default None)
- If index_name: return `get_stats(index_name)`
- Else: return stats for all indexes (loop list_indexes, call get_stats for each)
- Handle ValueError and return error dict

**@mcp.tool() clear_index:**
- Parameter: index_name (str)
- WARNING in docstring about permanent deletion
- Call `clear_index(index_name)`
- Return success/error dict

**@mcp.tool() index_codebase:**
- Parameters: path (str), index_name (str | None)
- Call `cocoindex.init()` first
- Derive index name if not provided
- Call `run_index(index_name, path, IndexingConfig())`
- Return dict with success, index_name, stats from update_info

**run_server():**
```python
def run_server():
    mcp.run(transport="stdio")
```

**__init__.py:**
```python
from cocosearch.mcp.server import mcp, run_server
__all__ = ["mcp", "run_server"]
```
  </action>
  <verify>
```bash
cd /Users/fzhdanov/GIT/personal/coco-s
uv run python -c "from cocosearch.mcp import mcp, run_server; print('MCP module imports OK')"
uv run python -c "from cocosearch.mcp.server import mcp; print(f'Tools: {list(mcp._tool_manager._tools.keys())}')"
```
  </verify>
  <done>
    - MCP module created with FastMCP server
    - 5 tools defined: search_code, list_indexes, index_stats, clear_index, index_codebase
    - Logging configured to stderr (not stdout)
    - run_server function runs with stdio transport
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 'mcp' subcommand to CLI</name>
  <files>src/cocosearch/cli.py</files>
  <action>
**mcp_command(args) -> int:**
```python
def mcp_command(args: argparse.Namespace) -> int:
    """Start the MCP server."""
    from cocosearch.mcp import run_server
    run_server()
    return 0  # Never reached, server runs until killed
```

**Add subparser:**

`mcp` subcommand:
- No arguments (server uses stdio transport)
- Help: "Start MCP server for LLM integration"

**Update sys.argv handling:**
- Add "mcp" to the list of recognized subcommands in the condition:
  `if sys.argv[1] not in ("index", "search", "list", "stats", "clear", "mcp", "-h", "--help"):`

**Add handler in main():**
```python
elif args.command == "mcp":
    sys.exit(mcp_command(args))
```
  </action>
  <verify>
```bash
cd /Users/fzhdanov/GIT/personal/coco-s
uv run cocosearch mcp --help
# Test server starts (will block, so just verify it doesn't crash immediately)
timeout 2 uv run cocosearch mcp || true
```
  </verify>
  <done>
    - `cocosearch mcp` command available
    - Command starts MCP server with stdio transport
    - Server exposes all 5 tools to MCP clients
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/fzhdanov/GIT/personal/coco-s

# Verify MCP module
uv run python -c "
from cocosearch.mcp.server import mcp
tools = list(mcp._tool_manager._tools.keys())
print(f'Registered tools: {tools}')
assert 'search_code' in tools
assert 'list_indexes' in tools
assert 'index_stats' in tools
assert 'clear_index' in tools
assert 'index_codebase' in tools
print('All 5 MCP tools registered')
"

# Verify CLI command
uv run cocosearch --help | grep mcp
uv run cocosearch mcp --help

# Test server starts (timeout after 1 sec)
timeout 1 sh -c 'echo "{}" | uv run cocosearch mcp' 2>&1 || echo "Server started (expected timeout)"
```
</verification>

<success_criteria>
- MCP module exists at src/cocosearch/mcp/
- Server has 5 tools: search_code, list_indexes, index_stats, clear_index, index_codebase
- All tools have proper type annotations and docstrings
- Logging goes to stderr (not corrupting stdio protocol)
- `cocosearch mcp` command starts the server
- Server uses stdio transport for MCP protocol
</success_criteria>

<output>
After completion, create `.planning/phases/04-index-management/04-03-SUMMARY.md`
</output>
