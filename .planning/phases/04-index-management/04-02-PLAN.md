---
phase: 04-index-management
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/cocosearch/cli.py
autonomous: true

must_haves:
  truths:
    - "User can run 'cocosearch list' to see all indexes"
    - "User can run 'cocosearch stats' to see stats for all indexes"
    - "User can run 'cocosearch stats <index>' to see stats for specific index"
    - "User can run 'cocosearch clear <index>' with confirmation prompt"
    - "User can run 'cocosearch clear <index> --force' to skip confirmation"
    - "All commands output JSON by default, --pretty for human formatting"
  artifacts:
    - path: "src/cocosearch/cli.py"
      provides: "Extended CLI with list, stats, clear, mcp subcommands"
      contains: "list_parser"
  key_links:
    - from: "src/cocosearch/cli.py"
      to: "src/cocosearch/management/__init__.py"
      via: "management function imports"
      pattern: "from cocosearch\\.management import"
---

<objective>
Add CLI management commands: list, stats, clear to the existing CLI.

Purpose: Enable users to manage indexes from command line with consistent JSON/--pretty output.
Output: Extended cli.py with three new subcommands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-index-management/04-CONTEXT.md
@.planning/phases/04-index-management/04-01-SUMMARY.md

# File to modify
@src/cocosearch/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add list and stats commands</name>
  <files>src/cocosearch/cli.py</files>
  <action>
Add imports at top:
```python
from cocosearch.management import list_indexes, get_stats, clear_index, derive_index_from_git
```

**list_command(args) -> int:**
- Call `list_indexes()` to get all indexes
- If `args.pretty`: Use Rich table with columns: Name, Table
- Else: Print JSON array of index dicts
- Return 0

**stats_command(args) -> int:**
- If `args.index` provided: get stats for that specific index
- Else: get stats for ALL indexes (loop through list_indexes())
- Handle ValueError (index not found) with error message
- If `args.pretty`: Use Rich table with columns: Name, Files, Chunks, Size
- Else: Print JSON (single object or array)
- Return 0 on success, 1 on error

**Add subparsers:**

`list` subcommand:
- `--pretty` flag for human output

`stats` subcommand:
- Optional positional `index` argument (if omitted, show all)
- `--pretty` flag for human output

Update the sys.argv handling to recognize new subcommands ("list", "stats", "clear", "mcp").
  </action>
  <verify>
```bash
cd /Users/fzhdanov/GIT/personal/coco-s
uv run cocosearch list --help
uv run cocosearch stats --help
uv run cocosearch list
uv run cocosearch list --pretty
```
  </verify>
  <done>
    - list command shows all indexes in JSON or Rich table
    - stats command shows file/chunk/size for one or all indexes
    - Both respect --pretty flag
  </done>
</task>

<task type="auto">
  <name>Task 2: Add clear command with confirmation</name>
  <files>src/cocosearch/cli.py</files>
  <action>
**clear_command(args) -> int:**
1. Get index_name from args.index
2. Try to get stats first (validates index exists, shows what will be deleted)
3. Handle ValueError with "Index not found" message, return 1
4. If not `args.force`:
   - Print stats (files, chunks, size) showing what will be deleted
   - Prompt: `input(f"Delete index '{index_name}'? [y/N] ")`
   - If response.lower() != 'y': print "Cancelled.", return 0
5. Call `clear_index(index_name)`
6. If `args.pretty`: print Rich success message "[green]Index deleted[/green]"
7. Else: print JSON `{"success": true, "message": "..."}`
8. Return 0

**Add subparser:**

`clear` subcommand:
- Required positional `index` argument
- `--force` flag to skip confirmation
- `--pretty` flag for human output
  </action>
  <verify>
```bash
cd /Users/fzhdanov/GIT/personal/coco-s
uv run cocosearch clear --help
# Test with non-existent index (should error)
uv run cocosearch clear nonexistent 2>&1 | head -5
```
  </verify>
  <done>
    - clear command requires index name
    - Shows stats before deletion
    - Prompts for confirmation by default
    - --force skips confirmation
    - Proper error handling for non-existent index
  </done>
</task>

<task type="auto">
  <name>Task 3: Update auto-detect to use git root</name>
  <files>src/cocosearch/cli.py</files>
  <action>
Modify `search_command` to use git-based auto-detection:

1. Change the auto-detect logic:
   - If `args.index` provided: use it
   - Else: try `derive_index_from_git()`
   - If git detection returns None: fall back to `derive_index_name(os.getcwd())`

2. Add "Using index: {name}" print statement BEFORE any output:
   - In search_command, print this before results (for both JSON and pretty)
   - For JSON mode, include as first line: `{"using_index": "name", ...}` or print to stderr
   - Per CONTEXT.md: "Always print 'Using index: {name}' before results"

3. If not in git repo AND no --index specified: Consider printing warning (optional, per discretion)

Note: Keep existing behavior working. Git detection is an enhancement, not a requirement.
  </action>
  <verify>
```bash
cd /Users/fzhdanov/GIT/personal/coco-s
# Should detect 'coco_s' from git root
uv run cocosearch search "test" --pretty 2>&1 | head -3
```
  </verify>
  <done>
    - Search auto-detects index from git root when inside a repo
    - Falls back to cwd-based derivation if not in git repo
    - "Using index:" hint printed before output
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/fzhdanov/GIT/personal/coco-s

# Verify all commands exist
uv run cocosearch --help

# Test list
uv run cocosearch list
uv run cocosearch list --pretty

# Test stats (all)
uv run cocosearch stats
uv run cocosearch stats --pretty

# Test clear help
uv run cocosearch clear --help

# Test search auto-detect (should use git root)
uv run cocosearch search "function" --limit 1 --pretty
```
</verification>

<success_criteria>
- `cocosearch list` shows all indexes (JSON default, --pretty for table)
- `cocosearch stats` shows stats for all indexes
- `cocosearch stats <index>` shows stats for specific index
- `cocosearch clear <index>` prompts for confirmation, shows what will be deleted
- `cocosearch clear <index> --force` skips confirmation
- All commands handle errors gracefully with clear messages
- Search uses git root for auto-detection when available
</success_criteria>

<output>
After completion, create `.planning/phases/04-index-management/04-02-SUMMARY.md`
</output>
