---
phase: 04-index-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cocosearch/management/__init__.py
  - src/cocosearch/management/discovery.py
  - src/cocosearch/management/stats.py
  - src/cocosearch/management/git.py
  - src/cocosearch/management/clear.py
autonomous: true

must_haves:
  truths:
    - "list_indexes returns all CocoIndex tables from PostgreSQL"
    - "get_stats returns file count, chunk count, storage size for an index"
    - "clear_index removes an index table from PostgreSQL"
    - "derive_index_from_git returns index name from git repo root"
  artifacts:
    - path: "src/cocosearch/management/__init__.py"
      provides: "Module exports"
      exports: ["list_indexes", "get_stats", "clear_index", "derive_index_from_git"]
    - path: "src/cocosearch/management/discovery.py"
      provides: "Index discovery from PostgreSQL"
      contains: "information_schema.tables"
    - path: "src/cocosearch/management/stats.py"
      provides: "Index statistics"
      contains: "pg_table_size"
    - path: "src/cocosearch/management/clear.py"
      provides: "Index deletion"
      contains: "DROP TABLE"
    - path: "src/cocosearch/management/git.py"
      provides: "Git root detection"
      contains: "git rev-parse"
  key_links:
    - from: "src/cocosearch/management/discovery.py"
      to: "src/cocosearch/search/db.py"
      via: "get_connection_pool import"
      pattern: "from cocosearch\\.search\\.db import"
    - from: "src/cocosearch/management/stats.py"
      to: "src/cocosearch/search/db.py"
      via: "get_connection_pool and get_table_name imports"
      pattern: "from cocosearch\\.search\\.db import"
---

<objective>
Create the management module with core functions for index discovery, statistics, clearing, and git root detection.

Purpose: Provide reusable business logic that both CLI and MCP server can consume.
Output: `src/cocosearch/management/` module with all core index management functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-index-management/04-CONTEXT.md
@.planning/phases/04-index-management/04-RESEARCH.md

# Existing code to reuse
@src/cocosearch/search/db.py
@src/cocosearch/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create management module with discovery and stats</name>
  <files>
    src/cocosearch/management/__init__.py
    src/cocosearch/management/discovery.py
    src/cocosearch/management/stats.py
  </files>
  <action>
Create the management module directory and files:

**discovery.py:**
- Import `get_connection_pool` from `cocosearch.search.db`
- `list_indexes() -> list[dict]`: Query `information_schema.tables` for tables matching pattern `codeindex_%__%_chunks`. Parse table names to extract index names. Return list of dicts with keys: `name`, `table_name`.
- Pattern parsing: `codeindex_{name}__{name}_chunks` -> extract `name` from the part before `__` minus the `codeindex_` prefix.

**stats.py:**
- Import `get_connection_pool`, `get_table_name` from `cocosearch.search.db`
- `get_stats(index_name: str) -> dict`: Query the table for COUNT(DISTINCT filename), COUNT(*), and pg_table_size(). Return dict with keys: `name`, `file_count`, `chunk_count`, `storage_size` (bytes), `storage_size_pretty` (human-readable).
- `format_bytes(size: int) -> str`: Convert bytes to KB/MB/GB string.
- Raise `ValueError` if index not found (table doesn't exist).

**__init__.py:**
- Export: `list_indexes`, `get_stats` (more added in Task 2)
  </action>
  <verify>
```bash
cd /Users/fzhdanov/GIT/personal/coco-s
uv run python -c "from cocosearch.management import list_indexes, get_stats; print('Imports OK')"
```
  </verify>
  <done>
    - list_indexes function queries PostgreSQL and parses table names
    - get_stats function returns file/chunk/size metrics
    - format_bytes handles B/KB/MB/GB formatting
  </done>
</task>

<task type="auto">
  <name>Task 2: Add clear_index and git detection functions</name>
  <files>
    src/cocosearch/management/clear.py
    src/cocosearch/management/git.py
    src/cocosearch/management/__init__.py
  </files>
  <action>
**clear.py:**
- Import `get_connection_pool`, `get_table_name` from `cocosearch.search.db`
- `clear_index(index_name: str) -> dict`: First verify index exists by checking table in information_schema. If not found, raise `ValueError`. Use `DROP TABLE {table_name}` to delete. Return dict with `success: True`, `message`, and optionally stats that were deleted.

**git.py:**
- `get_git_root() -> Path | None`: Run `subprocess.run(['git', 'rev-parse', '--show-toplevel'], capture_output=True, text=True, check=True)`. Return Path on success, None on CalledProcessError (not in git repo).
- `derive_index_from_git() -> str | None`: Call get_git_root(), if None return None. Otherwise import `derive_index_name` from `cocosearch.cli` and return `derive_index_name(str(git_root))`.

**Update __init__.py:**
- Add exports: `clear_index`, `derive_index_from_git`, `get_git_root`
  </action>
  <verify>
```bash
cd /Users/fzhdanov/GIT/personal/coco-s
uv run python -c "from cocosearch.management import clear_index, derive_index_from_git, get_git_root; print('All imports OK')"
uv run python -c "from cocosearch.management import get_git_root; print(get_git_root())"
```
  </verify>
  <done>
    - clear_index validates index exists before dropping
    - get_git_root detects repo root via subprocess
    - derive_index_from_git combines git detection with name derivation
    - All 5 functions exported from management module
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/fzhdanov/GIT/personal/coco-s

# Test all imports
uv run python -c "
from cocosearch.management import (
    list_indexes,
    get_stats,
    clear_index,
    derive_index_from_git,
    get_git_root,
)
print('All management functions imported successfully')
"

# Test git detection (should work in this repo)
uv run python -c "
from cocosearch.management import derive_index_from_git
name = derive_index_from_git()
print(f'Detected index name: {name}')
assert name is not None, 'Should detect git repo'
"

# Test list_indexes (requires running Postgres)
uv run python -c "
from cocosearch.management import list_indexes
indexes = list_indexes()
print(f'Found {len(indexes)} indexes')
for idx in indexes:
    print(f'  - {idx[\"name\"]} ({idx[\"table_name\"]})')
"
```
</verification>

<success_criteria>
- Management module created at src/cocosearch/management/
- All 5 functions (list_indexes, get_stats, clear_index, derive_index_from_git, get_git_root) importable
- list_indexes queries information_schema and returns parsed index list
- get_stats returns file_count, chunk_count, storage_size, storage_size_pretty
- clear_index validates existence before DROP TABLE
- Git detection works in git repos, returns None outside
</success_criteria>

<output>
After completion, create `.planning/phases/04-index-management/04-01-SUMMARY.md`
</output>
