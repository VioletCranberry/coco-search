---
phase: 14-end-to-end-flows
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - tests/integration/test_e2e_search.py
autonomous: true

must_haves:
  truths:
    - "CLI search command finds indexed content via semantic similarity"
    - "Search results contain correct file paths and line numbers"
    - "JSON output can be parsed and validated programmatically"
    - "Language filtering restricts results to matching files"
  artifacts:
    - path: "tests/integration/test_e2e_search.py"
      provides: "E2E search flow tests"
      exports: ["test_full_search_flow", "test_search_result_structure", "test_language_filtering"]
  key_links:
    - from: "tests/integration/test_e2e_search.py"
      to: "cocosearch CLI search"
      via: "subprocess.run() with JSON output parsing"
      pattern: "subprocess\\.run.*cocosearch.*search"
---

<objective>
Create E2E search flow tests that validate the complete pipeline from query through embedding generation to vector search and result formatting.

Purpose: Prove the search flow works end-to-end with real services, validating result correctness, structure, and language filtering.

Output: Search integration tests covering requirements E2E-02, E2E-04, and E2E-05.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-end-to-end-flows/14-CONTEXT.md
@.planning/phases/14-end-to-end-flows/14-RESEARCH.md

# Prior plan for shared patterns
@.planning/phases/14-end-to-end-flows/14-01-SUMMARY.md

# Existing infrastructure
@tests/fixtures/containers.py
@tests/fixtures/ollama_integration.py
@tests/integration/conftest.py

# CLI implementation for understanding flags
@src/cocosearch/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E search flow tests</name>
  <files>tests/integration/test_e2e_search.py</files>
  <action>
Create integration tests for the full search flow. Tests require a pre-indexed codebase, so use a module-scoped fixture that indexes once and reuses across all search tests.

Key patterns (from 14-RESEARCH.md):
1. **Check returncode before JSON parsing** - Failed commands output error text, not JSON
2. **JSON output mode** - Use default JSON output (no --pretty) for assertions
3. **Predictable search terms** - Search for known content from e2e_fixtures

Tests to implement:

**test_full_search_flow()** (E2E-02):
- Index e2e_fixtures first (module-scoped)
- Search for "authenticate user" (should find auth.py)
- Verify results returned
- Verify relevance score > 0.3

**test_search_result_structure()** (E2E-05):
- Search for known content
- Parse JSON output
- Validate structure has required fields:
  - filename (str, contains path)
  - start_line (int, > 0)
  - end_line (int, >= start_line)
  - score (float, 0-1)
  - chunk (str, non-empty)
- Validate filename points to actual file

**test_search_returns_correct_file()** (E2E-04):
- Search for "aws_instance" (terraform-specific)
- Verify results contain main.tf
- Search for "docker build" (bash script)
- Verify results contain deploy.sh

**test_language_filtering()** (validates --lang flag):
- Index first
- Search for "function" without filter - should find utils.js AND maybe others
- Search for "function" with --lang javascript - should only find utils.js
- Search with --lang python - should exclude JavaScript results

**test_search_empty_results()** (E2E-02 edge case):
- Search for gibberish that won't match anything
- Verify returns empty list, not error
- Verify exit code is still 0

**test_search_missing_index()** (error handling):
- Search against non-existent index
- Verify non-zero exit code
- Verify helpful error message

Module-scoped fixture for indexing (runs once per test module):
```python
@pytest.fixture(scope="module")
def indexed_e2e_fixtures(initialized_db, warmed_ollama, e2e_fixtures_path):
    """Index e2e_fixtures once for all search tests in this module."""
    env = os.environ.copy()
    env["COCOINDEX_DATABASE_URL"] = initialized_db
    env["OLLAMA_HOST"] = warmed_ollama

    index_name = "e2e_search_tests"

    # Index the fixtures
    result = subprocess.run(
        [sys.executable, "-m", "cocosearch", "index", str(e2e_fixtures_path),
         "--name", index_name],
        capture_output=True,
        text=True,
        env=env,
    )

    assert result.returncode == 0, f"Indexing failed: {result.stderr}"

    yield index_name, env

    # Cleanup handled by clean_tables fixture
```

Helper for running search and parsing JSON:
```python
def search_and_parse(query: str, index_name: str, env: dict, extra_args: list = None) -> list:
    """Run search command and parse JSON output."""
    args = [sys.executable, "-m", "cocosearch", "search", query, "--index", index_name]
    if extra_args:
        args.extend(extra_args)

    result = subprocess.run(args, capture_output=True, text=True, env=env)
    assert result.returncode == 0, f"Search failed: {result.stderr}"

    return json.loads(result.stdout)
```
  </action>
  <verify>
Run the search integration tests:
```bash
cd /Users/fedorzhdanov/GIT/personal/coco-s && uv run pytest tests/integration/test_e2e_search.py -v -m integration 2>&1 | head -60
```
Expected: All 6 tests pass (full_search_flow, result_structure, correct_file, language_filtering, empty_results, missing_index)
  </verify>
  <done>E2E search tests validate CLI search command with real services, covering semantic search, result structure, file path correctness, and language filtering</done>
</task>

</tasks>

<verification>
1. Search returns results for known content
2. JSON output structure is correct and parseable
3. File paths in results point to actual indexed files
4. Language filtering restricts results appropriately
5. Error cases handled gracefully
</verification>

<success_criteria>
- test_e2e_search.py contains at least 6 tests
- `pytest tests/integration/test_e2e_search.py -v -m integration` shows all tests passing
- Search for "authenticate user" finds auth.py
- Search with --lang javascript finds only JavaScript files
- Requirements E2E-02, E2E-04, and E2E-05 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/14-end-to-end-flows/14-02-SUMMARY.md`
</output>
