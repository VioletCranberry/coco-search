---
phase: 14-end-to-end-flows
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - tests/integration/test_e2e_devops.py
autonomous: true

must_haves:
  truths:
    - "Terraform files index correctly with HCL chunking"
    - "Dockerfile indexes correctly with Dockerfile chunking"
    - "Bash scripts index correctly with shell chunking"
    - "Language aliases (tf, docker, shell) work in search filtering"
    - "DevOps metadata is present in search results"
  artifacts:
    - path: "tests/integration/test_e2e_devops.py"
      provides: "DevOps file validation tests"
      exports: ["test_terraform_indexing", "test_dockerfile_indexing", "test_bash_indexing"]
  key_links:
    - from: "tests/integration/test_e2e_devops.py"
      to: "cocosearch search --lang"
      via: "Language filter with DevOps aliases"
      pattern: "--lang.*(terraform|dockerfile|shell|hcl|bash)"
---

<objective>
Create DevOps file validation tests that verify Terraform, Dockerfile, and Bash files index correctly with proper chunking, metadata extraction, and language filtering.

Purpose: Validate v1.2 DevOps language support works end-to-end with real services, ensuring custom_languages chunking and metadata are preserved through the pipeline.

Output: DevOps-specific integration tests covering requirement E2E-06.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-end-to-end-flows/14-CONTEXT.md
@.planning/phases/14-end-to-end-flows/14-RESEARCH.md

# Prior plan for shared fixtures
@.planning/phases/14-end-to-end-flows/14-01-SUMMARY.md

# DevOps implementation context
@.planning/phases/08-custom-language-definitions-and-file-routing/08-01-SUMMARY.md
@.planning/phases/09-metadata-extraction/09-01-SUMMARY.md
@.planning/phases/10-flow-integration-and-schema/10-01-SUMMARY.md

# Existing infrastructure
@tests/fixtures/containers.py
@tests/fixtures/ollama_integration.py
@tests/integration/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DevOps file validation tests</name>
  <files>tests/integration/test_e2e_devops.py</files>
  <action>
Create integration tests validating DevOps file handling. Tests focus on:
1. Files are indexed (not skipped)
2. Language filtering with aliases works
3. Metadata is extracted and present in results

Key patterns (from 14-CONTEXT.md):
- Test all three file types: HCL, Dockerfile, Bash
- Test language aliases: tf/terraform, docker/dockerfile, shell/bash
- Assert metadata fields are present and correct

Tests to implement:

**test_terraform_indexing()** (E2E-06):
- Index e2e_fixtures
- Search for "aws_instance" with --lang terraform
- Verify main.tf is found
- Verify --lang hcl also finds it (alias)

**test_dockerfile_indexing()** (E2E-06):
- Search for "FROM python" with --lang dockerfile
- Verify Dockerfile is found
- Verify results have dockerfile-specific content

**test_bash_indexing()** (E2E-06):
- Search for "docker build" with --lang bash
- Verify deploy.sh is found
- Verify --lang shell also finds it (alias)

**test_devops_language_aliases()** (validates alias resolution):
- Search with --lang tf (should work like terraform)
- Search with --lang docker (should work like dockerfile)
- Search with --lang sh (should work like bash)

**test_devops_metadata_presence()** (validates metadata pipeline):
- Search for DevOps content
- Check that results have metadata fields:
  - language (should be hcl/dockerfile/bash)
  - For Terraform: look for block_type if present
  - For Dockerfile: look for stage if present

**test_devops_vs_regular_filtering()** (validates filtering accuracy):
- Search for generic term like "application" or "install"
- Without filter: may return mixed results
- With --lang python: should only return Python files
- With --lang terraform: should only return .tf files

Module-scoped fixture (shared with test_e2e_search.py pattern):
```python
@pytest.fixture(scope="module")
def indexed_devops_fixtures(initialized_db, warmed_ollama, e2e_fixtures_path):
    """Index e2e_fixtures once for all DevOps tests."""
    env = os.environ.copy()
    env["COCOINDEX_DATABASE_URL"] = initialized_db
    env["OLLAMA_HOST"] = warmed_ollama

    index_name = "e2e_devops_tests"

    result = subprocess.run(
        [sys.executable, "-m", "cocosearch", "index", str(e2e_fixtures_path),
         "--name", index_name],
        capture_output=True,
        text=True,
        env=env,
    )

    assert result.returncode == 0, f"Indexing failed: {result.stderr}"

    yield index_name, env
```

Reuse the e2e_fixtures_path fixture from conftest.py (add if not present):
```python
@pytest.fixture
def e2e_fixtures_path():
    """Return path to e2e test fixtures."""
    return Path(__file__).parent.parent / "fixtures" / "e2e_fixtures"
```
  </action>
  <verify>
Run the DevOps integration tests:
```bash
cd /Users/fedorzhdanov/GIT/personal/coco-s && uv run pytest tests/integration/test_e2e_devops.py -v -m integration 2>&1 | head -60
```
Expected: All 6 tests pass (terraform_indexing, dockerfile_indexing, bash_indexing, language_aliases, metadata_presence, vs_regular_filtering)
  </verify>
  <done>DevOps validation tests confirm Terraform, Dockerfile, and Bash files index correctly with proper language detection, alias support, and metadata extraction</done>
</task>

</tasks>

<verification>
1. Terraform files found with --lang terraform and --lang hcl
2. Dockerfile found with --lang dockerfile and --lang docker
3. Bash scripts found with --lang bash and --lang shell
4. Metadata fields present in search results
5. Language filtering correctly excludes non-matching file types
</verification>

<success_criteria>
- test_e2e_devops.py contains at least 6 tests
- `pytest tests/integration/test_e2e_devops.py -v -m integration` shows all tests passing
- All three DevOps file types (HCL, Dockerfile, Bash) index and search correctly
- Language aliases resolve correctly
- Requirement E2E-06 is satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/14-end-to-end-flows/14-03-SUMMARY.md`
</output>
