---
phase: 47-documentation-update
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/cli-reference.md
  - docs/architecture.md
  - docs/mcp-tools.md
  - docs/retrieval.md
  - docs/search-features.md
  - docs/dogfooding.md
autonomous: true

must_haves:
  truths:
    - "CLI reference documents --show-failures flag and parse health output"
    - "Architecture doc describes infra-only Docker model and mentions Roots capability"
    - "MCP tools doc includes include_failures parameter on index_stats"
    - "MCP tools doc includes parse_stats in index_stats response examples"
    - "Retrieval doc mentions parse tracking as post-indexing step"
    - "No output blocks remain in any reference doc"
    - "All commands use uvx cocosearch (not uv run or bare cocosearch)"
    - "Dogfooding doc uses uvx cocosearch in all examples"
  artifacts:
    - path: "docs/cli-reference.md"
      provides: "Complete CLI reference with parse health features"
      contains: "--show-failures"
    - path: "docs/architecture.md"
      provides: "Architecture overview with infra-only Docker and Roots"
      contains: "Roots"
    - path: "docs/mcp-tools.md"
      provides: "MCP tools reference with include_failures parameter"
      contains: "include_failures"
    - path: "docs/retrieval.md"
      provides: "Retrieval logic with parse tracking mention"
      contains: "parse"
    - path: "docs/search-features.md"
      provides: "Search features documentation"
    - path: "docs/dogfooding.md"
      provides: "Self-indexing guide with uvx commands"
      contains: "uvx cocosearch"
  key_links:
    - from: "docs/architecture.md"
      to: "docs/mcp-tools.md"
      via: "inline link in MCP section"
      pattern: "mcp-tools\\.md"
    - from: "docs/architecture.md"
      to: "docs/retrieval.md"
      via: "inline link in data flow section"
      pattern: "retrieval\\.md"
---

<objective>
Update all 6 reference docs in docs/ to reflect features from phases 43-46, remove output blocks, standardize on uvx cocosearch, and ensure clear section headers.

Purpose: Reference docs must accurately describe the current system. New features (parse tracking, Roots detection, include_failures parameter) need to be documented. Stale patterns (uv run, output blocks, old Docker model) need to be removed.

Output: Updated cli-reference.md, architecture.md, mcp-tools.md, retrieval.md, search-features.md, dogfooding.md.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-documentation-update/47-CONTEXT.md
@.planning/phases/47-documentation-update/47-RESEARCH.md
@docs/cli-reference.md
@docs/architecture.md
@docs/mcp-tools.md
@docs/retrieval.md
@docs/search-features.md
@docs/dogfooding.md
@src/cocosearch/mcp/server.py
@src/cocosearch/management/stats.py
@src/cocosearch/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update cli-reference.md, architecture.md, and dogfooding.md</name>
  <files>docs/cli-reference.md, docs/architecture.md, docs/dogfooding.md</files>
  <action>
**docs/cli-reference.md -- moderate rewrite:**

1. Remove ALL output blocks (every "Output:" label and every fenced code block showing terminal output). Keep only command examples.
2. Use `uvx cocosearch` in all command examples (not bare `cocosearch`). Example: `uvx cocosearch index ./my-project --name myproject`
3. Add parse health features to the stats section:
   - `uvx cocosearch stats myproject --pretty` now shows parse health by default (percentage of files that parsed successfully per language)
   - `uvx cocosearch stats myproject --pretty --show-failures` shows detailed failure listing with file paths and error types
   - Document the `--show-failures` flag in the stats command flag table
4. Ensure section headers are clear and descriptive for GitHub sidebar navigation.
5. Keep the command tables, flag descriptions, and examples -- just clean up output blocks and update invocation patterns.
6. Remove the `--json` flag reference if it does not exist in the actual CLI (check source). The CLI uses `--pretty` for human output and JSON is the default without `--pretty`.

**docs/architecture.md -- moderate update:**

1. Update the "System Components" section:
   - Update FastMCP description to mention Roots capability for automatic project detection in clients that support it (Claude Code). Note the priority chain: roots > query_param > env > cwd.
   - No changes to Ollama, PostgreSQL, CocoIndex, or Tree-sitter descriptions.
2. Update "Data Flow -- Indexing" section:
   - Add step 8: "**Parse Tracking:** After indexing completes, parse results are recorded per file (ok, partial, error, unsupported). This non-fatal tracking provides observability into tree-sitter parse health."
3. Update "MCP Integration" section:
   - Update `index_stats` description to mention parse health data and `include_failures` parameter.
   - Note that `search_code` is async and accepts Context for Roots-based project detection.
   - Update "Project Detection" paragraph to describe the full priority chain: MCP Roots (automatic in Claude Code) > `--project-from-cwd` > environment variable > current working directory.
4. Add a new key decision:
   - **Infra-only Docker:** Docker provides PostgreSQL+pgvector and Ollama infrastructure only. CocoSearch runs natively via uvx for faster iteration and simpler updates.
   - **Parse tracking:** Non-fatal parse status tracking per file provides observability without blocking indexing. Parse failures are surfaced in stats output.

**docs/dogfooding.md -- moderate update:**

1. Replace all `uv run cocosearch` with `uvx cocosearch`.
   - `uvx cocosearch index . --name self`
   - `uvx cocosearch stats self --pretty`
   - `uvx cocosearch search "how does embedding work" --index self --pretty`
   - etc.
2. Remove ALL output blocks (every "Expected output:", "Output shows", "Finds the..." text and fenced output blocks). Keep only command examples.
3. Keep the section structure (Indexing, Verifying, Example Searches) but make each section command-only.
4. Friendly tone -- brief description of what each command does, then the command.
  </action>
  <verify>
1. `grep -r "Output:" docs/cli-reference.md docs/architecture.md docs/dogfooding.md` returns no matches
2. `grep -r "uv run" docs/cli-reference.md docs/architecture.md docs/dogfooding.md` returns no matches
3. `grep "show-failures" docs/cli-reference.md` confirms the flag is documented
4. `grep "Roots" docs/architecture.md` confirms Roots capability is mentioned
5. `grep "parse" docs/architecture.md` confirms parse tracking is mentioned (case-insensitive)
6. `grep "uvx cocosearch" docs/dogfooding.md` returns matches for all commands
  </verify>
  <done>
CLI reference has parse health docs and no output blocks. Architecture describes infra-only Docker, Roots capability, and parse tracking. Dogfooding uses uvx and has no output blocks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update mcp-tools.md, retrieval.md, and search-features.md</name>
  <files>docs/mcp-tools.md, docs/retrieval.md, docs/search-features.md</files>
  <action>
**docs/mcp-tools.md -- moderate update:**

1. Update `index_stats` tool:
   - Add `include_failures` parameter to the Parameters table: `include_failures | boolean | No | false | Include per-language parse failure details in response`
   - Update the JSON Response (Single Index) example to include parse health fields:
     ```json
     "parse_health_pct": 95.2,
     "parse_stats": [
       {
         "language": "python",
         "total_files": 180,
         "ok": 175,
         "partial": 3,
         "error": 2,
         "unsupported": 0
       }
     ]
     ```
   - Add note: "When `include_failures` is true, the response includes a `parse_failures` array with file paths and error details for each failed parse."
   - Update the JSON Response (All Indexes) example similarly.
2. Update `search_code` tool:
   - Add a brief note that search_code performs automatic project detection using MCP Roots when available, falling back to index_name parameter or working directory.
   - No parameter changes needed (the Context injection is internal).
3. Update `clear_index`:
   - Add note that clearing an index also removes the associated parse_results tracking table.
4. Verify the Implementation section at the bottom references the correct files. Update if needed:
   - Core search engine: `src/cocosearch/search/query.py`
   - Index management: `src/cocosearch/management/__init__.py`
   - Statistics: `src/cocosearch/management/stats.py`
   - Parse tracking: `src/cocosearch/management/parse_tracking.py`

**docs/retrieval.md -- minor update:**

1. Add a new section after "### 7. Storage" titled "### 8. Parse Tracking":
   - Explain that after CocoIndex completes the indexing flow, CocoSearch runs a post-flow parse tracking pass.
   - For each unique file in the index, tree-sitter attempts to parse the content.
   - Each file gets a parse status: `ok` (clean parse), `partial` (parse with errors), `error` (parse failed completely), or `unsupported` (no tree-sitter grammar available).
   - Results stored in a per-index `parse_results` table with columns: filename, language, parse_status, error_count, created_at.
   - This tracking is non-fatal -- parse failures do not block indexing.
   - Implementation: `src/cocosearch/management/parse_tracking.py`
2. Update the Summary section at the bottom:
   - Change "7-stage pipeline" to "8-stage pipeline" for indexing.
   - Add parse tracking mention.
3. Do NOT add output blocks.

**docs/search-features.md -- minimal update:**

1. Remove any output blocks that exist. Looking at the current file, the comments after commands (lines like `# May return:` and `# Returns:`) are inline comments in code blocks, not separate output blocks -- these are acceptable to keep since they are inside the command code block and serve as brief annotations.
2. Verify all command examples are consistent. Currently they use bare `cocosearch` -- update to `uvx cocosearch` for consistency with CONTEXT.md decisions. Example: `uvx cocosearch search "getUserById" --pretty`
3. No structural changes needed -- the content is accurate for search features.
  </action>
  <verify>
1. `grep "include_failures" docs/mcp-tools.md` confirms the parameter is documented
2. `grep "parse_stats\|parse_health" docs/mcp-tools.md` confirms parse health fields in response
3. `grep "Parse Tracking\|parse_tracking" docs/retrieval.md` confirms the new section exists
4. `grep "8-stage" docs/retrieval.md` confirms updated pipeline count
5. `grep "uv run" docs/mcp-tools.md docs/retrieval.md docs/search-features.md` returns no matches
6. `grep "uvx cocosearch" docs/search-features.md` confirms updated commands
  </verify>
  <done>
MCP tools doc includes include_failures parameter and parse health in response examples. Retrieval doc has parse tracking as stage 8. Search features uses uvx cocosearch. No output blocks in any file.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, run across ALL 6 reference docs:
1. `grep -r "uv run" docs/` returns no matches
2. `grep -r "port 3000\|:3000" docs/` returns no matches
3. `grep -rn "^Output:" docs/` returns no matches (no standalone output labels)
4. `grep "include_failures" docs/mcp-tools.md` returns matches
5. `grep "show-failures" docs/cli-reference.md` returns matches
6. `grep "Roots" docs/architecture.md` returns matches
7. `grep "Parse Tracking" docs/retrieval.md` returns matches
8. `grep "uvx cocosearch" docs/dogfooding.md` returns matches
</verification>

<success_criteria>
- All 6 reference docs updated with current system state
- Parse health features documented in cli-reference.md (--show-failures) and mcp-tools.md (include_failures)
- Architecture doc reflects infra-only Docker model, Roots capability, and parse tracking
- Retrieval doc has 8-stage indexing pipeline (parse tracking added)
- No output blocks in any reference doc
- All commands use uvx cocosearch
- Clear section headers throughout for GitHub sidebar navigation
</success_criteria>

<output>
After completion, create `.planning/phases/47-documentation-update/47-02-SUMMARY.md`
</output>
