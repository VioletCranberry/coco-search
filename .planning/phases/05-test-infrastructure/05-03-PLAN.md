---
phase: 05-test-infrastructure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/mocks/ollama.py
  - tests/fixtures/ollama.py
  - tests/fixtures/data.py
autonomous: true

must_haves:
  truths:
    - "Tests can mock Ollama embeddings without running Ollama"
    - "Embedding mocks are deterministic (same input = same output)"
    - "Common data fixtures available for typical test scenarios"
  artifacts:
    - path: "tests/mocks/ollama.py"
      provides: "deterministic_embedding function"
      min_lines: 20
    - path: "tests/fixtures/ollama.py"
      provides: "mock_code_to_embedding fixture"
      min_lines: 25
    - path: "tests/fixtures/data.py"
      provides: "SearchResult and config factories"
      min_lines: 40
  key_links:
    - from: "tests/fixtures/ollama.py"
      to: "cocosearch.indexer.embedder.code_to_embedding"
      via: "unittest.mock.patch"
      pattern: "patch.*code_to_embedding"
---

<objective>
Create Ollama mocking infrastructure and common data fixtures for isolated testing.

Purpose: Enable tests to run without Ollama by providing deterministic embedding mocks, plus reusable data fixtures.
Output: Mock embedding functions, ollama fixtures, and data factory fixtures.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-test-infrastructure/05-CONTEXT.md
@.planning/phases/05-test-infrastructure/05-RESEARCH.md
@src/cocosearch/indexer/embedder.py
@src/cocosearch/search/query.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Ollama mock module</name>
  <files>tests/mocks/ollama.py</files>
  <action>
Create tests/mocks/ollama.py with deterministic embedding generation:

```python
"""Ollama mock utilities for testing.

Provides deterministic embedding generation that produces consistent
results for the same input, enabling predictable test assertions.
"""

import hashlib


def deterministic_embedding(text: str, dimensions: int = 768) -> list[float]:
    """Generate a deterministic fake embedding from text hash.

    Same input always produces the same output, enabling predictable
    test assertions. The output mimics real embedding characteristics:
    - 768 dimensions (matching nomic-embed-text)
    - Values in [-1, 1] range
    - Deterministic based on input text

    Args:
        text: Text to generate embedding for.
        dimensions: Number of embedding dimensions (default 768).

    Returns:
        List of floats representing the fake embedding vector.
    """
    # Create a hash of the input text
    hash_bytes = hashlib.sha256(text.encode('utf-8')).digest()

    # Expand hash to fill dimensions
    embedding = []
    for i in range(dimensions):
        # Cycle through hash bytes to fill all dimensions
        byte_idx = i % len(hash_bytes)
        # Normalize to [-1, 1] range typical for embeddings
        value = (hash_bytes[byte_idx] / 255.0) * 2 - 1
        embedding.append(value)

    return embedding


def similar_embedding(base_embedding: list[float], similarity: float = 0.9) -> list[float]:
    """Create an embedding that has a specific similarity to the base.

    Useful for testing similarity thresholds and ranking.

    Args:
        base_embedding: The reference embedding.
        similarity: Target cosine similarity (0-1, default 0.9).

    Returns:
        New embedding with approximately the target similarity.
    """
    import random

    # Mix the base with noise based on similarity
    noise_factor = 1 - similarity
    result = []
    for val in base_embedding:
        noise = (random.random() * 2 - 1) * noise_factor
        new_val = val * similarity + noise
        # Clamp to [-1, 1]
        result.append(max(-1, min(1, new_val)))

    return result
```

Note: similar_embedding uses random, but that's intentional for testing similarity thresholds. The primary deterministic_embedding is the one used for most tests.
  </action>
  <verify>
Run: `uv run python -c "from tests.mocks.ollama import deterministic_embedding; e = deterministic_embedding('test'); print(len(e), e[:3])"`
Verify output shows 768 dimensions and consistent values
  </verify>
  <done>
tests/mocks/ollama.py has deterministic_embedding function that produces consistent 768-dim vectors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Ollama and data fixtures</name>
  <files>tests/fixtures/ollama.py, tests/fixtures/data.py</files>
  <action>
Create tests/fixtures/ollama.py:

```python
"""Ollama fixtures for testing.

Provides fixtures that mock CocoIndex embedding functions to enable
testing without running Ollama or making API calls.
"""

import pytest
from unittest.mock import patch, MagicMock

from tests.mocks.ollama import deterministic_embedding


@pytest.fixture
def mock_code_to_embedding():
    """Mock the code_to_embedding.eval() function.

    Patches cocosearch.indexer.embedder.code_to_embedding with a mock
    that returns deterministic embeddings. The mock tracks calls for
    assertion.

    Usage:
        def test_search(mock_code_to_embedding, patched_db_pool):
            # code_to_embedding.eval() now returns deterministic embeddings
            result = search("find auth code", "myindex")
            mock_code_to_embedding.eval.assert_called_once()
    """
    mock = MagicMock()
    mock.eval = lambda text: deterministic_embedding(text)

    with patch('cocosearch.indexer.embedder.code_to_embedding', mock):
        # Also patch in search.query where it's imported
        with patch('cocosearch.search.query.code_to_embedding', mock):
            yield mock


@pytest.fixture
def embedding_for():
    """Factory fixture that returns deterministic embeddings for given text.

    Useful when you need to get the same embedding used by mocked functions.

    Usage:
        def test_something(embedding_for):
            query_embedding = embedding_for("search query")
            # This is the same embedding that mock_code_to_embedding would return
    """
    return deterministic_embedding
```

Create tests/fixtures/data.py:

```python
"""Data fixtures for testing.

Provides factory fixtures for creating test data objects like
SearchResult, IndexingConfig, and sample file content.
"""

import pytest
from cocosearch.search.query import SearchResult


@pytest.fixture
def make_search_result():
    """Factory for SearchResult objects.

    Usage:
        def test_formatter(make_search_result):
            result = make_search_result(filename="/test/file.py", score=0.95)
    """
    def _make(
        filename: str = "/test/project/main.py",
        start_byte: int = 0,
        end_byte: int = 100,
        score: float = 0.85,
    ) -> SearchResult:
        return SearchResult(
            filename=filename,
            start_byte=start_byte,
            end_byte=end_byte,
            score=score,
        )

    return _make


@pytest.fixture
def sample_search_result(make_search_result):
    """Ready-to-use SearchResult for simple tests."""
    return make_search_result()


@pytest.fixture
def sample_search_results(make_search_result):
    """List of sample SearchResults for testing formatters and displays."""
    return [
        make_search_result(filename="/project/auth.py", start_byte=0, end_byte=150, score=0.92),
        make_search_result(filename="/project/utils.py", start_byte=50, end_byte=200, score=0.85),
        make_search_result(filename="/project/main.py", start_byte=100, end_byte=300, score=0.78),
    ]


@pytest.fixture
def sample_code_content():
    """Sample Python code content for testing.

    Returns a dict mapping byte ranges to code content.
    """
    code = '''def authenticate(username: str, password: str) -> bool:
    """Check if username and password are valid."""
    if not username or not password:
        return False
    # Check against database
    user = get_user(username)
    if user and verify_password(password, user.password_hash):
        return True
    return False
'''
    return {
        "content": code,
        "filename": "/project/auth.py",
        "start_byte": 0,
        "end_byte": len(code.encode('utf-8')),
    }


@pytest.fixture
def make_config_dict():
    """Factory for .cocosearch.yaml config dictionaries.

    Usage:
        def test_config(make_config_dict):
            config = make_config_dict(include=["*.py", "*.js"])
    """
    def _make(
        include: list[str] | None = None,
        exclude: list[str] | None = None,
        chunk_size: int = 1000,
        chunk_overlap: int = 300,
    ) -> dict:
        config = {}
        if include:
            config["include"] = include
        if exclude:
            config["exclude"] = exclude
        config["chunk_size"] = chunk_size
        config["chunk_overlap"] = chunk_overlap
        return config

    return _make


@pytest.fixture
def sample_config_dict(make_config_dict):
    """Ready-to-use config dict with common settings."""
    return make_config_dict(include=["*.py"], exclude=["*_test.py", "tests/"])
```

Then update tests/conftest.py to register ollama and data fixtures plugins:
- Uncomment "tests.fixtures.ollama" and "tests.fixtures.data" lines in pytest_plugins
  </action>
  <verify>
Run: `uv run python -c "from tests.fixtures.ollama import mock_code_to_embedding; print('ok')"`
Run: `uv run python -c "from tests.fixtures.data import make_search_result; print('ok')"`
  </verify>
  <done>
tests/fixtures/ollama.py has mock_code_to_embedding fixture
tests/fixtures/data.py has SearchResult and config factories
tests/conftest.py registers both plugins
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Ollama mocking and data fixtures work</name>
  <files>tests/test_ollama_mocks.py</files>
  <action>
Create tests/test_ollama_mocks.py to verify the infrastructure:

```python
"""Tests to verify Ollama mocking and data fixture infrastructure."""

import pytest
from tests.mocks.ollama import deterministic_embedding, similar_embedding


def test_deterministic_embedding_consistent():
    """Verify same input produces same embedding."""
    text = "find authentication code"

    embedding1 = deterministic_embedding(text)
    embedding2 = deterministic_embedding(text)

    assert embedding1 == embedding2
    assert len(embedding1) == 768


def test_deterministic_embedding_different_inputs():
    """Verify different inputs produce different embeddings."""
    embedding1 = deterministic_embedding("search for auth")
    embedding2 = deterministic_embedding("database queries")

    # Should be different
    assert embedding1 != embedding2


def test_deterministic_embedding_dimensions():
    """Verify embedding has correct dimensions."""
    embedding = deterministic_embedding("test", dimensions=768)
    assert len(embedding) == 768

    # All values should be in [-1, 1] range
    assert all(-1 <= v <= 1 for v in embedding)


def test_similar_embedding_creates_similar_vector():
    """Verify similar_embedding creates related vectors."""
    base = deterministic_embedding("test query")
    similar = similar_embedding(base, similarity=0.95)

    # Should have same dimensions
    assert len(similar) == len(base)

    # Values should still be in valid range
    assert all(-1 <= v <= 1 for v in similar)


def test_mock_code_to_embedding_fixture(mock_code_to_embedding):
    """Verify mock_code_to_embedding patches correctly."""
    from cocosearch.search.query import code_to_embedding

    result = code_to_embedding.eval("test query")

    assert len(result) == 768
    # Should be deterministic
    assert result == deterministic_embedding("test query")


def test_embedding_for_fixture(embedding_for):
    """Verify embedding_for returns consistent embeddings."""
    embedding1 = embedding_for("test")
    embedding2 = embedding_for("test")

    assert embedding1 == embedding2


def test_make_search_result_factory(make_search_result):
    """Verify SearchResult factory works."""
    result = make_search_result(
        filename="/custom/path.py",
        score=0.99,
    )

    assert result.filename == "/custom/path.py"
    assert result.score == 0.99
    assert result.start_byte == 0  # default
    assert result.end_byte == 100  # default


def test_sample_search_result_fixture(sample_search_result):
    """Verify ready-to-use SearchResult fixture."""
    assert sample_search_result.filename == "/test/project/main.py"
    assert sample_search_result.score == 0.85


def test_sample_search_results_fixture(sample_search_results):
    """Verify list of SearchResults fixture."""
    assert len(sample_search_results) == 3
    # Should be sorted by score (highest first)
    assert sample_search_results[0].score > sample_search_results[1].score


def test_sample_code_content_fixture(sample_code_content):
    """Verify sample code content fixture."""
    assert "def authenticate" in sample_code_content["content"]
    assert sample_code_content["filename"] == "/project/auth.py"


def test_make_config_dict_factory(make_config_dict):
    """Verify config dict factory."""
    config = make_config_dict(include=["*.py", "*.js"], chunk_size=500)

    assert config["include"] == ["*.py", "*.js"]
    assert config["chunk_size"] == 500
    assert "exclude" not in config  # Only included if provided


def test_sample_config_dict_fixture(sample_config_dict):
    """Verify ready-to-use config dict fixture."""
    assert "*.py" in sample_config_dict["include"]
    assert "tests/" in sample_config_dict["exclude"]
```

Run pytest to verify all tests pass.
  </action>
  <verify>
Run: `uv run pytest tests/test_ollama_mocks.py -v` passes all tests
  </verify>
  <done>
Ollama mocking and data fixtures verified with passing tests
  </done>
</task>

</tasks>

<verification>
All verification commands should pass:
```bash
# Mock module importable
uv run python -c "from tests.mocks.ollama import deterministic_embedding; print('ok')"

# Fixtures importable
uv run python -c "from tests.fixtures.ollama import mock_code_to_embedding; print('ok')"
uv run python -c "from tests.fixtures.data import make_search_result; print('ok')"

# All mock tests pass
uv run pytest tests/test_ollama_mocks.py -v

# Full test suite passes
uv run pytest tests/ -v
```
</verification>

<success_criteria>
- tests/mocks/ollama.py has deterministic_embedding function
- tests/fixtures/ollama.py has mock_code_to_embedding and embedding_for fixtures
- tests/fixtures/data.py has SearchResult and config factories
- Embeddings are deterministic (same input = same output)
- mock_code_to_embedding correctly patches the code_to_embedding function
- All tests in tests/test_ollama_mocks.py pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-infrastructure/05-03-SUMMARY.md`
</output>
