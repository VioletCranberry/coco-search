---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - scripts/verify_setup.py
autonomous: true

must_haves:
  truths:
    - "pgvector extension is enabled in PostgreSQL"
    - "nomic-embed-text returns 768-dimensional embeddings"
    - "All infrastructure components verified working together"
    - "No external network calls during embedding generation"
  artifacts:
    - path: "scripts/verify_setup.py"
      provides: "Infrastructure verification script"
      min_lines: 50
  key_links:
    - from: "scripts/verify_setup.py"
      to: "docker-compose.yml"
      via: "database connection check"
      pattern: "cocosearch-db"
    - from: "scripts/verify_setup.py"
      to: "Ollama API"
      via: "embedding API call"
      pattern: "localhost:11434"
---

<objective>
Enable pgvector extension, create verification script, and confirm all Phase 1 infrastructure works correctly together.

Purpose: Validate the foundation is solid before proceeding to indexing pipeline work.
Output: pgvector enabled, verification script that proves all success criteria are met.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable pgvector Extension</name>
  <files>None (database schema change)</files>
  <action>
Enable the pgvector extension in PostgreSQL:

1. Verify container is running:
   ```bash
   docker compose ps
   ```

2. Create the vector extension:
   ```bash
   docker exec cocosearch-db psql -U cocoindex -d cocoindex -c "CREATE EXTENSION IF NOT EXISTS vector;"
   ```

3. Verify extension is enabled:
   ```bash
   docker exec cocosearch-db psql -U cocoindex -d cocoindex -c "SELECT extname, extversion FROM pg_extension WHERE extname = 'vector';"
   ```
   Should show: vector | 0.8.x (or similar version)

Reference: RESEARCH.md Pattern 3 (pgvector Extension Initialization)
  </action>
  <verify>
Run: `docker exec cocosearch-db psql -U cocoindex -d cocoindex -t -c "SELECT extversion FROM pg_extension WHERE extname = 'vector';"` - should return version number (e.g., 0.8.0)
  </verify>
  <done>pgvector extension enabled in PostgreSQL database</done>
</task>

<task type="auto">
  <name>Task 2: Create Verification Script</name>
  <files>
    - scripts/verify_setup.py
  </files>
  <action>
Create comprehensive verification script based on RESEARCH.md example:

1. Create `scripts/` directory if it doesn't exist

2. Create `scripts/verify_setup.py` with three verification functions:

   a. `check_postgres()`: Verify PostgreSQL is running with pgvector enabled
      - Use docker exec to query pg_extension
      - Print version number on success
      - Return True/False

   b. `check_ollama()`: Verify Ollama with nomic-embed-text
      - Check Ollama is running via /api/tags
      - Verify model is available
      - Call /api/embed with test input
      - Verify exactly 768 dimensions returned
      - Return True/False

   c. `check_python_deps()`: Verify Python dependencies
      - Import cocoindex, psycopg, pgvector
      - Print cocoindex version
      - Return True/False

   d. `main()`: Run all checks, print summary, exit 0 if all pass, 1 if any fail

3. Make script executable and add shebang

Use the exact code from RESEARCH.md Code Examples section as the base, but ensure it's clean and well-commented.

Important: Use only standard library (subprocess, sys, json, urllib.request) - no additional dependencies needed for verification script.
  </action>
  <verify>
Run: `uv run python scripts/verify_setup.py` - should show all checks passing with [OK] status
  </verify>
  <done>Verification script created and all checks pass</done>
</task>

<task type="auto">
  <name>Task 3: Final Integration Verification</name>
  <files>None (verification only)</files>
  <action>
Run comprehensive verification to confirm all Phase 1 success criteria:

1. Run the verification script:
   ```bash
   uv run python scripts/verify_setup.py
   ```
   All three checks should show [OK]

2. Verify embedding dimensions explicitly (Success Criteria #2):
   ```bash
   curl -s http://localhost:11434/api/embed \
     -d '{"model": "nomic-embed-text", "input": "test code search"}' | \
     python3 -c "import sys,json; e=json.load(sys.stdin)['embeddings'][0]; print(f'Dimensions: {len(e)}')"
   ```
   Must output: Dimensions: 768

3. Verify no external network calls (Success Criteria #4):
   - The embedding call above goes to localhost:11434 (local Ollama)
   - PostgreSQL is on localhost:5432 (local Docker container)
   - No environment variables point to external services
   ```bash
   grep -v "^#" .env | grep -v "localhost" || echo "All connections are local"
   ```

4. Test CocoIndex can connect to database:
   ```bash
   uv run python -c "
   import os
   os.environ.setdefault('COCOINDEX_DATABASE_URL', 'postgresql://cocoindex:cocoindex@localhost:5432/cocoindex')
   import cocoindex
   print('CocoIndex can be imported with database URL configured')
   "
   ```

5. Document verification results in plan summary
  </action>
  <verify>
All verification script checks pass (exit code 0)
Embedding returns exactly 768 dimensions
All connections verified as localhost only
  </verify>
  <done>All Phase 1 success criteria verified: PostgreSQL with pgvector running, Ollama serving 768-dim embeddings, Python project ready, no external API calls</done>
</task>

</tasks>

<verification>
Phase 1 Success Criteria Verification:

1. **PostgreSQL container runs with pgvector extension enabled and persistent storage**
   - `docker compose ps` shows healthy
   - `SELECT extversion FROM pg_extension WHERE extname = 'vector'` returns version
   - `docker volume ls | grep postgres_data` shows volume exists

2. **Ollama serves nomic-embed-text model and returns 768-dimensional embeddings**
   - `/api/tags` shows nomic-embed-text
   - `/api/embed` returns exactly 768 dimensions

3. **Python project initializes with UV and all dependencies install successfully**
   - `uv run python -c "import cocoindex, psycopg, pgvector"` succeeds
   - `uv.lock` exists

4. **No network calls to external services during embedding generation**
   - Ollama is on localhost:11434
   - PostgreSQL is on localhost:5432
   - No external URLs in .env
</verification>

<success_criteria>
- `uv run python scripts/verify_setup.py` exits with code 0
- All [OK] messages displayed
- Phase 1 requirements INFRA-01, INFRA-02, INFRA-03 verified complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
