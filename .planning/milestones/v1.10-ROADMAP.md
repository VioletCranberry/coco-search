# Milestone v1.10: Infrastructure & Protocol

**Status:** SHIPPED 2026-02-08
**Phases:** 43-47
**Total Plans:** 12

## Overview

v1.10 is a refinement milestone that standardizes credentials, simplifies the Docker image to infra-only, adds protocol-correct MCP Roots support, introduces parse failure tracking for observability, and updates documentation to reflect the new architecture. Five phases deliver these changes in dependency order: foundation fixes first, then infrastructure, protocol, observability, and documentation.

## Phases

### Phase 43: Bug Fix & Credential Defaults

**Goal**: Users can run `docker compose up && cocosearch index .` with zero environment variable configuration
**Depends on**: Nothing (first phase of milestone)
**Plans**: 2 plans

Plans:
- [x] 43-01-PLAN.md -- Fix DevOps metadata bug, create get_database_url() helper, update all Python callsites and tests
- [x] 43-02-PLAN.md -- Align docker-compose.yml and all docs/scripts to cocosearch:cocosearch credentials

**Details:**
- Created `DEFAULT_DATABASE_URL` constant and `get_database_url()` helper centralizing all database URL resolution
- Fixed `language` → `language_id` parameter in `extract_devops_metadata` transform call
- CocoIndex SDK environment bridge: `COCOINDEX_DATABASE_URL` auto-set as side-effect of `get_database_url()`
- docker-compose.yml, dev-setup.sh, .env.example, README, and MCP docs all aligned to cocosearch:cocosearch credentials
- `.env.example` marks DATABASE_URL as optional (commented out) since app has built-in default

### Phase 44: Docker Image Simplification

**Goal**: Docker image provides only infrastructure services (PostgreSQL+pgvector, Ollama+model) with no application code
**Depends on**: Phase 43 (credential alignment)
**Plans**: 2 plans

Plans:
- [x] 44-01-PLAN.md -- Strip Docker image: remove Python builder, delete svc-mcp, rewire init-ready, upgrade PG 16 to 17
- [x] 44-02-PLAN.md -- Update README and MCP docs for infra-only Docker model

**Details:**
- Removed Python builder stage from Dockerfile (python:3.11-slim base → debian:bookworm-slim)
- Deleted svc-mcp service from s6-overlay
- Updated health-check to check PostgreSQL and Ollama only
- Exposed ports reduced to 5432 (PostgreSQL) and 11434 (Ollama), removed 3000
- PostgreSQL upgraded from 16 to 17 in Docker image
- Documentation updated: Docker = infrastructure, uvx = application

### Phase 45: MCP Protocol Enhancements

**Goal**: MCP server detects the active project using the protocol-standard Roots capability with graceful fallback for unsupported clients
**Depends on**: Phase 43 (working database connection)
**Plans**: 3 plans

Plans:
- [x] 45-01-PLAN.md -- Create project_detection.py module with file_uri_to_path, _detect_project priority chain, and roots notification handler
- [x] 45-02-PLAN.md -- Convert search_code to async with Context injection, integrate _detect_project for project detection
- [x] 45-03-PLAN.md -- Create project detection tests, update existing MCP tests for async, fix pre-existing test failures

**Details:**
- Created `project_detection.py` module with `file_uri_to_path()`, `_detect_project()`, `register_roots_notification()`
- Detection priority chain: roots > query_param > env > cwd (cwd is unconditional fallback)
- `file://` URI parsing uses urlparse+unquote (FileUrl.path does NOT percent-decode)
- Only `search_code` converted to async (other tools remain sync — no Context needed)
- Comprehensive test suite with 23 project detection tests + all search_code tests converted to async
- Hint message appended for non-roots clients on every env/cwd detection

### Phase 46: Parse Failure Tracking

**Goal**: Users can see how many files failed tree-sitter parsing per language when reviewing index health
**Depends on**: Phase 43 (working indexing pipeline)
**Plans**: 3 plans

Plans:
- [x] 46-01-PLAN.md -- Create parse_tracking module, schema migration, integrate into flow.py and clear.py
- [x] 46-02-PLAN.md -- Add parse stats queries, extend IndexStats, update CLI with parse health display and --show-failures
- [x] 46-03-PLAN.md -- Surface parse stats in MCP/HTTP endpoints, add comprehensive tests

**Details:**
- Created `parse_tracking.py` module with `detect_parse_status()`, `track_parse_results()`, `rebuild_parse_results()`
- Post-flow tracking pattern: query chunks table, read from disk, process independently
- Non-fatal: parse tracking failure does not fail indexing
- Parse health shown by default in CLI; `--show-failures` for detailed file-level output
- Color-coded health display: green >= 95%, yellow >= 80%, red < 80%
- MCP `index_stats` upgraded to `get_comprehensive_stats()` with `include_failures` parameter
- HTTP `/api/stats` endpoint includes parse failure data with `include_failures` query parameter
- 13 new tests covering all parse status categories

### Phase 47: Documentation Update

**Goal**: All documentation accurately reflects the infra-only Docker model, new defaults, and protocol enhancements
**Depends on**: Phases 43-46 (all feature work complete)
**Plans**: 2 plans

Plans:
- [x] 47-01-PLAN.md -- Rewrite README.md and docs/mcp-configuration.md for infra-only Docker model and simplified MCP setup
- [x] 47-02-PLAN.md -- Update 6 reference docs with parse health features, Roots capability, uvx commands, remove output blocks

**Details:**
- README rewritten with 3-step quick-start (MCP registration first, CLI secondary)
- All uvx examples use `git+https://github.com/VioletCranberry/coco-s` pattern
- COCOSEARCH_DATABASE_URL only in Custom Database Connection section
- All reference docs updated: cli-reference, architecture, dogfooding, mcp-tools, retrieval, search-features
- Output blocks removed from reference docs (commands only)
- Project detection priority chain documented: Roots > cwd > env > fallback

---

## Milestone Summary

**Key Decisions:**

- Docker = infra only (CocoSearch runs natively; Docker provides PostgreSQL+Ollama only)
- Docker base image switched from python:3.11-slim to debian:bookworm-slim
- PostgreSQL upgraded from 16 to 17 in Docker image
- Default DATABASE_URL to match Docker image creds, reduce setup friction
- Standardize cocosearch:cocosearch credentials everywhere
- _detect_project() returns tuple[Path, str] (never None) — cwd is unconditional fallback
- file:// URI parsing uses urlparse+unquote (NOT FileUrl.path)
- Only search_code is async; other tools remain sync (no Context needed)
- Parse tracking is non-fatal: wrapped in try/except in run_index()
- Post-flow tracking pattern: query chunks table, read from disk, process independently
- Parse health shown by default (not gated by --verbose); failure details require --show-failures
- include_failures defaults to false on both MCP tool and HTTP endpoints

**Issues Resolved:**

- Fixed `language` → `language_id` parameter bug in DevOps metadata extraction (FIX-01)
- Fixed wrong file path for parse_tracking.py in docs (management → indexer)
- Fixed wrong column names in retrieval.md parse_results table
- Fixed pre-existing test failures in TestIndexCodebase (register_index_path mock)

**Issues Deferred:**

- Multi-root project support (search across multiple roots) — deferred to PROTO-EXT-01
- MCP Roots change notification handling (invalidate cached detection) — deferred to PROTO-EXT-02
- Verbose parse failure output with file paths — deferred to OBS-EXT-01

**Technical Debt Incurred:**

- Pre-existing CLI test failure: test_valid_path_runs_indexing (missing register_index_path mock)
- Low-level server notification_handlers dict used for roots change (no FastMCP public API)

---

_For current project status, see .planning/ROADMAP.md_
