# Milestone v1.9: Multi-Repo & Polish

**Status:** SHIPPED 2026-02-06
**Phases:** 38-42
**Total Plans:** 11

## Overview

Enable single MCP registration for all projects, clean up technical debt, and document workflow patterns for users.

## Phases

### Phase 38: Multi-Repo MCP Support

**Goal**: Users can register CocoSearch once and use it across all their projects
**Depends on**: Phase 37 (v1.8 complete)
**Plans**: 2 plans

Plans:

- [x] 38-01: Add --project-from-cwd flag and staleness warnings
- [x] 38-02: Document user-scope MCP registration patterns

**Details:**
- Added `--project-from-cwd` CLI flag enabling workspace detection via COCOSEARCH_PROJECT_PATH environment variable
- Implemented search_context header and staleness_warning footer (7-day threshold)
- Documented single-registration MCP pattern for Claude Code (`claude mcp add --scope user`) and Claude Desktop
- Positioned user-scope registration as primary recommended pattern

### Phase 39: Test Fixes

**Goal**: Test suite passes reliably with correct signature format expectations
**Depends on**: Phase 38
**Plans**: 1 plan

Plans:

- [x] 39-01: Fix test failures (symbol signatures, CLI Namespace mocks, hybrid search mocks)

**Details:**
- Fixed 29 failing unit tests achieving green test suite (1022 tests passing)
- Fixed symbol signature extraction: changed colon-finding logic from `find(":")` to `rfind(":")` for definition-ending colon
- Increased signature truncation limit from 120 to 200 characters for realistic multiline signatures
- Added missing argparse.Namespace attributes to CLI test mocks (15 attributes added)
- Fixed hybrid search mocks by patching both hybrid and db module import paths

### Phase 40: Code Cleanup

**Goal**: Remove deprecated code and migration logic safely without breaking functionality
**Depends on**: Phase 39 (tests must pass first)
**Plans**: 2 plans

Plans:

- [x] 40-01: Remove deprecated languages.py and metadata.py re-export modules
- [x] 40-02: Remove v1.2 graceful degradation code from search modules

**Details:**
- Removed 137 LOC of backward-compatibility shim modules (languages.py, metadata.py)
- Removed ~100 LOC of pre-v1.2 backward compatibility code from search modules
- Metadata columns (block_type, hierarchy, language_id) now required — fail-fast with clear SQL errors
- Preserved v1.7 feature detection for content_text and symbol columns
- Research proved schema_migration.py is necessary PostgreSQL feature enhancement (not deprecated migration code)

### Phase 41: Workflow Skills

**Goal**: Users have multi-step workflow guidance for common tasks
**Depends on**: Phase 38 (multi-repo enables workflows)
**Plans**: 3 plans

Plans:

- [x] 41-01: Create onboarding workflow skill
- [x] 41-02: Create debugging workflow skill
- [x] 41-03: Create refactoring workflow skill

**Details:**
- Onboarding skill (162 lines): Adaptive codebase onboarding with staleness detection and architecture discovery
- Debugging skill (298 lines): Systematic debugging combining semantic + symbol search with root cause focus
- Refactoring skill (313 lines): Impact analysis with leaf-first execution ordering and confirmation gates
- All skills auto-execute MCP tools, adapt to codebase type, and check index freshness (7-day threshold)

### Phase 42: Technical Documentation

**Goal**: Users and contributors understand retrieval logic and MCP tool usage
**Depends on**: Phase 40 (document final implementation, not interim states)
**Plans**: 3 plans

Plans:

- [x] 42-01: Architecture overview and README documentation section
- [x] 42-02: Retrieval logic documentation (indexing + search pipelines)
- [x] 42-03: MCP tools reference with parameter docs and examples

**Details:**
- Architecture overview (88 lines): Core concepts primer, 6 major component areas, cross-references
- Retrieval logic (369 lines): 7-stage indexing pipeline, 9-stage search pipeline, RRF fusion formula with worked example, two-level query caching
- MCP tools reference (354 lines): 5-column parameter tables, dual-format examples (natural language + JSON), version-specific feature notes

---

## Milestone Summary

**Key Decisions:**

- Used environment variable (COCOSEARCH_PROJECT_PATH) for CLI-to-MCP workspace communication
- Fixed implementation bugs rather than updating tests to accept broken output
- Research proved schema_migration.py is necessary (not deprecated migration code)
- Removed pre-v1.2 graceful degradation — metadata columns now required
- Skills auto-execute MCP tools; conversational senior-developer tone
- Text-only architecture descriptions (no diagrams)
- Documented actual parameter values from source code (k=60, TTL=24h, chunk_size=1000)

**Issues Resolved:**

- 29 failing unit tests fixed (symbol signatures, CLI mocks, hybrid search mocks)
- Deprecated backward-compatibility shims removed (languages.py, metadata.py)
- Pre-v1.2 graceful degradation removed (fail-fast with clear errors)
- uvx cwd behavior documented with `--directory $(pwd)` workaround

**Issues Deferred:**

- PROTO-01: MCP Roots capability support (protocol-correct project detection)
- PROTO-02: HTTP transport project context via query params

**Technical Debt Incurred:**

None — clean milestone with no deferred items.

---

_For current project status, see .planning/MILESTONES.md_
