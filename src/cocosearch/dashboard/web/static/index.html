<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coco[-S]earch Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=VT323&display=swap" rel="stylesheet">
    <link id="favicon" rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='24' cy='24' r='20' fill='none' stroke='%23f0a060' stroke-width='5'/%3E%3Cline x1='38' y1='38' x2='58' y2='58' stroke='%23e07840' stroke-width='6' stroke-linecap='round'/%3E%3Ctext x='24' y='31' text-anchor='middle' font-family='Courier New,Courier,monospace' font-size='18' fill='%23f0a060' font-weight='bold'%3E%26lt;/%26gt;%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="terminal-header">
                <div class="terminal-banner-top">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                </div>
                <div class="terminal-title">
                    <h1 class="terminal-display phosphor-glow">Coco[-S]earch Terminal</h1>
                    <div class="terminal-subtitle">Local-first hybrid semantic code search</div>
                </div>
                <div class="terminal-features">
                    <span class="feature-pill">[vector+keyword]</span>
                    <span class="feature-pill">[Tree-sitter]</span>
                    <span class="feature-pill">[MCP]</span>
                    <span class="feature-pill">[pgvector]</span>
                    <span class="feature-pill">[Ollama]</span>
                </div>
                <div class="terminal-status-line">
                    <span>STATUS: <span class="status-ok">ONLINE</span></span>
                    <span id="uptime">UPTIME: --:--:--</span>
                    <button class="logs-btn">LOGS <span id="logBadge" class="log-badge"></span></button>
                </div>
            </div>
        </header>

        <div id="warningBanner" class="warning-banner">
            <h3>Index Warnings</h3>
            <ul id="warningList"></ul>
        </div>

        <div class="controls-grid">
            <div class="summary-card">
                <h3>Index</h3>
                <select id="indexSelect">
                    <option value="">Loading...</option>
                </select>
                <div class="action-buttons">
                    <button id="reindexBtn" class="action-btn">Reindex</button>
                    <button id="freshIndexBtn" class="action-btn danger">Fresh Index</button>
                    <button id="stopIndexBtn" class="action-btn danger" style="display: none;">Stop</button>
                    <button id="deleteIndexBtn" class="action-btn danger">Delete</button>
                </div>
            </div>
            <div class="summary-card">
                <h3>Repository</h3>
                <div id="branchBadge" class="branch-display" style="display: none;">
                    <span class="branch-line branch-name"></span>
                    <span class="branch-line branch-behind"></span>
                    <span class="branch-line branch-count"></span>
                </div>
                <div id="sourcePath" class="source-path"></div>
                <p id="repoUrl" class="repo-link" style="display: none;">
                    <a id="repoUrlLink" href="#" target="_blank" rel="noopener noreferrer"></a>
                </p>
            </div>
        </div>

        <div class="search-section">
            <h2>Search Code</h2>
            <!-- Search mode content -->
            <div id="searchModeContent">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search code with natural language..." autocomplete="off">
                    <button class="action-btn" id="searchBtn">Search</button>
                    <button class="action-btn" id="clearSearchBtn" style="display:none;">Clear</button>
                </div>
                <div class="search-filters">
                    <label>Language:
                        <select id="searchLanguage">
                            <option value="">All</option>
                        </select>
                    </label>
                    <label>Symbol Type:
                        <select id="searchSymbolType">
                            <option value="">All</option>
                            <option value="function">Function</option>
                            <option value="class">Class</option>
                            <option value="method">Method</option>
                            <option value="interface">Interface</option>
                        </select>
                    </label>
                </div>
                <details class="search-advanced">
                    <summary>Advanced filters</summary>
                    <div class="search-advanced-content">
                        <label>Min score: <input type="range" id="searchMinScore" min="0" max="1" step="0.05" value="0.3"> <span id="minScoreValue">0.3</span></label>
                        <label>Limit: <input type="number" id="searchLimit" min="1" max="50" value="10"></label>
                        <label title="Combines semantic (vector) and keyword (tsvector) search via RRF fusion. Auto enables it only for code identifiers (camelCase, snake_case, PascalCase).">Hybrid search:
                            <select id="searchHybrid">
                                <option value="auto" selected>Auto</option>
                                <option value="on">On</option>
                                <option value="off">Off</option>
                            </select>
                            <span style="font-size: 11px; color: var(--text-secondary); font-style: italic;">Auto = on for code identifiers only</span>
                        </label>
                    </div>
                </details>
                <div class="search-results-area">
                    <div class="search-loading" id="searchLoading">Searching...</div>
                    <div class="search-empty" id="searchEmpty"></div>
                    <div class="search-error" id="searchError"></div>
                    <div id="searchResultsInfo" class="search-results-info" style="display: none;"></div>
                    <div id="searchResults"></div>
                </div>
            </div>
        </div>

        <div id="statusBanner" class="status-banner"></div>

        <div id="notIndexedBanner" class="not-indexed-banner" style="display: none;">
            <h3>Project Not Indexed</h3>
            <p>Current project at <code id="notIndexedPath"></code> is not indexed.</p>
            <p>
                <button id="indexNowBtn" class="action-btn">Index Now</button>
                <span style="margin-left: 8px; font-size: 13px;">or run: <code>cocosearch index .</code></span>
            </p>
        </div>

        <div id="loadingMessage" class="loading">Loading dashboard data...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>

        <div id="dashboardContent" style="display: none;">
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Files Indexed</h3>
                    <div class="value" id="fileCount">-</div>
                    <div class="label">Total files</div>
                </div>
                <div class="summary-card">
                    <h3>Code Chunks</h3>
                    <div class="value" id="chunkCount">-</div>
                    <div class="label">Searchable chunks</div>
                </div>
                <div class="summary-card">
                    <h3>Storage Size</h3>
                    <div class="value" id="storageSize">-</div>
                    <div class="label">Database size</div>
                </div>
                <div class="summary-card">
                    <h3>Last Updated</h3>
                    <div class="value" id="lastUpdated">-</div>
                    <div class="label" id="stalenessLabel">Index age</div>
                </div>
                <div class="summary-card">
                    <h3>Status</h3>
                    <div class="value" id="indexStatus">-</div>
                    <div class="label" id="statusLabel">Index status</div>
                </div>
                <div class="summary-card">
                    <h3>Parse Health</h3>
                    <div class="value" id="parseHealth">-</div>
                    <div class="label" id="parseHealthLabel">File parse quality</div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-card">
                    <h2>Language Distribution (Chunks)</h2>
                    <div class="chart-container">
                        <canvas id="languageChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h2>Symbol Types</h2>
                    <div class="chart-container">
                        <canvas id="symbolChart"></canvas>
                    </div>
                </div>
                <div class="chart-card" id="grammarDistributionSection" style="display: none;">
                    <h2>Grammar Distribution</h2>
                    <div class="chart-container">
                        <canvas id="grammarChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="parseHealthSection" class="chart-card" style="display: none;">
                <h2>Parse Health by Language</h2>
                <table class="parse-table">
                    <thead>
                        <tr>
                            <th>Language</th>
                            <th class="num">Files</th>
                            <th class="num">OK</th>
                            <th class="num">Partial</th>
                            <th class="num">Error</th>
                            <th class="num">No Grammar</th>
                        </tr>
                    </thead>
                    <tbody id="parseTableBody"></tbody>
                </table>

            </div>

            <div id="grammarHealthSection" class="chart-card" style="display: none;">
                <h2>Parse Health by Grammar</h2>
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">Grammar handlers provide domain-specific chunking for specialized file formats. Health measures metadata extraction quality.</p>
                <table class="parse-table">
                    <thead>
                        <tr>
                            <th>Grammar</th>
                            <th>Format</th>
                            <th class="num">Files</th>
                            <th class="num">Chunks</th>
                            <th class="num">Recognized</th>
                            <th class="num">Unrecognized</th>
                            <th class="num">Health</th>
                        </tr>
                    </thead>
                    <tbody id="grammarHealthTableBody"></tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>CocoSearch Dashboard - Semantic Code Search</p>
        </footer>
    </div>

    <!-- File Viewer Modal -->
    <div id="fileModalBackdrop" class="file-modal-backdrop">
        <div class="file-modal">
            <div class="file-modal-header">
                <div class="file-info">
                    <span id="fileModalPath"></span>
                    <span id="fileModalLines" class="line-count"></span>
                </div>
                <button class="file-modal-close" title="Close (Esc)">&times;</button>
            </div>
            <div class="file-modal-body" id="fileModalBody">
                <pre class="line-numbers"><code id="fileModalCode"></code></pre>
            </div>
        </div>
    </div>

    <!-- Toast for error messages -->
    <div id="toast" class="toast"></div>

    <div id="disconnectOverlay" style="display:none; position:fixed; inset:0;
         background:rgba(0,0,0,0.85); z-index:9999; align-items:center;
         justify-content:center; flex-direction:column;">
        <p style="color:white; font-size:24px; font-weight:600;">Server Disconnected</p>
        <p style="color:#aaa; font-size:14px; margin-top:8px;">
            The CocoSearch server has stopped. You can close this tab.
        </p>
    </div>

    <!-- Log Panel -->
    <div id="logPanel" class="log-panel">
        <div class="log-panel-header">
            <h3>Server Logs</h3>
            <div class="log-header-btns">
                <button>Clear</button>
                <button>Close</button>
            </div>
        </div>
        <div class="log-panel-body" id="logPanelBody"></div>
        <div class="log-panel-footer">
            <span id="logLineCount">0 lines</span>
            <span id="logScrollIndicator" class="log-scroll-indicator">New logs below &#8595;</span>
        </div>
    </div>

    <script type="module" src="/static/js/app.js"></script>
</body>
</html>
