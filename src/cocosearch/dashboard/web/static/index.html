<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coco[-S]earch</title>
    <link id="favicon" rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='24' cy='24' r='20' fill='none' stroke='%23f0a060' stroke-width='5'/%3E%3Cline x1='38' y1='38' x2='58' y2='58' stroke='%23e07840' stroke-width='6' stroke-linecap='round'/%3E%3Ctext x='24' y='31' text-anchor='middle' font-family='Courier New,Courier,monospace' font-size='18' fill='%23f0a060' font-weight='bold'%3E%26lt;/%26gt;%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.7/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-card: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-muted: #999999;
            --accent-blue: #2196F3;
            --accent-green: #4CAF50;
            --accent-orange: #FF9800;
            --accent-red: #f44336;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        :root[data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #252525;
            --border-color: #404040;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #707070;
            --accent-blue: #64B5F6;
            --accent-green: #81C784;
            --accent-orange: #FFB74D;
            --accent-red: #E57373;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        .theme-toggle {
            padding: 4px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            transition: opacity 0.2s;
            line-height: 1;
        }

        .theme-toggle:hover {
            opacity: 0.8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 24px;
            padding-bottom: 16px;
        }

        .banner-container {
            position: relative;
        }

        .banner-container svg {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 12px;
        }

        .banner-container .theme-toggle {
            position: absolute;
            top: 12px;
            right: 12px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .controls-grid .summary-card {
            display: flex;
            flex-direction: column;
        }

        .controls-grid select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            margin-top: 4px;
        }

        .controls-grid .source-path {
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
            word-break: break-all;
        }

        .controls-grid .repo-link {
            margin-top: 6px;
        }

        .controls-grid .repo-link a {
            color: var(--accent-blue);
            text-decoration: none;
            font-size: 13px;
        }

        .controls-grid .repo-link a:hover {
            text-decoration: underline;
        }

        .controls-grid .branch-display {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 4px 0;
        }

        .controls-grid .action-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .controls-grid .action-row .action-btn {
            flex: 1;
            min-width: 0;
            text-align: center;
        }

        .controls-grid .danger-row {
            margin-top: auto;
            padding-top: 12px;
        }

        .controls-grid .danger-row .action-btn {
            width: 100%;
        }

        .warning-banner {
            background: var(--accent-red);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .warning-banner.visible {
            display: block;
        }

        .warning-banner h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .warning-banner ul {
            list-style: none;
            padding-left: 0;
        }

        .warning-banner li {
            padding: 4px 0;
            font-size: 14px;
        }

        .warning-banner li:before {
            content: "âš  ";
            margin-right: 8px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .summary-card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .summary-card .value {
            font-size: 32px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .summary-card .label {
            font-size: 13px;
            color: var(--text-muted);
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .chart-card h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-size: 16px;
        }

        .error {
            background: var(--accent-red);
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
        }

        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .action-btn {
            padding: 6px 14px;
            border: 1px solid var(--accent-blue);
            border-radius: 6px;
            background: var(--accent-blue);
            color: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .action-btn:hover:not(:disabled) {
            opacity: 0.85;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn.danger {
            background: var(--accent-red);
            border-color: var(--accent-red);
        }

        .status-banner {
            padding: 10px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }

        .status-banner.visible {
            display: block;
        }

        .status-banner.info {
            background: var(--accent-blue);
            color: white;
        }

        .status-banner.success {
            background: var(--accent-green);
            color: white;
        }

        .status-banner.error {
            background: var(--accent-red);
            color: white;
        }

        .not-indexed-banner {
            background: var(--accent-orange);
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .not-indexed-banner h3 {
            font-size: 16px;
            margin-bottom: 6px;
        }

        .not-indexed-banner p {
            font-size: 14px;
            margin-top: 6px;
        }

        .not-indexed-banner code {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }

        .parse-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .parse-table th {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .parse-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .parse-table tr:hover td {
            background: var(--bg-secondary);
        }

        .parse-table .num {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .status-ok { color: var(--accent-green); }
        .status-partial { color: var(--accent-orange); }
        .status-error { color: var(--accent-red); }
        .status-no-grammar { color: var(--text-muted); }

        .parse-details {
            margin-top: 16px;
        }

        .parse-details summary {
            cursor: pointer;
            padding: 10px 0;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
            list-style: none;
        }

        .parse-details summary::-webkit-details-marker {
            display: none;
        }

        .parse-details summary::before {
            content: "\25B6\00a0";
            font-size: 11px;
        }

        .parse-details[open] summary::before {
            content: "\25BC\00a0";
        }

        .failure-list {
            margin-top: 8px;
        }

        .failure-list table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .failure-list th {
            text-align: left;
            padding: 8px 10px;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .failure-list td {
            padding: 6px 10px;
            border-bottom: 1px solid var(--border-color);
            word-break: break-all;
        }

        .failure-list tr:hover td {
            background: var(--bg-secondary);
        }

        .failure-list .file-path {
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-primary);
        }

        .failure-list .error-msg {
            color: var(--text-secondary);
            font-size: 12px;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .expandable-row {
            cursor: pointer;
        }

        .expandable-row td:first-child::before {
            content: "\25B6\00a0";
            font-size: 10px;
            display: inline-block;
            transition: transform 0.15s;
        }

        .expandable-row.expanded td:first-child::before {
            transform: rotate(90deg);
        }

        .detail-row {
            display: none;
        }

        .detail-row.visible {
            display: table-row;
        }

        .detail-row td {
            padding: 0 12px 12px 28px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .detail-row .failure-list {
            margin-top: 0;
        }

        /* Search section */
        .search-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .search-section h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .search-mode-toggle {
            display: flex;
            gap: 0;
            margin-bottom: 14px;
        }
        .search-mode-toggle button {
            padding: 6px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
        }
        .search-mode-toggle button:first-child {
            border-radius: 6px 0 0 6px;
        }
        .search-mode-toggle button:last-child {
            border-radius: 0 6px 6px 0;
            border-left: none;
        }
        .search-mode-toggle button.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        .search-mode-toggle button.active + button {
            border-left: 1px solid var(--border-color);
        }
        .search-mode-toggle button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .search-bar input[type="text"] {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-bar input[type="text"]:focus {
            border-color: var(--accent-blue);
        }

        .search-bar input[type="text"]::placeholder {
            color: var(--text-muted);
        }

        .search-filters {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .search-filters label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .search-filters select {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .search-advanced {
            margin-top: 8px;
        }

        .search-advanced summary {
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            list-style: none;
            user-select: none;
        }

        .search-advanced summary::-webkit-details-marker {
            display: none;
        }

        .search-advanced summary::before {
            content: "\25B6\00a0";
            font-size: 10px;
        }

        .search-advanced[open] summary::before {
            content: "\25BC\00a0";
        }

        .search-advanced-content {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 8px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .search-advanced-content label {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .search-advanced-content input[type="range"] {
            width: 100px;
        }

        .search-advanced-content input[type="number"] {
            width: 60px;
            padding: 4px 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 13px;
        }

        .search-results-area {
            margin-top: 16px;
        }

        .search-results-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .search-loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            display: none;
        }

        .search-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 14px;
            display: none;
        }

        .search-error {
            background: var(--accent-red);
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }

        .search-result-card {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .search-result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 8px;
        }

        .search-result-path {
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            color: var(--accent-blue);
            font-weight: 500;
            word-break: break-all;
        }

        .search-result-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-result-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-score-high { background: var(--accent-green); color: white; }
        .badge-score-mid { background: var(--accent-orange); color: white; }
        .badge-score-low { background: var(--text-muted); color: white; }
        .badge-match { background: var(--accent-blue); color: white; }
        .badge-lang { background: var(--border-color); color: var(--text-primary); }

        .search-result-symbol {
            padding: 6px 14px;
            font-size: 13px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
        }

        .search-result-code {
            padding: 12px 14px;
            background: var(--bg-card);
            overflow-x: auto;
        }

        .search-result-code pre {
            margin: 0;
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-break: break-all;
        }

        .search-result-code .expand-btn {
            display: inline-block;
            margin-top: 4px;
            font-size: 12px;
            color: var(--accent-blue);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            font-family: inherit;
        }

        .search-result-code .expand-btn:hover {
            text-decoration: underline;
        }

        .search-result-actions {
            display: flex;
            gap: 8px;
            padding: 8px 14px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .search-result-actions button {
            padding: 4px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .search-result-actions button:hover {
            background: var(--bg-secondary);
        }

        /* Clickable file path */
        .search-result-path.clickable {
            cursor: pointer;
            transition: color 0.15s;
        }

        .search-result-path.clickable:hover {
            text-decoration: underline;
        }

        .search-result-path.clickable.copied {
            color: var(--accent-green);
        }

        /* File viewer modal */
        .file-modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .file-modal-backdrop.visible {
            display: flex;
        }

        .file-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            width: 90vw;
            height: 85vh;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .file-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .file-modal-header .file-info {
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            color: var(--accent-blue);
            word-break: break-all;
        }

        .file-modal-header .file-info .line-count {
            color: var(--text-muted);
            font-size: 12px;
            margin-left: 12px;
        }

        .file-modal-close {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 2px 10px;
            line-height: 1;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .file-modal-close:hover {
            background: var(--bg-secondary);
        }

        .file-modal-body {
            flex: 1;
            overflow: auto;
            padding: 0;
        }

        .file-modal-body pre {
            margin: 0;
            font-size: 13px;
            line-height: 1.5;
            border-radius: 0;
            background: var(--bg-card) !important;
        }

        .file-modal-body pre code {
            background: none !important;
        }

        .file-modal-body .line-highlight {
            background: rgba(255, 200, 50, 0.15) !important;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--accent-red);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .toast.visible {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .search-filters {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Inline AI Chat (inside search section) */
        .chat-inline-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
        }
        .chat-new-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            padding: 4px 10px;
        }
        .chat-new-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .chat-inline-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .chat-inline-bar textarea {
            flex: 1;
            resize: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            outline: none;
            min-height: 40px;
            max-height: 120px;
            transition: border-color 0.2s;
        }
        .chat-inline-bar textarea:focus {
            border-color: var(--accent-blue);
        }
        .chat-inline-bar textarea::placeholder {
            color: var(--text-muted);
        }
        .chat-inline-bar button {
            align-self: flex-end;
            padding: 10px 16px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: opacity 0.15s;
        }
        .chat-inline-bar button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .chat-inline-bar button:hover:not(:disabled) {
            opacity: 0.9;
        }

        .chat-messages {
            max-height: 500px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 4px 0;
        }

        .chat-msg {
            max-width: 88%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
            word-break: break-word;
        }
        .chat-msg.user {
            white-space: pre-wrap;
            align-self: flex-end;
            background: var(--accent-blue);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-msg.assistant {
            align-self: flex-start;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }
        .chat-msg.error {
            align-self: center;
            background: var(--accent-red);
            color: white;
            font-size: 12px;
            opacity: 0.9;
        }

        .chat-typing {
            display: none;
            align-self: flex-start;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border-radius: 12px;
            font-size: 13px;
            color: var(--text-muted);
        }
        .chat-typing.active { display: block; }
        .chat-typing::after {
            content: '';
            animation: typingDots 1.2s infinite;
        }
        @keyframes typingDots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .chat-tool-use {
            align-self: flex-start;
            max-width: 88%;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .chat-tool-use summary {
            cursor: pointer;
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            list-style: none;
            user-select: none;
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
        }
        .chat-tool-use summary::-webkit-details-marker {
            display: none;
        }
        .chat-tool-use summary::before {
            content: "\25B6\00a0";
            font-size: 9px;
        }
        .chat-tool-use[open] summary::before {
            content: "\25BC\00a0";
        }
        .chat-tool-use .tool-input {
            margin-top: 4px;
            padding: 8px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--text-primary);
        }

        .chat-stats-bar {
            display: none;
            font-size: 12px;
            color: var(--text-muted);
            padding: 6px 0;
            border-top: 1px solid var(--border-color);
            margin-top: 8px;
        }
        .chat-stats-bar.visible {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .chat-msg.assistant {
            line-height: 1.6;
        }
        .chat-msg.assistant pre {
            margin: 8px 0;
            padding: 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .chat-msg.assistant code {
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }
        .chat-msg.assistant code:not(pre code) {
            background: var(--bg-primary);
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid var(--border-color);
        }
        .chat-msg.assistant p { margin: 4px 0; }
        .chat-msg.assistant ul, .chat-msg.assistant ol { margin: 4px 0; padding-left: 20px; }
        .chat-msg.assistant h1, .chat-msg.assistant h2, .chat-msg.assistant h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 8px 0 4px;
        }
        .chat-msg.assistant blockquote {
            border-left: 3px solid var(--accent-blue);
            margin: 4px 0;
            padding: 2px 10px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="banner-container">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 960 195">
                    <!-- Background -->
                    <rect width="960" height="195" rx="12" fill="var(--bg-card)"/>
                    <rect x=".5" y=".5" width="959" height="194" rx="11.5" fill="none" stroke="var(--border-color)"/>

                    <!-- Background: faint vector-embedding network -->
                    <g opacity=".06" fill="var(--accent-blue)" stroke="var(--accent-blue)" stroke-width=".5">
                        <circle cx="700" cy="30" r="2.5"/><circle cx="780" cy="55" r="2"/>
                        <circle cx="840" cy="25" r="2.5"/><circle cx="900" cy="60" r="2.5"/>
                        <circle cx="650" cy="70" r="2"/><circle cx="920" cy="100" r="2"/>
                        <line x1="700" y1="30" x2="780" y2="55"/>
                        <line x1="780" y1="55" x2="840" y2="25"/>
                        <line x1="840" y1="25" x2="900" y2="60"/>
                        <line x1="650" y1="70" x2="700" y2="30"/>
                        <line x1="900" y1="60" x2="920" y2="100"/>
                    </g>

                    <!-- Subtle glow behind icon -->
                    <circle cx="90" cy="65" r="50" fill="#f0a060" opacity=".025"/>

                    <!-- Magnifying glass icon -->
                    <g transform="translate(45,22)">
                        <circle cx="45" cy="45" r="34" fill="none" stroke="#f0a060" stroke-width="4" opacity=".9"/>
                        <line x1="70" y1="70" x2="92" y2="92" stroke="#e07840" stroke-width="5" stroke-linecap="round" opacity=".9"/>
                        <text x="45" y="53" text-anchor="middle" font-family="'Courier New',Courier,monospace" font-size="22" fill="#f0a060" font-weight="bold" opacity=".85">&lt;/&gt;</text>
                    </g>

                    <!-- Title: Coco[-S]earch -->
                    <text x="195" y="68" font-family="-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif" font-size="44" font-weight="bold" letter-spacing="-0.5">
                        <tspan fill="var(--text-primary)">Coco</tspan><tspan fill="#f0a060">[-S]</tspan><tspan fill="var(--text-primary)">earch</tspan>
                    </text>

                    <!-- Tagline -->
                    <text x="197" y="95" font-family="-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif" font-size="15" fill="var(--text-secondary)" letter-spacing=".3">
                        Local-first hybrid semantic code search
                    </text>

                    <!-- Powered by CocoIndex -->
                    <a href="https://cocoindex.io/" target="_blank">
                        <text x="197" y="116" font-family="-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif" font-size="12" fill="var(--text-secondary)" letter-spacing=".2" cursor="pointer">
                            Powered by
                        </text>
                        <g transform="translate(266, 102) scale(0.22)" cursor="pointer">
                            <path d="M33.4042 3.79296C34.9133 5.91332 34.7839 7.4124 34.7839 7.4124L33.8438 6.63876L33.0059 5.96402L31.2349 4.47686L29.7071 3.11444C29.7071 3.11444 28.9421 2.42034 28.6474 2.19864C28.3529 1.97695 28.7162 1.1693 29.3688 0.888341C30.0215 0.60739 30.6482 1.12314 30.6482 1.12314C30.6482 1.12314 31.8953 1.67259 33.4042 3.79296Z" fill="#532638"/>
                            <path d="M37.5571 2.80507C31.1215 6.77707 29.1611 9.55316 26.6719 14.8408C26.6719 14.8408 41.7846 21.0814 43.3814 21.0814C44.9781 21.0814 48.9255 21.0635 52.1916 18.6036C55.4579 16.1439 58.3907 11.301 60.9087 5.67751C55.5736 1.67877 53.6973 0.100496 46.7475 0.00268351C43.0769 0.186756 40.4667 1.15692 37.5571 2.80507Z" fill="#27E62B" fill-opacity="0.75"/>
                            <path d="M50.3753 3.53458C50.2853 4.64109 49.2159 5.45604 47.9867 5.35479C46.7574 5.25355 45.834 4.27447 45.924 3.16796C46.0141 2.06143 47.0835 1.24649 48.3127 1.34773C49.5419 1.44898 50.4653 2.42806 50.3753 3.53458Z" fill="#F6F4E9"/>
                            <path d="M31.6743 64C47.8704 64 61 50.8704 61 34.6743C61 18.4782 47.8704 5.34863 31.6743 5.34863C15.4782 5.34863 2.34863 18.4782 2.34863 34.6743C2.34863 50.8704 15.4782 64 31.6743 64Z" fill="#BE5133"/>
                            <path d="M15.5909 9.8732C11.0784 12.8518 7.63052 16.3702 5.42887 21.8039C3.22726 27.2378 8.9263 35.1807 16.5577 39.1685C23.9127 42.4567 28.0337 42.8053 35.3819 42.3579C41.7961 41.775 46.7476 40.3498 51.4831 36.6878C56.2189 33.0259 60.2441 25.8202 57.9947 21.2133C55.7453 16.6064 53.1406 13.2989 48.0498 9.99134C42.959 6.68378 37.2567 5.14819 31.2383 5.14819C25.0128 5.18257 20.7807 6.44761 15.5909 9.8732Z" fill="#FCF3D8"/>
                            <path d="M17.5403 11.9046C13.6044 14.3555 10.5968 17.2503 8.67642 21.7211C6.75612 26.192 11.7271 32.7274 18.3835 36.0084C24.7989 38.7139 28.3934 39.0008 34.8029 38.6326C40.3977 38.153 44.7166 36.9803 48.8472 33.9674C52.9778 30.9544 56.489 25.0256 54.5268 21.2352C52.5648 17.4447 50.2929 14.7233 45.8525 12.0018C41.412 9.28054 36.4382 8.01697 31.1886 8.01697C25.7585 8.04531 22.067 9.08614 17.5403 11.9046Z" fill="#E59A63"/>
                            <path d="M19.6169 15.5315C21.2266 15.243 22.4381 14.4881 22.3229 13.8452C22.2078 13.2024 20.8095 12.9151 19.1998 13.2036C17.5901 13.492 16.3785 14.2469 16.4937 14.8898C16.6089 15.5326 18.0072 15.8199 19.6169 15.5315Z" fill="#401D30"/>
                            <path d="M44.1057 15.3863C45.7267 15.602 47.1107 15.2521 47.1968 14.6047C47.2829 13.9574 46.0386 13.2577 44.4176 13.042C42.7965 12.8263 41.4126 13.1763 41.3265 13.8236C41.2403 14.471 42.4846 15.1707 44.1057 15.3863Z" fill="#401D30"/>
                            <path d="M15.5914 32.8493C17.5506 32.8493 19.1389 32.0022 19.1389 30.9573C19.1389 29.9124 17.5506 29.0653 15.5914 29.0653C13.6322 29.0653 12.0439 29.9124 12.0439 30.9573C12.0439 32.0022 13.6322 32.8493 15.5914 32.8493Z" fill="#FB6A76"/>
                            <path d="M47.9938 32.8493C49.953 32.8493 51.5412 32.0022 51.5412 30.9573C51.5412 29.9124 49.953 29.0653 47.9938 29.0653C46.0345 29.0653 44.4463 29.9124 44.4463 30.9573C44.4463 32.0022 46.0345 32.8493 47.9938 32.8493Z" fill="#FB6A76"/>
                            <path d="M19.6133 28.8288C22.6174 28.8288 25.0527 26.3935 25.0527 23.3894C25.0527 20.3853 22.6174 17.95 19.6133 17.95C16.6092 17.95 14.1738 20.3853 14.1738 23.3894C14.1738 26.3935 16.6092 28.8288 19.6133 28.8288Z" fill="#401D30"/>
                            <path d="M18.2233 23.2782C19.4378 23.2782 20.4223 22.4333 20.4223 21.3911C20.4223 20.3488 19.4378 19.5039 18.2233 19.5039C17.0089 19.5039 16.0244 20.3488 16.0244 21.3911C16.0244 22.4333 17.0089 23.2782 18.2233 23.2782Z" fill="#F6F4E9"/>
                            <path d="M43.7363 28.8288C46.7404 28.8288 49.1758 26.3935 49.1758 23.3894C49.1758 20.3853 46.7404 17.95 43.7363 17.95C40.7322 17.95 38.2969 20.3853 38.2969 23.3894C38.2969 26.3935 40.7322 28.8288 43.7363 28.8288Z" fill="#401D30"/>
                            <path d="M42.3454 23.2782C43.5599 23.2782 44.5443 22.4333 44.5443 21.3911C44.5443 20.3488 43.5599 19.5039 42.3454 19.5039C41.131 19.5039 40.1465 20.3488 40.1465 21.3911C40.1465 22.4333 41.131 23.2782 42.3454 23.2782Z" fill="#F6F4E9"/>
                            <path d="M29.8696 58.9869C28.9046 58.8637 26.5628 52.2516 27.741 47.2803C28.7819 46.4149 29.3351 46.6899 29.5148 47.7533C28.6018 53.5402 29.582 55.2282 31.4068 58.1593C31.1188 58.9953 30.8345 59.1103 29.8696 58.9869Z" fill="#6A1E23"/>
                            <path d="M52.8392 42.5597C52.9484 41.49 50.8299 40.5119 50.9472 42.5597C51.0645 44.6074 48.9879 51.68 48.2275 52.7291C47.467 53.7783 48.7004 54.6213 49.8829 53.7933C51.0655 52.9654 52.7299 43.6293 52.8392 42.5597Z" fill="#7A2826"/>
                            <path d="M13.2275 46.6747C13.4907 45.4299 14.5282 45.2557 14.883 46.32C15.2377 47.3842 16.1988 50.3787 17.9574 53.1783C19.613 55.0704 20.614 55.289 22.3327 56.2529C22.6213 56.8188 22.2145 57.5537 21.7414 57.6718C21.2684 57.7901 19.2582 56.8441 17.8392 55.4251C16.8573 54.2907 16.3012 53.7482 15.356 51.9959C14.347 50.0524 13.8211 48.9327 13.2275 46.6747Z" fill="#6A1E23"/>
                            <path d="M28.6378 24.378L28.6164 24.3595C28.4103 24.1852 28.0484 24.2038 27.7978 24.3041C27.6929 24.3461 27.6029 24.4183 27.5391 24.5116L27.5278 24.528C27.4557 24.6335 27.417 24.7585 27.417 24.8865V25.0448C27.417 25.3572 27.4766 25.6668 27.5927 25.9569L27.6535 26.109L27.7639 26.3021C28.004 26.7224 28.3161 27.1053 28.6779 27.427C29.0146 27.7262 29.4003 27.9759 29.812 28.1589C30.1064 28.2897 30.4144 28.3877 30.7304 28.4508L30.9722 28.4992C31.2817 28.5611 31.5964 28.5923 31.9119 28.5923H31.93C32.3097 28.5923 32.688 28.5456 33.0564 28.4536C33.3168 28.3885 33.5711 28.3009 33.8163 28.1919L34.0646 28.0816C34.3613 27.9497 34.6372 27.7755 34.8837 27.5642C35.1853 27.3056 35.4384 26.9955 35.6314 26.6482L35.756 26.424C35.872 26.2149 35.9604 25.9915 36.0183 25.7595L36.0897 25.4742C36.1409 25.2694 36.146 25.0556 36.1046 24.8485L36.0762 24.7069C36.0584 24.6177 36.0232 24.5329 35.9728 24.4572C35.8702 24.3034 35.7109 24.1967 35.5297 24.1605L35.4845 24.1514C35.314 24.1173 35.137 24.141 34.9816 24.2188L34.9434 24.2379C34.8169 24.3012 34.7142 24.4037 34.6509 24.5303C34.6372 24.5579 34.6253 24.5865 34.6155 24.6159L34.5757 24.7351C34.5335 24.8619 34.512 24.9946 34.512 25.1282C34.512 25.2299 34.4994 25.3312 34.4749 25.4297L34.4664 25.4631C34.4184 25.6553 34.3325 25.8359 34.2137 25.9944C34.0983 26.1481 33.9542 26.2781 33.7894 26.377L33.6601 26.4546C33.5189 26.5393 33.3689 26.6083 33.2128 26.6603L32.9847 26.7363C32.8206 26.7911 32.6526 26.8328 32.482 26.8612C32.1813 26.9114 31.875 26.9197 31.572 26.886L31.3313 26.8593C31.0877 26.8323 30.8484 26.775 30.6188 26.6889L30.5298 26.6555C30.1928 26.5292 29.8868 26.3321 29.6323 26.0776C29.4185 25.8638 29.2449 25.6133 29.1198 25.338L28.7631 24.5534C28.7331 24.4874 28.6921 24.426 28.6378 24.378Z" fill="#401E2B"/>
                        </g>
                        <text x="282" y="116" font-family="-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif" font-size="12" fill="#f0a060" letter-spacing=".2" cursor="pointer">
                            CocoIndex
                        </text>
                    </a>

                    <!-- Feature pills (horizontal row) -->
                    <g font-family="-apple-system,'Segoe UI',Helvetica,Arial,sans-serif" font-size="11" fill="var(--text-secondary)">
                        <rect x="30" y="140" width="110" height="26" rx="13" fill="none" stroke="var(--border-color)"/>
                        <text x="85" y="157" text-anchor="middle">Vector + Keyword</text>

                        <a href="https://tree-sitter.github.io/tree-sitter/" target="_blank">
                            <rect x="150" y="140" width="95" height="26" rx="13" fill="none" stroke="var(--border-color)" cursor="pointer"/>
                            <text x="197" y="157" text-anchor="middle" cursor="pointer">Tree-sitter</text>
                        </a>

                        <a href="https://modelcontextprotocol.io/" target="_blank">
                            <rect x="255" y="140" width="65" height="26" rx="13" fill="none" stroke="var(--border-color)" cursor="pointer"/>
                            <text x="287" y="157" text-anchor="middle" cursor="pointer">MCP</text>
                        </a>

                        <a href="https://github.com/pgvector/pgvector" target="_blank">
                            <rect x="330" y="140" width="80" height="26" rx="13" fill="none" stroke="var(--border-color)" cursor="pointer"/>
                            <text x="370" y="157" text-anchor="middle" cursor="pointer">pgvector</text>
                        </a>

                        <a href="https://ollama.com/" target="_blank">
                            <rect x="420" y="140" width="75" height="26" rx="13" fill="none" stroke="var(--border-color)" cursor="pointer"/>
                            <text x="457" y="157" text-anchor="middle" cursor="pointer">Ollama</text>
                        </a>

                        <a href="https://www.postgresql.org/" target="_blank">
                            <rect x="505" y="140" width="95" height="26" rx="13" fill="none" stroke="var(--border-color)" cursor="pointer"/>
                            <text x="552" y="157" text-anchor="middle" cursor="pointer">PostgreSQL</text>
                        </a>

                        <a href="https://www.docker.com/" target="_blank">
                            <rect x="610" y="140" width="75" height="26" rx="13" fill="none" stroke="var(--border-color)" cursor="pointer"/>
                            <text x="647" y="157" text-anchor="middle" cursor="pointer">Docker</text>
                        </a>
                    </g>
                </svg>
                <button id="themeToggle" class="theme-toggle" onclick="cycleTheme()" title="Theme: System"></button>
            </div>
        </header>

        <div class="controls-grid">
            <div class="summary-card">
                <h3>Index</h3>
                <select id="indexSelect">
                    <option value="">Loading...</option>
                </select>
                <div id="sourcePath" class="source-path"></div>
                <p id="repoUrl" class="repo-link" style="display: none;">
                    <a id="repoUrlLink" href="#" target="_blank" rel="noopener noreferrer"></a>
                </p>
            </div>
            <div class="summary-card">
                <h3>Repository</h3>
                <span id="branchBadge" class="branch-display" style="display: none;"></span>
                <div class="label">Branch &amp; commit</div>
            </div>
            <div class="summary-card">
                <h3>Actions</h3>
                <div class="action-row">
                    <button id="reindexBtn" class="action-btn" onclick="reindex(false)">Reindex</button>
                    <button id="freshIndexBtn" class="action-btn danger" onclick="reindex(true)">Fresh Index</button>
                    <button id="stopIndexBtn" class="action-btn danger" onclick="stopIndexing()" style="display: none;">Stop</button>
                </div>
                <div class="danger-row">
                    <button id="deleteIndexBtn" class="action-btn danger" onclick="deleteIndex()">Delete</button>
                </div>
            </div>
        </div>

        <div class="search-section">
            <h2>Search Code</h2>
            <div class="search-mode-toggle">
                <button id="modeSearchBtn" class="active" onclick="switchSearchMode('search')">Search</button>
                <button id="modeAskAIBtn" onclick="switchSearchMode('chat')" disabled title="Checking AI availability...">Ask AI</button>
            </div>

            <!-- Search mode content (existing) -->
            <div id="searchModeContent">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search code with natural language..." autocomplete="off">
                    <button class="action-btn" id="searchBtn" onclick="executeSearch()">Search</button>
                    <button class="action-btn" id="clearSearchBtn" onclick="clearSearch()" style="display:none;">Clear</button>
                </div>
                <div class="search-filters">
                    <label>Language:
                        <select id="searchLanguage">
                            <option value="">All</option>
                        </select>
                    </label>
                    <label>Symbol Type:
                        <select id="searchSymbolType">
                            <option value="">All</option>
                            <option value="function">Function</option>
                            <option value="class">Class</option>
                            <option value="method">Method</option>
                            <option value="interface">Interface</option>
                        </select>
                    </label>
                </div>
                <details class="search-advanced">
                    <summary>Advanced filters</summary>
                    <div class="search-advanced-content">
                        <label>Min score: <input type="range" id="searchMinScore" min="0" max="1" step="0.05" value="0.3"> <span id="minScoreValue">0.3</span></label>
                        <label>Limit: <input type="number" id="searchLimit" min="1" max="50" value="10"></label>
                        <label title="Combines semantic (vector) and keyword (tsvector) search via RRF fusion. Auto enables it only for code identifiers (camelCase, snake_case, PascalCase).">Hybrid search:
                            <select id="searchHybrid">
                                <option value="auto" selected>Auto</option>
                                <option value="on">On</option>
                                <option value="off">Off</option>
                            </select>
                            <span style="font-size: 11px; color: var(--text-secondary); font-style: italic;">Auto = on for code identifiers only</span>
                        </label>
                    </div>
                </details>
                <div class="search-results-area">
                    <div class="search-loading" id="searchLoading">Searching...</div>
                    <div class="search-empty" id="searchEmpty"></div>
                    <div class="search-error" id="searchError"></div>
                    <div id="searchResultsInfo" class="search-results-info" style="display: none;"></div>
                    <div id="searchResults"></div>
                </div>
            </div>

            <!-- Ask AI mode content -->
            <div id="chatModeContent" style="display: none;">
                <div class="chat-inline-header">
                    <button onclick="startNewChatSession()" title="New conversation" class="chat-new-btn">New conversation</button>
                </div>
                <div class="chat-inline-bar">
                    <textarea id="chatInput" placeholder="Ask about your codebase..." rows="1"
                              onkeydown="handleChatKey(event)"></textarea>
                    <button id="chatSend" onclick="sendChatMessage()">Send</button>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div id="chatTyping" class="chat-typing">Thinking</div>
                <div id="chatStatsBar" class="chat-stats-bar"></div>
            </div>
        </div>

        <div id="statusBanner" class="status-banner"></div>

        <div id="notIndexedBanner" class="not-indexed-banner" style="display: none;">
            <h3>Project Not Indexed</h3>
            <p>Current project at <code id="notIndexedPath"></code> is not indexed.</p>
            <p>
                <button id="indexNowBtn" class="action-btn" onclick="indexCurrentProject()">Index Now</button>
                <span style="margin-left: 8px; font-size: 13px;">or run: <code>cocosearch index .</code></span>
            </p>
        </div>

        <div id="warningBanner" class="warning-banner">
            <h3>Index Warnings</h3>
            <ul id="warningList"></ul>
        </div>

        <div id="loadingMessage" class="loading">Loading dashboard data...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>

        <div id="dashboardContent" style="display: none;">
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Files Indexed</h3>
                    <div class="value" id="fileCount">-</div>
                    <div class="label">Total files</div>
                </div>
                <div class="summary-card">
                    <h3>Code Chunks</h3>
                    <div class="value" id="chunkCount">-</div>
                    <div class="label">Searchable chunks</div>
                </div>
                <div class="summary-card">
                    <h3>Storage Size</h3>
                    <div class="value" id="storageSize">-</div>
                    <div class="label">Database size</div>
                </div>
                <div class="summary-card">
                    <h3>Last Updated</h3>
                    <div class="value" id="lastUpdated">-</div>
                    <div class="label" id="stalenessLabel">Index age</div>
                </div>
                <div class="summary-card">
                    <h3>Status</h3>
                    <div class="value" id="indexStatus">-</div>
                    <div class="label" id="statusLabel">Index status</div>
                </div>
                <div class="summary-card">
                    <h3>Parse Health</h3>
                    <div class="value" id="parseHealth">-</div>
                    <div class="label" id="parseHealthLabel">File parse quality</div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-card">
                    <h2>Language Distribution (Chunks)</h2>
                    <div class="chart-container">
                        <canvas id="languageChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h2>Symbol Types</h2>
                    <div class="chart-container">
                        <canvas id="symbolChart"></canvas>
                    </div>
                </div>
                <div class="chart-card" id="grammarDistributionSection" style="display: none;">
                    <h2>Grammar Distribution</h2>
                    <div class="chart-container">
                        <canvas id="grammarChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="parseHealthSection" class="chart-card" style="display: none;">
                <h2>Parse Health by Language</h2>
                <table class="parse-table">
                    <thead>
                        <tr>
                            <th>Language</th>
                            <th class="num">Files</th>
                            <th class="num">OK</th>
                            <th class="num">Partial</th>
                            <th class="num">Error</th>
                            <th class="num">No Grammar</th>
                        </tr>
                    </thead>
                    <tbody id="parseTableBody"></tbody>
                </table>

            </div>

            <div id="grammarHealthSection" class="chart-card" style="display: none;">
                <h2>Parse Health by Grammar</h2>
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">Grammar handlers provide domain-specific chunking for specialized file formats. Health measures metadata extraction quality.</p>
                <table class="parse-table">
                    <thead>
                        <tr>
                            <th>Grammar</th>
                            <th>Format</th>
                            <th class="num">Files</th>
                            <th class="num">Chunks</th>
                            <th class="num">Recognized</th>
                            <th class="num">Unrecognized</th>
                            <th class="num">Health</th>
                        </tr>
                    </thead>
                    <tbody id="grammarHealthTableBody"></tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>CocoSearch Dashboard - Semantic Code Search</p>
        </footer>
    </div>

    <script>
        let languageChart = null;
        let symbolChart = null;
        let grammarChart = null;
        let allIndexes = [];
        let projectContext = null;
        let parseFailuresData = [];
        let grammarFailuresData = [];

        function isDarkMode() {
            return document.documentElement.getAttribute('data-theme') === 'dark';
        }

        function applyTheme(mode) {
            document.documentElement.setAttribute('data-theme', mode);
            const btn = document.getElementById('themeToggle');
            btn.textContent = mode === 'dark' ? '\u{1F319}' : '\u2600\uFE0F';
            btn.title = 'Switch to ' + (mode === 'dark' ? 'light' : 'dark') + ' theme';
        }

        function cycleTheme() {
            const next = isDarkMode() ? 'light' : 'dark';
            localStorage.setItem('cocosearch-theme', next);
            applyTheme(next);
            // Refresh charts with new colors
            const select = document.getElementById('indexSelect');
            const indexIndex = parseInt(select.value);
            if (!isNaN(indexIndex) && allIndexes[indexIndex]) {
                updateDashboard(allIndexes[indexIndex]);
            }
        }

        // Apply saved theme (default to OS preference on first visit)
        (function() {
            let saved = localStorage.getItem('cocosearch-theme');
            if (!saved) {
                saved = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            applyTheme(saved);
        })();

        async function loadProjectContext() {
            try {
                const resp = await fetch('/api/project');
                if (!resp.ok) return null;
                const data = await resp.json();
                return data.has_project ? data : null;
            } catch { return null; }
        }

        async function fetchStats(indexName = null) {
            let url = indexName
                ? `/api/stats?index=${encodeURIComponent(indexName)}&include_failures=true`
                : '/api/stats?include_failures=true';

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return await response.json();
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            if (diffDays === 0) return 'Today ' + time;
            if (diffDays === 1) return 'Yesterday ' + time;
            if (diffDays < 7) return `${diffDays} days ago`;

            if (date.getFullYear() === now.getFullYear()) {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ', ' + time;
            }
            return date.toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' }) + ', ' + time;
        }

        function updateTabStatus(status) {
            const colorMap = {
                indexing: { primary: '#FF9800', secondary: '#e07840' },
                indexed:  { primary: '#4CAF50', secondary: '#388E3C' },
                error:    { primary: '#f44336', secondary: '#d32f2f' },
            };
            const defaultColors = { primary: '#f0a060', secondary: '#e07840' };
            const colors = colorMap[status] || defaultColors;

            const titleMap = {
                indexing: 'Indexing\u2026 \u00b7 Coco[-S]earch',
                indexed:  'Indexed \u00b7 Coco[-S]earch',
                error:    'Error \u00b7 Coco[-S]earch',
            };
            document.title = titleMap[status] || 'Coco[-S]earch';

            const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>`
                + `<circle cx='24' cy='24' r='20' fill='none' stroke='${colors.primary}' stroke-width='5'/>`
                + `<line x1='38' y1='38' x2='58' y2='58' stroke='${colors.secondary}' stroke-width='6' stroke-linecap='round'/>`
                + `<text x='24' y='31' text-anchor='middle' font-family='Courier New,Courier,monospace' font-size='18' fill='${colors.primary}' font-weight='bold'>&lt;/&gt;</text>`
                + `</svg>`;
            const favicon = document.getElementById('favicon');
            if (favicon) {
                favicon.href = 'data:image/svg+xml,' + encodeURIComponent(svg);
            }
        }

        function updateSummaryCards(stats) {
            document.getElementById('fileCount').textContent = formatNumber(stats.file_count);
            document.getElementById('chunkCount').textContent = formatNumber(stats.chunk_count);
            document.getElementById('storageSize').textContent = stats.storage_size_pretty;

            const updatedDate = formatDate(stats.updated_at);
            document.getElementById('lastUpdated').textContent = updatedDate;

            if (stats.staleness_days !== null && stats.staleness_days >= 0) {
                document.getElementById('stalenessLabel').textContent = `${stats.staleness_days} days old`;
            } else {
                document.getElementById('stalenessLabel').textContent = 'Index age';
            }

            // Source path
            const sourceEl = document.getElementById('sourcePath');
            if (stats.source_path) {
                sourceEl.textContent = stats.source_path;
            } else {
                sourceEl.textContent = '';
            }

            // Repo URL
            const repoUrlEl = document.getElementById('repoUrl');
            const repoUrlLink = document.getElementById('repoUrlLink');
            if (stats.repo_url) {
                repoUrlLink.href = stats.repo_url;
                repoUrlLink.textContent = stats.repo_url.replace(/^https?:\/\//, '');
                repoUrlEl.style.display = 'block';
            } else {
                repoUrlEl.style.display = 'none';
            }

            // Branch badge
            const branchBadge = document.getElementById('branchBadge');
            if (stats.branch) {
                const parts = [stats.branch + (stats.commit_hash ? ' (' + stats.commit_hash + ')' : '')];
                if (stats.commits_behind !== null && stats.commits_behind !== undefined) {
                    parts.push(stats.commits_behind === 0 ? 'up to date' : stats.commits_behind + ' commits behind');
                }
                if (stats.branch_commit_count !== null && stats.branch_commit_count !== undefined) {
                    parts.push(stats.branch_commit_count.toLocaleString() + ' commits');
                }
                branchBadge.textContent = parts.join(' \u00b7 ');
                branchBadge.style.display = 'inline';
            } else {
                branchBadge.style.display = 'none';
            }

            // Status
            const statusEl = document.getElementById('indexStatus');
            const statusLabelEl = document.getElementById('statusLabel');
            const status = stats.status || 'indexed';
            if (status === 'indexing') {
                statusEl.textContent = 'Indexing...';
                statusEl.style.color = 'var(--accent-orange)';
                statusLabelEl.textContent = 'In progress';
            } else if (status === 'error') {
                statusEl.textContent = 'Error';
                statusEl.style.color = 'var(--accent-red, #ef4444)';
                statusLabelEl.textContent = 'Indexing failed';
            } else {
                statusEl.textContent = 'Indexed';
                statusEl.style.color = 'var(--accent-green)';
                statusLabelEl.textContent = 'Ready to search';
            }
            updateTabStatus(status);

            // Parse Health
            const parseHealthEl = document.getElementById('parseHealth');
            const parseHealthLabelEl = document.getElementById('parseHealthLabel');
            const parseStats = stats.parse_stats;
            if (parseStats && parseStats.total_files > 0) {
                const pct = parseStats.parse_health_pct;
                parseHealthEl.textContent = pct + '%';
                if (pct >= 95) {
                    parseHealthEl.style.color = 'var(--accent-green)';
                } else if (pct >= 80) {
                    parseHealthEl.style.color = 'var(--accent-orange)';
                } else {
                    parseHealthEl.style.color = 'var(--accent-red)';
                }
                parseHealthLabelEl.textContent = `${parseStats.total_ok}/${parseStats.total_files} files clean`;
            } else {
                parseHealthEl.textContent = '-';
                parseHealthEl.style.color = 'var(--text-muted)';
                parseHealthLabelEl.textContent = 'No parse data';
            }
        }

        function updateWarnings(warnings) {
            const banner = document.getElementById('warningBanner');
            const list = document.getElementById('warningList');

            if (warnings && warnings.length > 0) {
                list.innerHTML = warnings.map(w => `<li>${w}</li>`).join('');
                banner.classList.add('visible');
            } else {
                banner.classList.remove('visible');
            }
        }

        function updateLanguageChart(languages) {
            const ctx = document.getElementById('languageChart');

            // Sort by chunk count and take top 10
            const topLanguages = languages
                .sort((a, b) => b.chunk_count - a.chunk_count)
                .slice(0, 10);

            const labels = topLanguages.map(l => l.language);
            const data = topLanguages.map(l => l.chunk_count);

            // Destroy existing chart
            if (languageChart) {
                languageChart.destroy();
            }

            const isDark = isDarkMode();
            const textColor = isDark ? '#e0e0e0' : '#1a1a1a';
            const gridColor = isDark ? '#404040' : '#e0e0e0';

            languageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Chunks',
                        data: data,
                        backgroundColor: 'rgba(33, 150, 243, 0.7)',
                        borderColor: 'rgba(33, 150, 243, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        x: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                }
            });
        }

        function updateSymbolChart(symbols) {
            const ctx = document.getElementById('symbolChart');

            if (!symbols || Object.keys(symbols).length === 0) {
                // No symbols - show message
                if (symbolChart) {
                    symbolChart.destroy();
                    symbolChart = null;
                }
                ctx.parentElement.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">No symbol data available</p>';
                return;
            }

            const entries = Object.entries(symbols).sort((a, b) => b[1] - a[1]);
            const labels = entries.map(e => e[0]);
            const data = entries.map(e => e[1]);

            // Destroy existing chart
            if (symbolChart) {
                symbolChart.destroy();
            }

            const isDark = isDarkMode();
            const textColor = isDark ? '#e0e0e0' : '#1a1a1a';
            const gridColor = isDark ? '#404040' : '#e0e0e0';

            symbolChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Count',
                        data: data,
                        backgroundColor: 'rgba(76, 175, 80, 0.7)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        x: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                }
            });
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function updateParseHealthTable(parseStats) {
            const section = document.getElementById('parseHealthSection');
            const tbody = document.getElementById('parseTableBody');

            if (!parseStats || !parseStats.by_language || Object.keys(parseStats.by_language).length === 0) {
                section.style.display = 'none';
                return;
            }

            const byLang = parseStats.by_language;
            const entries = Object.entries(byLang).sort((a, b) => b[1].files - a[1].files);

            // Sort: tracked languages first (by file count desc), then skipped languages
            const tracked = entries.filter(([, d]) => !d.skipped).sort((a, b) => b[1].files - a[1].files);
            const skipped = entries.filter(([, d]) => d.skipped).sort((a, b) => b[1].files - a[1].files);
            const sorted = [...tracked, ...skipped];

            let rowId = 0;
            tbody.innerHTML = sorted.map(([lang, data]) => {
                if (data.skipped) {
                    return `<tr style="opacity: 0.5">
                        <td style="font-weight: 500">${escapeHtml(lang)}</td>
                        <td class="num">${data.files}</td>
                        <td class="num" colspan="4" style="text-align: center; font-style: italic">text format â€” indexed as-is, no AST parsing</td>
                    </tr>`;
                }

                const healthPct = data.files > 0 ? (data.ok / data.files * 100) : 100;
                let langColor = 'var(--accent-green)';
                if (healthPct < 80) langColor = 'var(--accent-red)';
                else if (healthPct < 95) langColor = 'var(--accent-orange)';

                const issues = (data.partial || 0) + (data.error || 0) + (data.no_grammar || 0);
                const id = 'lang-detail-' + (rowId++);
                const expandable = issues > 0 ? ` class="expandable-row" onclick="toggleLanguageDetails('${escapeHtml(lang)}', '${id}')"` : '';

                return `<tr${expandable}>
                    <td style="font-weight: 500; color: ${langColor}">${escapeHtml(lang)}</td>
                    <td class="num">${data.files}</td>
                    <td class="num status-ok">${data.ok}</td>
                    <td class="num status-partial">${data.partial || 0}</td>
                    <td class="num status-error">${data.error || 0}</td>
                    <td class="num status-no-grammar">${data.no_grammar || 0}</td>
                </tr>
                <tr class="detail-row" id="${id}"><td colspan="6"><div class="failure-list"></div></td></tr>`;
            }).join('');

            section.style.display = 'block';
        }

        function toggleLanguageDetails(language, rowId) {
            const detailRow = document.getElementById(rowId);
            const parentRow = detailRow.previousElementSibling;
            const isExpanded = detailRow.classList.contains('visible');

            if (isExpanded) {
                detailRow.classList.remove('visible');
                parentRow.classList.remove('expanded');
                return;
            }

            parentRow.classList.add('expanded');
            detailRow.classList.add('visible');

            // Only populate once
            const listEl = detailRow.querySelector('.failure-list');
            if (listEl.innerHTML) return;

            const failures = parseFailuresData.filter(f => f.language === language);
            if (failures.length === 0) {
                listEl.innerHTML = '<p style="color: var(--text-muted); font-size: 13px; padding: 8px 0;">No failure details available</p>';
                return;
            }

            const statusOrder = { error: 0, partial: 1, no_grammar: 2 };
            const sorted = [...failures].sort((a, b) =>
                (statusOrder[a.parse_status] ?? 3) - (statusOrder[b.parse_status] ?? 3)
            );

            const statusClass = (s) => {
                if (s === 'error') return 'status-error';
                if (s === 'partial') return 'status-partial';
                return 'status-no-grammar';
            };

            listEl.innerHTML = `<table>
                <thead><tr>
                    <th>File</th>
                    <th>Status</th>
                    <th>Error</th>
                </tr></thead>
                <tbody>${sorted.map(f => `<tr>
                    <td class="file-path">${escapeHtml(f.file_path)}</td>
                    <td class="${statusClass(f.parse_status)}">${escapeHtml(f.parse_status)}</td>
                    <td class="error-msg" title="${escapeHtml(f.error_message || '')}">${escapeHtml(f.error_message || '-')}</td>
                </tr>`).join('')}</tbody>
            </table>`;
        }

        function updateGrammarChart(grammars) {
            const section = document.getElementById('grammarDistributionSection');
            const ctx = document.getElementById('grammarChart');

            if (!grammars || grammars.length === 0) {
                section.style.display = 'none';
                if (grammarChart) {
                    grammarChart.destroy();
                    grammarChart = null;
                }
                return;
            }

            const labels = grammars.map(g => g.grammar_name);
            const data = grammars.map(g => g.chunk_count);

            if (grammarChart) {
                grammarChart.destroy();
            }

            const isDark = isDarkMode();
            const textColor = isDark ? '#e0e0e0' : '#1a1a1a';
            const gridColor = isDark ? '#404040' : '#e0e0e0';

            grammarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Chunks',
                        data: data,
                        backgroundColor: 'rgba(255, 152, 0, 0.7)',
                        borderColor: 'rgba(255, 152, 0, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });

            section.style.display = 'block';
        }

        function updateGrammarHealthTable(grammars) {
            const section = document.getElementById('grammarHealthSection');
            const tbody = document.getElementById('grammarHealthTableBody');

            if (!grammars || grammars.length === 0) {
                section.style.display = 'none';
                return;
            }

            let rowId = 0;
            tbody.innerHTML = grammars.map(g => {
                const pct = g.recognition_pct;
                let healthColor = 'var(--accent-green)';
                if (pct < 50) healthColor = 'var(--accent-red)';
                else if (pct < 80) healthColor = 'var(--accent-orange)';

                const id = 'grammar-detail-' + (rowId++);
                const expandable = g.unrecognized_chunks > 0 ? ` class="expandable-row" onclick="toggleGrammarDetails('${escapeHtml(g.grammar_name)}', '${id}')"` : '';

                return `<tr${expandable}>
                    <td style="font-weight: 500">${escapeHtml(g.grammar_name)}</td>
                    <td>${escapeHtml(g.base_language)}</td>
                    <td class="num">${g.file_count}</td>
                    <td class="num">${g.chunk_count}</td>
                    <td class="num status-ok">${g.recognized_chunks}</td>
                    <td class="num status-error">${g.unrecognized_chunks}</td>
                    <td class="num" style="color: ${healthColor}; font-weight: 600">${pct}%</td>
                </tr>
                <tr class="detail-row" id="${id}"><td colspan="7"><div class="failure-list"></div></td></tr>`;
            }).join('');

            section.style.display = 'block';
        }

        function toggleGrammarDetails(grammarName, rowId) {
            const detailRow = document.getElementById(rowId);
            const parentRow = detailRow.previousElementSibling;
            const isExpanded = detailRow.classList.contains('visible');

            if (isExpanded) {
                detailRow.classList.remove('visible');
                parentRow.classList.remove('expanded');
                return;
            }

            parentRow.classList.add('expanded');
            detailRow.classList.add('visible');

            // Only populate once
            const listEl = detailRow.querySelector('.failure-list');
            if (listEl.innerHTML) return;

            const failures = grammarFailuresData.filter(f => f.grammar_name === grammarName);
            if (failures.length === 0) {
                listEl.innerHTML = '<p style="color: var(--text-muted); font-size: 13px; padding: 8px 0;">No failure details available</p>';
                return;
            }

            listEl.innerHTML = `<table>
                <thead><tr>
                    <th>File</th>
                    <th>Total Chunks</th>
                    <th>Unrecognized</th>
                </tr></thead>
                <tbody>${failures.map(f => `<tr>
                    <td class="file-path">${escapeHtml(f.file_path)}</td>
                    <td class="num">${f.total_chunks}</td>
                    <td class="num status-error">${f.unrecognized_chunks}</td>
                </tr>`).join('')}</tbody>
            </table>`;
        }

        function updateDashboard(stats) {
            parseFailuresData = stats.parse_failures || [];
            grammarFailuresData = stats.grammar_failures || [];
            updateSummaryCards(stats);
            updateWarnings(stats.warnings);
            updateLanguageChart(stats.languages || []);
            updateSymbolChart(stats.symbols || {});
            updateGrammarChart(stats.grammars || []);
            updateGrammarHealthTable(stats.grammars || []);
            updateParseHealthTable(stats.parse_stats);
            populateLanguageFilter(stats.languages || []);
        }

        async function loadIndexList() {
            try {
                // Load project context and stats in parallel
                const [ctx, data] = await Promise.all([
                    loadProjectContext(),
                    fetchStats(),
                ]);
                projectContext = ctx;
                allIndexes = Array.isArray(data) ? data : [data];

                const select = document.getElementById('indexSelect');
                select.innerHTML = allIndexes.map((idx, i) =>
                    `<option value="${i}">${idx.name}</option>`
                ).join('');

                // Determine which index to select
                let selectedIndex = 0;
                if (projectContext) {
                    if (projectContext.is_indexed) {
                        // Find the project's index in the list and auto-select it
                        const matchIdx = allIndexes.findIndex(
                            idx => idx.name === projectContext.index_name
                        );
                        if (matchIdx >= 0) {
                            selectedIndex = matchIdx;
                            select.value = String(selectedIndex);
                        }
                    } else {
                        // Project not indexed â€” show the banner, hide loading
                        document.getElementById('loadingMessage').style.display = 'none';
                        const banner = document.getElementById('notIndexedBanner');
                        document.getElementById('notIndexedPath').textContent = projectContext.project_path;
                        banner.style.display = 'block';
                    }
                }

                if (allIndexes.length > 0) {
                    await loadDashboard(selectedIndex);

                    // Auto-poll if any index is currently being indexed
                    // (e.g. indexing started from CLI, MCP tool, or another process)
                    const selected = allIndexes[selectedIndex];
                    if (selected && selected.status === 'indexing') {
                        setButtonsDisabled(true);
                        showStatusBanner('Indexing in progress...', 'info');
                        startPolling();
                    }
                }
            } catch (error) {
                showError(`Failed to load index list: ${error.message}`);
            }
        }

        async function loadDashboard(indexIndex) {
            const stats = allIndexes[indexIndex];

            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

            updateDashboard(stats);
        }

        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'none';
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        // Index selector change handler
        document.getElementById('indexSelect').addEventListener('change', (e) => {
            const indexIndex = parseInt(e.target.value);
            loadDashboard(indexIndex);
        });

        let pollInterval = null;

        function setButtonsDisabled(disabled) {
            document.getElementById('reindexBtn').disabled = disabled;
            document.getElementById('freshIndexBtn').disabled = disabled;
            document.getElementById('deleteIndexBtn').disabled = disabled;
            document.getElementById('stopIndexBtn').style.display = disabled ? 'inline-block' : 'none';
        }

        function showStatusBanner(message, type) {
            const banner = document.getElementById('statusBanner');
            banner.textContent = message;
            banner.className = 'status-banner visible ' + type;
        }

        function hideStatusBanner() {
            document.getElementById('statusBanner').className = 'status-banner';
        }

        async function reindex(fresh) {
            if (fresh && !confirm('Fresh Index will delete and rebuild the entire index. Continue?')) {
                return;
            }

            const select = document.getElementById('indexSelect');
            const indexIndex = parseInt(select.value);
            const stats = allIndexes[indexIndex];
            if (!stats) return;

            setButtonsDisabled(true);
            const action = fresh ? 'Fresh reindex' : 'Reindex';
            showStatusBanner(action + ' starting...', 'info');

            try {
                const resp = await fetch('/api/reindex', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        index_name: stats.name,
                        fresh: fresh,
                        source_path: stats.source_path || (projectContext && projectContext.project_path)
                    })
                });
                const data = await resp.json();
                if (!resp.ok) {
                    showStatusBanner('Error: ' + (data.error || 'Request failed'), 'error');
                    setButtonsDisabled(false);
                    return;
                }
                showStatusBanner(data.message, 'info');
                // Immediately reflect indexing status in the UI
                allIndexes[indexIndex].status = 'indexing';
                updateSummaryCards(allIndexes[indexIndex]);
                startPolling();
            } catch (err) {
                showStatusBanner('Error: ' + err.message, 'error');
                setButtonsDisabled(false);
            }
        }

        async function stopIndexing() {
            const select = document.getElementById('indexSelect');
            const stats = allIndexes[parseInt(select.value)];
            if (!stats) return;

            try {
                const resp = await fetch('/api/stop-indexing', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({index_name: stats.name})
                });
                const data = await resp.json();
                if (resp.ok) {
                    stopPolling();
                    setButtonsDisabled(false);
                    showStatusBanner('Indexing stopped', 'info');
                    setTimeout(hideStatusBanner, 5000);
                } else {
                    showStatusBanner('Error: ' + (data.error || 'Stop failed'), 'error');
                }
            } catch (err) {
                showStatusBanner('Error: ' + err.message, 'error');
            }
        }

        async function deleteIndex() {
            const select = document.getElementById('indexSelect');
            const stats = allIndexes[parseInt(select.value)];
            if (!stats) return;

            if (!confirm(`Permanently delete index "${stats.name}"? This cannot be undone.`)) {
                return;
            }

            setButtonsDisabled(true);
            showStatusBanner('Deleting index...', 'info');

            try {
                const resp = await fetch('/api/delete-index', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({index_name: stats.name})
                });
                const data = await resp.json();
                if (!resp.ok) {
                    showStatusBanner('Error: ' + (data.error || 'Delete failed'), 'error');
                    setButtonsDisabled(false);
                    return;
                }
                showStatusBanner(`Index "${stats.name}" deleted`, 'success');
                setTimeout(() => {
                    hideStatusBanner();
                    loadIndexList();
                }, 1500);
            } catch (err) {
                showStatusBanner('Error: ' + err.message, 'error');
                setButtonsDisabled(false);
            }
        }

        async function indexCurrentProject() {
            if (!projectContext) return;

            const btn = document.getElementById('indexNowBtn');
            btn.disabled = true;
            showStatusBanner('Indexing starting...', 'info');

            try {
                const resp = await fetch('/api/index', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        project_path: projectContext.project_path,
                        index_name: projectContext.index_name,
                    })
                });
                const data = await resp.json();
                if (!resp.ok) {
                    showStatusBanner('Error: ' + (data.error || 'Request failed'), 'error');
                    btn.disabled = false;
                    return;
                }
                // Hide the not-indexed banner and loading message
                document.getElementById('notIndexedBanner').style.display = 'none';
                document.getElementById('loadingMessage').style.display = 'none';
                showStatusBanner(data.message, 'info');
                // Show dashboard immediately with indexing-in-progress state
                document.getElementById('dashboardContent').style.display = 'block';
                setButtonsDisabled(true);
                // Immediately reflect indexing status in the Status card
                const statusEl = document.getElementById('indexStatus');
                const statusLabelEl = document.getElementById('statusLabel');
                statusEl.textContent = 'Indexing...';
                statusEl.style.color = 'var(--accent-orange)';
                statusLabelEl.textContent = 'In progress';
                // Poll until indexing completes, then reload index list
                startPolling(true);
            } catch (err) {
                showStatusBanner('Error: ' + err.message, 'error');
                btn.disabled = false;
            }
        }

        function startPolling(reloadListOnComplete = false) {
            stopPolling();
            pollInterval = setInterval(async () => {
                try {
                    const data = await fetchStats();
                    allIndexes = Array.isArray(data) ? data : [data];

                    const select = document.getElementById('indexSelect');

                    // If we're polling after initial indexing, look for the new index
                    if (reloadListOnComplete && projectContext) {
                        const matchIdx = allIndexes.findIndex(
                            idx => idx.name === projectContext.index_name
                        );
                        if (matchIdx >= 0) {
                            // Rebuild dropdown and select the new index
                            select.innerHTML = allIndexes.map((idx, i) =>
                                `<option value="${i}">${idx.name}</option>`
                            ).join('');
                            select.value = String(matchIdx);
                            // Ensure dashboard is visible (may already be from indexCurrentProject)
                            document.getElementById('loadingMessage').style.display = 'none';
                            document.getElementById('dashboardContent').style.display = 'block';
                            updateDashboard(allIndexes[matchIdx]);

                            const status = allIndexes[matchIdx].status || 'indexed';
                            if (status !== 'indexing') {
                                stopPolling();
                                setButtonsDisabled(false);
                                showStatusBanner('Indexing complete', 'success');
                                setTimeout(hideStatusBanner, 5000);
                            }
                            return;
                        }
                    }

                    const indexIndex = parseInt(select.value);
                    if (allIndexes[indexIndex]) {
                        updateDashboard(allIndexes[indexIndex]);

                        const status = allIndexes[indexIndex].status || 'indexed';
                        if (status !== 'indexing') {
                            stopPolling();
                            setButtonsDisabled(false);
                            showStatusBanner('Indexing complete', 'success');
                            setTimeout(hideStatusBanner, 5000);
                        }
                    }
                } catch (err) {
                    // Keep polling on transient errors
                }
            }, 3000);
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // --- Search functionality ---

        document.getElementById('searchInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') executeSearch();
        });

        document.getElementById('searchMinScore').addEventListener('input', (e) => {
            document.getElementById('minScoreValue').textContent = e.target.value;
        });

        function populateLanguageFilter(languages) {
            const select = document.getElementById('searchLanguage');
            const current = select.value;
            const options = ['<option value="">All</option>'];
            if (languages && languages.length > 0) {
                const langs = [...languages].sort((a, b) => b.chunk_count - a.chunk_count);
                for (const l of langs) {
                    options.push(`<option value="${escapeHtml(l.language)}">${escapeHtml(l.language)}</option>`);
                }
            }
            select.innerHTML = options.join('');
            // Preserve previous selection
            if (current) {
                select.value = current;
            }
        }

        async function executeSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            const select = document.getElementById('indexSelect');
            const indexIndex = parseInt(select.value);
            const stats = allIndexes[indexIndex];
            if (!stats) return;

            const language = document.getElementById('searchLanguage').value || undefined;
            const symbolType = document.getElementById('searchSymbolType').value || undefined;
            const minScore = parseFloat(document.getElementById('searchMinScore').value);
            const limit = parseInt(document.getElementById('searchLimit').value) || 10;
            const hybridVal = document.getElementById('searchHybrid').value;
            const useHybrid = hybridVal === 'on' ? true : hybridVal === 'off' ? false : undefined;

            // Show loading
            document.getElementById('searchLoading').style.display = 'block';
            document.getElementById('searchEmpty').style.display = 'none';
            document.getElementById('searchError').style.display = 'none';
            document.getElementById('searchResultsInfo').style.display = 'none';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchBtn').disabled = true;

            try {
                const body = {
                    query: query,
                    index_name: stats.name,
                    limit: limit,
                    min_score: minScore,
                };
                if (language) body.language = language;
                if (symbolType) body.symbol_type = symbolType;
                if (useHybrid !== undefined) body.use_hybrid = useHybrid;

                const resp = await fetch('/api/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                const data = await resp.json();

                document.getElementById('searchLoading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;

                if (!resp.ok) {
                    document.getElementById('searchError').textContent = data.error || 'Search failed';
                    document.getElementById('searchError').style.display = 'block';
                    document.getElementById('clearSearchBtn').style.display = '';
                    return;
                }

                displaySearchResults(data);
                document.getElementById('clearSearchBtn').style.display = '';
            } catch (err) {
                document.getElementById('searchLoading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('searchError').textContent = 'Search failed: ' + err.message;
                document.getElementById('searchError').style.display = 'block';
                document.getElementById('clearSearchBtn').style.display = '';
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchResultsInfo').style.display = 'none';
            document.getElementById('searchEmpty').style.display = 'none';
            document.getElementById('searchError').style.display = 'none';
            document.getElementById('searchLoading').style.display = 'none';
            document.getElementById('clearSearchBtn').style.display = 'none';
        }

        function displaySearchResults(data) {
            const results = data.results || [];
            const container = document.getElementById('searchResults');
            const infoEl = document.getElementById('searchResultsInfo');
            const emptyEl = document.getElementById('searchEmpty');

            if (results.length === 0) {
                emptyEl.textContent = 'No results found. Try a different query or broader filters.';
                emptyEl.style.display = 'block';
                return;
            }

            infoEl.textContent = `${data.total} result${data.total !== 1 ? 's' : ''} in ${data.query_time_ms}ms`;
            infoEl.style.display = 'block';

            container.innerHTML = results.map((r, i) => {
                const scoreClass = r.score >= 0.7 ? 'badge-score-high' : r.score >= 0.4 ? 'badge-score-mid' : 'badge-score-low';
                const matchBadge = r.match_type ? `<span class="search-result-badge badge-match">${escapeHtml(r.match_type)}</span>` : '';
                const langBadge = r.language_id ? `<span class="search-result-badge badge-lang">${escapeHtml(r.language_id)}</span>` : '';
                const lineRange = r.start_line && r.end_line ? `Lines ${r.start_line}-${r.end_line}` : '';
                const escapedPath = escapeHtml(r.file_path).replace(/'/g, "\\'");

                let symbolHtml = '';
                if (r.symbol_type || r.symbol_name) {
                    const parts = [];
                    if (r.symbol_type) parts.push(`[${escapeHtml(r.symbol_type)}]`);
                    if (r.symbol_name) parts.push(escapeHtml(r.symbol_name));
                    symbolHtml = `<div class="search-result-symbol">${parts.join(' ')}</div>`;
                }

                const lines = (r.content || '').split('\n');
                const previewLines = lines.slice(0, 8);
                const hasMore = lines.length > 8;
                const previewText = escapeHtml(previewLines.join('\n'));
                const fullText = escapeHtml(r.content || '');

                return `<div class="search-result-card">
                    <div class="search-result-header">
                        <span class="search-result-path clickable" onclick="copyPathWithFeedback(this, '${escapedPath}')" title="Click to copy path">${escapeHtml(r.file_path)}</span>
                        <div class="search-result-meta">
                            <span style="font-size: 12px; color: var(--text-muted);">${escapeHtml(lineRange)}</span>
                            <span class="search-result-badge ${scoreClass}">${r.score.toFixed(2)}</span>
                            ${matchBadge}
                            ${langBadge}
                        </div>
                    </div>
                    ${symbolHtml}
                    <div class="search-result-code">
                        <pre id="code-preview-${i}">${previewText}</pre>
                        ${hasMore ? `<button class="expand-btn" onclick="toggleCodeExpand(${i}, this)" data-full="${fullText.replace(/"/g, '&quot;')}" data-preview="${previewText.replace(/"/g, '&quot;')}">Show all ${lines.length} lines</button>` : ''}
                    </div>
                    <div class="search-result-actions">
                        <button onclick="copyToClipboard('${escapedPath}')">Copy Path</button>
                        <button onclick="copyToClipboard(document.getElementById('code-preview-${i}').textContent)">Copy Code</button>
                        <button onclick="openInEditor('${escapedPath}', ${r.start_line || 1})">Open</button>
                        <button onclick="viewFile('${escapedPath}', ${r.start_line || 1}, ${r.end_line || r.start_line || 1})">View File</button>
                    </div>
                </div>`;
            }).join('');
        }

        function toggleCodeExpand(index, btn) {
            const pre = document.getElementById('code-preview-' + index);
            const isExpanded = btn.dataset.expanded === 'true';
            if (isExpanded) {
                pre.textContent = btn.dataset.preview;
                btn.textContent = 'Show all lines';
                btn.dataset.expanded = 'false';
            } else {
                pre.textContent = btn.dataset.full;
                btn.textContent = 'Show less';
                btn.dataset.expanded = 'true';
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).catch(() => {
                // Fallback for older browsers
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
            });
        }

        // --- Clickable path with visual feedback ---
        function copyPathWithFeedback(el, path) {
            copyToClipboard(path);
            // Flash green + show toast
            el.classList.add('copied');
            showToast('Copied!', 1500, 'success');
            setTimeout(() => el.classList.remove('copied'), 1200);
        }

        // --- Toast notification ---
        let toastTimer = null;
        function showToast(message, duration = 3000, type = 'error') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)';
            toast.classList.add('visible');
            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => toast.classList.remove('visible'), duration);
        }

        // --- Resolve relative file paths to absolute ---
        function resolveFilePath(filePath) {
            if (filePath.startsWith('/')) return filePath;
            // Get source path from current index stats or project context
            const select = document.getElementById('indexSelect');
            const idx = parseInt(select.value);
            const stats = allIndexes[idx];
            const basePath = (stats && stats.source_path)
                || (projectContext && projectContext.project_path)
                || '';
            if (basePath) {
                return basePath.replace(/\/$/, '') + '/' + filePath;
            }
            return filePath;
        }

        // --- Open in Editor ---
        async function openInEditor(filePath, line) {
            filePath = resolveFilePath(filePath);
            try {
                const resp = await fetch('/api/open-in-editor', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ file_path: filePath, line: line })
                });
                const data = await resp.json();
                if (!resp.ok) {
                    showToast(data.error || 'Failed to open editor');
                }
            } catch (err) {
                showToast('Failed to open editor: ' + err.message);
            }
        }

        // --- View File Modal ---
        async function viewFile(filePath, startLine, endLine) {
            filePath = resolveFilePath(filePath);
            const backdrop = document.getElementById('fileModalBackdrop');
            const pathEl = document.getElementById('fileModalPath');
            const linesEl = document.getElementById('fileModalLines');
            const codeEl = document.getElementById('fileModalCode');
            const bodyEl = document.getElementById('fileModalBody');

            // Show modal with loading state
            pathEl.textContent = filePath;
            linesEl.textContent = '';
            codeEl.textContent = 'Loading...';
            codeEl.className = '';
            backdrop.classList.add('visible');

            try {
                const resp = await fetch('/api/file-content?path=' + encodeURIComponent(filePath));
                const data = await resp.json();
                if (!resp.ok) {
                    codeEl.textContent = 'Error: ' + (data.error || 'Failed to load file');
                    return;
                }

                linesEl.textContent = data.lines + ' lines' + (data.truncated ? ' (truncated)' : '');
                const langClass = data.language && data.language !== 'plain' ? 'language-' + data.language : '';
                codeEl.className = langClass;
                codeEl.textContent = data.content;

                // Re-run Prism highlighting
                if (typeof Prism !== 'undefined') {
                    Prism.highlightElement(codeEl);
                }

                // Scroll to matched line range and highlight
                if (startLine && startLine > 0) {
                    setTimeout(() => {
                        highlightAndScrollToLine(bodyEl, startLine, endLine);
                    }, 100);
                }
            } catch (err) {
                codeEl.textContent = 'Error: ' + err.message;
            }
        }

        function highlightAndScrollToLine(container, startLine, endLine) {
            // Find line number elements from Prism line-numbers plugin
            const lineRows = container.querySelectorAll('.line-numbers-rows > span');
            if (lineRows.length > 0 && startLine <= lineRows.length) {
                // Highlight the range by adding background
                const start = Math.max(0, startLine - 1);
                const end = Math.min(lineRows.length - 1, (endLine || startLine) - 1);
                for (let i = start; i <= end; i++) {
                    lineRows[i].style.background = 'rgba(255, 200, 50, 0.15)';
                }
                // Scroll the start line into view
                lineRows[start].scrollIntoView({ block: 'center', behavior: 'smooth' });
            } else {
                // Fallback: estimate line height and scroll
                const pre = container.querySelector('pre');
                if (pre) {
                    const lineHeight = parseFloat(getComputedStyle(pre).lineHeight) || 20;
                    container.scrollTop = (startLine - 1) * lineHeight - container.clientHeight / 3;
                }
            }
        }

        function closeFileModal() {
            document.getElementById('fileModalBackdrop').classList.remove('visible');
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeFileModal();
        });

        // --- Server heartbeat (auto-close on disconnect) ---
        let isUnloading = false;
        window.addEventListener('beforeunload', () => { isUnloading = true; });

        function startHeartbeat() {
            const es = new EventSource('/api/heartbeat');
            let retries = 0;
            const maxRetries = 3;

            es.onerror = () => {
                es.close();
                if (isUnloading) return;
                if (retries < maxRetries) {
                    retries++;
                    setTimeout(startHeartbeat, 1000 * retries);
                    return;
                }
                updateTabStatus(null);
                document.getElementById('disconnectOverlay').style.display = 'flex';
                window.close();
            };

            es.onopen = () => { retries = 0; };
        }
        startHeartbeat();

        // Initialize dashboard
        loadIndexList();

        // ---- Search Mode Toggle + AI Chat ----
        let chatSessionId = null;
        let chatAvailable = false;
        let chatSending = false;

        function renderMarkdown(text) {
            try {
                const html = marked.parse(text, { breaks: true, gfm: true });
                return DOMPurify.sanitize(html);
            } catch {
                return DOMPurify.sanitize(text);
            }
        }

        function switchSearchMode(mode) {
            if (mode === 'chat' && !chatAvailable) return;

            const searchContent = document.getElementById('searchModeContent');
            const chatContent = document.getElementById('chatModeContent');
            const searchBtn = document.getElementById('modeSearchBtn');
            const chatBtn = document.getElementById('modeAskAIBtn');

            if (mode === 'search') {
                searchContent.style.display = '';
                chatContent.style.display = 'none';
                searchBtn.classList.add('active');
                chatBtn.classList.remove('active');
            } else {
                searchContent.style.display = 'none';
                chatContent.style.display = '';
                searchBtn.classList.remove('active');
                chatBtn.classList.add('active');

                // Auto-create session on first switch to chat
                if (!chatSessionId) {
                    const sel = document.getElementById('indexSelect');
                    if (sel && sel.value) {
                        const indexName = allIndexes[parseInt(sel.value)]?.name || sel.value;
                        fetch('/api/project').then(r => r.json()).then(proj => {
                            createChatSession(indexName, proj.project_path || '.');
                        }).catch(() => createChatSession(indexName, '.'));
                    } else {
                        addChatMessage('error', 'No index selected. Select an index above first.');
                    }
                }
                // Focus the input
                document.getElementById('chatInput').focus();
            }
        }

        async function initChatPanel() {
            const chatBtn = document.getElementById('modeAskAIBtn');
            try {
                const res = await fetch('/api/ai-chat/status');
                const data = await res.json();
                chatAvailable = data.available === true;
                if (chatAvailable) {
                    chatBtn.disabled = false;
                    chatBtn.title = 'Ask AI about your codebase';
                } else {
                    chatBtn.disabled = true;
                    chatBtn.title = data.reason || 'Requires cocosearch[web-chat] and claude CLI';
                }
            } catch {
                chatBtn.disabled = true;
                chatBtn.title = 'AI chat unavailable â€” server error';
            }
        }

        async function createChatSession(indexName, projectPath) {
            const sendBtn = document.getElementById('chatSend');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Connecting...';
            try {
                const res = await fetch('/api/ai-chat/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({index_name: indexName, project_path: projectPath})
                });
                const data = await res.json();
                if (res.ok && data.session_id) {
                    chatSessionId = data.session_id;
                    addChatMessage('assistant', 'Session started. Ask me anything about your codebase.');
                } else {
                    addChatMessage('error', data.error || 'Failed to start session');
                }
            } catch (e) {
                addChatMessage('error', 'Failed to connect: ' + e.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
        }

        function sendChatMessage() {
            if (chatSending) return;
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            if (!chatSessionId) {
                addChatMessage('error', 'Chat session not started. Check that an index is selected.');
                return;
            }

            input.value = '';
            input.style.height = 'auto';
            addChatMessage('user', text);
            chatSending = true;
            document.getElementById('chatSend').disabled = true;
            document.getElementById('chatTyping').classList.add('active');

            const params = new URLSearchParams({session_id: chatSessionId, message: text});
            const es = new EventSource('/api/ai-chat/stream?' + params);
            let assistantEl = null;
            let fullText = '';
            let renderScheduled = false;
            // Track tool uses to attach input later
            const pendingTools = {};

            es.onmessage = (event) => {
                let item;
                try { item = JSON.parse(event.data); } catch { return; }

                if (item.type === 'token') {
                    if (!assistantEl) {
                        assistantEl = addChatMessage('assistant', '');
                    }
                    fullText += item.text;
                    if (!renderScheduled) {
                        renderScheduled = true;
                        requestAnimationFrame(() => {
                            assistantEl.innerHTML = renderMarkdown(fullText);
                            scrollChatToBottom();
                            renderScheduled = false;
                        });
                    }
                } else if (item.type === 'tool_start') {
                    const toolEl = addToolUseElement(item.name);
                    if (item.tool_id) pendingTools[item.tool_id] = toolEl;
                    // Reset assistantEl so next text goes into a new message bubble
                    assistantEl = null;
                    fullText = '';
                } else if (item.type === 'tool_input') {
                    // Find the pending tool element by tool_id or fallback to name match
                    let toolEl = item.tool_id ? pendingTools[item.tool_id] : null;
                    if (!toolEl) {
                        // Fallback: find by tool name in summary text
                        toolEl = Object.values(pendingTools).find(
                            el => el.querySelector('summary')?.textContent === item.name
                        ) || null;
                    }
                    if (toolEl) {
                        const inputDiv = toolEl.querySelector('.tool-input');
                        if (inputDiv) {
                            inputDiv.textContent = JSON.stringify(item.input, null, 2);
                        }
                    }
                } else if (item.type === 'stats') {
                    updateChatStats(item);
                } else if (item.type === 'done') {
                    // Final Prism highlight pass on the last assistant message
                    if (assistantEl) {
                        Prism.highlightAllUnder(assistantEl);
                    }
                    es.close();
                    finishChatSend();
                } else if (item.type === 'error') {
                    es.close();
                    addChatMessage('error', item.error || 'Unknown error');
                    finishChatSend();
                }
            };

            es.onerror = () => {
                es.close();
                if (!fullText) addChatMessage('error', 'Connection lost');
                finishChatSend();
            };
        }

        function finishChatSend() {
            chatSending = false;
            document.getElementById('chatSend').disabled = false;
            document.getElementById('chatTyping').classList.remove('active');
            scrollChatToBottom();
        }

        function addChatMessage(role, text) {
            const area = document.getElementById('chatMessages');
            const el = document.createElement('div');
            el.className = 'chat-msg ' + role;
            if (role === 'assistant' && text) {
                el.innerHTML = renderMarkdown(text);
                // Defer Prism highlighting
                requestAnimationFrame(() => Prism.highlightAllUnder(el));
            } else {
                el.textContent = text;
            }
            area.appendChild(el);
            scrollChatToBottom();
            return el;
        }

        function addToolUseElement(toolName) {
            const area = document.getElementById('chatMessages');
            const details = document.createElement('details');
            details.className = 'chat-tool-use';
            const summary = document.createElement('summary');
            summary.textContent = toolName;
            details.appendChild(summary);
            const inputDiv = document.createElement('div');
            inputDiv.className = 'tool-input';
            inputDiv.textContent = '...';
            details.appendChild(inputDiv);
            area.appendChild(details);
            scrollChatToBottom();
            return details;
        }

        function updateChatStats(stats) {
            const bar = document.getElementById('chatStatsBar');
            const parts = [];

            if (stats.num_turns != null && stats.max_turns) {
                parts.push('Turns: ' + stats.num_turns + '/' + stats.max_turns);
            }

            if (stats.usage) {
                const input = stats.usage.input_tokens || stats.usage.input || 0;
                const output = stats.usage.output_tokens || stats.usage.output || 0;
                const total = input + output;
                const display = total >= 1000 ? (total / 1000).toFixed(1) + 'k' : total;
                parts.push('Tokens: ' + display);
            }

            if (stats.cost_usd != null && typeof stats.cost_usd === 'number') {
                parts.push('$' + stats.cost_usd.toFixed(4));
            }

            bar.innerHTML = parts.join(' &middot; ');
            bar.classList.add('visible');
        }

        function scrollChatToBottom() {
            const area = document.getElementById('chatMessages');
            area.scrollTop = area.scrollHeight;
        }

        async function startNewChatSession() {
            if (chatSessionId) {
                try {
                    await fetch('/api/ai-chat/session', {
                        method: 'DELETE',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({session_id: chatSessionId})
                    });
                } catch { /* best effort */ }
                chatSessionId = null;
            }
            document.getElementById('chatMessages').innerHTML = '';
            // Reset stats
            const statsBar = document.getElementById('chatStatsBar');
            statsBar.innerHTML = '';
            statsBar.classList.remove('visible');

            const sel = document.getElementById('indexSelect');
            if (sel && sel.value) {
                const indexName = allIndexes[parseInt(sel.value)]?.name || sel.value;
                fetch('/api/project').then(r => r.json()).then(proj => {
                    createChatSession(indexName, proj.project_path || '.');
                }).catch(() => createChatSession(indexName, '.'));
            } else {
                addChatMessage('error', 'No index selected. Select an index above first.');
            }
        }

        function handleChatKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // Auto-resize chat textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        initChatPanel();
    </script>

    <!-- File Viewer Modal -->
    <div id="fileModalBackdrop" class="file-modal-backdrop" onclick="if(event.target===this)closeFileModal()">
        <div class="file-modal">
            <div class="file-modal-header">
                <div class="file-info">
                    <span id="fileModalPath"></span>
                    <span id="fileModalLines" class="line-count"></span>
                </div>
                <button class="file-modal-close" onclick="closeFileModal()" title="Close (Esc)">&times;</button>
            </div>
            <div class="file-modal-body" id="fileModalBody">
                <pre class="line-numbers"><code id="fileModalCode"></code></pre>
            </div>
        </div>
    </div>

    <!-- Toast for error messages -->
    <div id="toast" class="toast"></div>

    <div id="disconnectOverlay" style="display:none; position:fixed; inset:0;
         background:rgba(0,0,0,0.85); z-index:9999; align-items:center;
         justify-content:center; flex-direction:column;">
        <p style="color:white; font-size:24px; font-weight:600;">Server Disconnected</p>
        <p style="color:#aaa; font-size:14px; margin-top:8px;">
            The CocoSearch server has stopped. You can close this tab.
        </p>
    </div>
</body>
</html>
